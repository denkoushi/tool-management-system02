# ラズパイ端末のセキュリティ対策プラン

この文書は、工具管理システム（Flask + NFC）とドキュメントビューワ（DocumentViewer）を運用するラズパイ端末に対し、情シス担当者に納得してもらえる水準の安全対策を整理したものです。想定されるリスクを切り口に、対策の意図と実装イメージを有機的につなげて記載します。

## 1. 基本方針

- **攻撃面の縮小**: 外部からの侵入経路（ネットワーク/USB）を絞り、侵入自体を生じにくくする。
- **多層防御**: 侵入に成功しても被害が拡大しないよう、アプリ/API レベル・OS レベル・ネットワークレベルで対策を重ねる。
- **可視化と復旧力**: ログ・監視・バックアップを整備し、異常検知と復旧を迅速に行えるようにする。

## 2. 想定リスクと対策

### 2.1 USB メモリ経由のマルウェア混入
- **リスク**: 感染した USB を挿すことで悪意あるファイルやスクリプトが混入し、ラズパイを起点に他機器へ感染が広がる。
- **対策パッケージ**:
  1. **ホワイトリスト取り込み**: 同期スクリプトで拡張子・MIME タイプを検証し、想定外ファイルは拒否。取り込むのは `master/*.csv` と `docviewer/*.pdf` に限定。
      - 現在は `master/` 配下の CSV と `meta.json` を防御範囲として実装済み。`docviewer/` や USB ルート配下は次期タスクとして検討し、DocumentViewer 側スクリプトでも同様の検証を導入する。
      - 運用では警告ログに記録されたファイル名を基に USB を確認し、不要ファイルを削除して再同期するフローを RUNBOOK に明記。
  2. **ウイルススキャン**: `clamscan` を USB マウント時に自動実行し、検知時は同期を直ちに中止。ログには検体名を記録し、RUNBOOK で定義したオフライン定義更新と隔離手順に従って対応する。
  3. **ポリシー明文化**: USB は専用メモリのみ使用し、定期的に初期化・チェック。運用手順書に記載し、責任者が貸出/返却を管理する。

### 2.2 ラズパイ踏み台化（侵入→横展開）
- **リスク**: SSH や Web サービスの脆弱性を突かれ内部侵入。感染後に LAN 内の他システムへ攻撃が横展開。
- **対策パッケージ**:
  1. **OS レベルの遮蔽**: `ufw` で不要ポートを閉じ、SSH は鍵認証＋限定 IP からのみ許可。`fail2ban` 等で連続ログインをブロック。
  2. **アプリ権限の最小化**: Flask/DocumentViewer を専用ユーザー（`tools01`）で起動し、sudo 権限は `NOPASSWD` で必要コマンドのみに限定。
  3. **ネットワーク分離**: 工場ライン用 VLAN と事務 LAN を分け、ラズパイから社内主要サーバへの通信を遮断。HTTP アクセスも必要先に限定。
  4. **定期アップデート**: `apt upgrade`, `pip-audit` を定期実施し、脆弱性パッチを適用。RUNBOOK に更新手順と承認フローを明記。

### 2.3 他システムへの汚染拡大
- **リスク**: ラズパイ感染後、USB やネットワーク経由で他システムへマルウェアが広がる。
- **対策パッケージ**:
  1. **ログ集中・監視**: USB 同期や API 操作を syslog に集約。異常検知時はメール/Slack で通知し、初期対応を迅速化。
  2. **バックアップと復旧手順**: イメージバックアップ（SD コピー）＋ DB/設定ファイルの定期バックアップ。障害時の復旧手順を RUNBOOK にまとめておく。
  3. **物理・運用ルール**: USB の貸出簿やアクセス権限管理を徹底し、無断接続や不明メモリの使用を禁止。

### 2.4 認証されていない操作
- **リスク**: 誰でもブラウザから USB 同期やシャットダウンを実行できる。
- **対策パッケージ**:
  1. **操作 API 保護**: USB 同期／メンテ API にトークン認証やロールベース制御を導入。管理者のみ実行可能にする。
  2. **アクセスログ**: 操作ユーザー・時間・結果を DB/ログに記録し、監査に対応できるようにする。

### 2.5 アプリケーション脆弱性
- **リスク**: 脆弱なライブラリや CSRF 等が残り、Web 経由で攻撃される。
- **対策パッケージ**:
  1. `pip-audit`, `bandit` などで定期的にライブラリとコードをチェック。
  2. 入力値のサニタイズや CSRF トークン導入など、フロント／バックエンドでの検証強化。
  3. CI に静的解析を組み込み、コード変更時に自動検査。

## 3. 運用ポリシー／次のアクション

1. **USB 運用ポリシー策定**
   - USB メモリは社内で番号管理し、貸出時にフォーマット・ウイルスチェックを実施。
   - マニュアル（RUNBOOK）では、取り込み前に USB 中身を確認し、想定外ファイルがあれば担当者に連絡することを明記。

2. **ネットワーク＋OS 設定の標準化**
   - sshd_config、ufw ルール、fail2ban の設定テンプレートを作成し、展開手順とセットで保管。
   - VLAN／静的 IP／DNS の設定と、アクセス元の MAC アドレス登録などを情シスと調整。

3. **ログ監視・バックアップの整備**
   - `journalctl` のログローテーションと syslog 転送を設定し、定期バックアップスクリプトを `systemd timer` で実行。
   - 障害時の復旧フロー（SD イメージからのリストア、アプリ設定反映）をドキュメント化。

4. **段階的導入計画**
   1. USB 同期スクリプトとウイルススキャンの実装／テスト。
   2. Firewall/SSH の強化＋操作 API のトークン化。
   3. ログ集中・通知・バックアップ体制の構築。
   4. CI による依存パッケージ・コードの継続的監査。

これらを順に実施し、各ステップ完了ごとに情シスとレビューできるよう、進捗と結果をドキュメント化していくことを推奨します。

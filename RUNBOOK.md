# Tool Management System (Raspberry Pi 5) â€” RUNBOOK

æœ¬æ›¸ã¯ã€Raspberry Pi 5 ä¸Šã§é‹ç”¨ã™ã‚‹ **å·¥å…·æŒã¡å‡ºã—ãƒ»è¿”å´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ** ã®ã€Œã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã€ã€Œé‹ç”¨æ‰‹é †ã€ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ãƒªã‚¹ãƒˆã‚¢ã€ã€Œãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ã‚’ã¾ã¨ã‚ãŸé‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚  
æœ¬ãƒªãƒã‚¸ãƒˆãƒªã¯ã€éå»ã«å®‰å®šç¨¼åƒã—ã¦ã„ãŸ ZIP ç‰ˆã‚’ãƒ™ãƒ¼ã‚¹ã«å†æ§‹æˆã—ãŸ **å¾©æ—§ç”¨ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³**ã§ã™ã€‚

---

## ç›®çš„ã¨è¨­è¨ˆæ–¹é‡ï¼ˆWhat & Whyï¼‰

- å˜ç´”ãƒ»å†ç¾æ€§é‡è¦–ï¼š`app_flask.py` å˜ä½“ã§ **Flask + Socket.IO** ã‚’èµ·å‹•ã€‚NFCï¼ˆPC/SCï¼‰ã‚¹ã‚­ãƒ£ãƒ³ â†’ DB è¨˜éŒ² â†’ ç”»é¢æ›´æ–°ã‚’ 1 æœ¬åŒ–ã€‚
- ä¾å­˜ã¯æœ€å°é™ï¼š`Flask / Flask-SocketIO / psycopg2-binary / pyscard`ã€‚
- DB ã¯ Docker ã§ Postgres ã‚’èµ·å‹•ï¼ˆ**healthcheck** ã¨ **restart ãƒãƒªã‚·ãƒ¼**ã§è‡ªå‹•å¾©å¸°ï¼‰ã€‚Grafana ã¯ä»»æ„ã€‚
- é‹ç”¨ã§è½ã¡ãªã„å·¥å¤«ï¼š
  - ã‚¢ãƒ—ãƒªå´ï¼š**DB æ¥ç¶šã® 30 ç§’ãƒªãƒˆãƒ©ã‚¤**ï¼ˆDB èµ·å‹•å¾…ã¡ã§è½ã¡ãªã„ï¼‰
  - Docker å´ï¼š**restart: unless-stopped** ã¨ **pg_isready healthcheck**
  - systemdï¼š**UTF-8 ãƒ­ã‚°**ãƒ»**pcscd / docker å¾…ã¡åˆã‚ã›**ãƒ»**è‡ªå‹•èµ·å‹•**
- ãƒ‡ãƒ¼ã‚¿ä¿å…¨ï¼š**æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä¿æŒ 14 æ—¥ï¼‰**ï¼‹**ãƒªã‚¹ãƒˆã‚¢æ¤œè¨¼æ‰‹é †**ã‚’å¸¸å‚™ã€‚
- å¯è¦³æ¸¬æ€§ï¼šjournalï¼ˆsystemdï¼‰ï¼‹ï¼ˆä»»æ„ï¼‰Grafanaã€‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆæœŸå€¤ï¼šPostgres ã¨ Grafana ã¯ **127.0.0.1 ãƒã‚¤ãƒ³ãƒ‰**ï¼ˆLAN ã¸ç„¡ç”¨ã«éœ²å‡ºã—ãªã„ï¼‰ã€‚

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆæœ€å°ï¼‰

    .
    â”œâ”€ app_flask.py               # æœ¬ä½“ï¼ˆFlask + Socket.IO + NFC ç›£è¦– + API + DB I/Oï¼‰
    â”œâ”€ templates/
    â”‚   â””â”€ index.html             # ç”»é¢ï¼ˆå€Ÿç”¨/è¿”å´ãƒ»ã‚¿ã‚°ç™»éŒ²ãƒ»å·¥å…·åãƒã‚¹ã‚¿ï¼‰
    â”œâ”€ static/
    â”‚   â””â”€ js/
    â”‚       â””â”€ socket.io.js       # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSDKï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
    â”œâ”€ docker-compose.yml         # Postgres + Grafanaï¼ˆlocalhostãƒã‚¤ãƒ³ãƒ‰ã€restart, healthcheckï¼‰
    â”œâ”€ setup_auto_start.sh        # systemd è‡ªå‹•èµ·å‹•ï¼ˆUTF-8 ãƒ­ã‚°ã€pcscd/docker å¾…ã¡åˆã‚ã›ï¼‰
    â”œâ”€ scripts/
    â”‚   â”œâ”€ backup_db.sh           # pg_dump â†’ gzipã€ä¿æŒ14æ—¥
    â”‚   â””â”€ install_backup_timer.sh# systemd timer (æ¯æ—¥ 02:30 JST)
    â”œâ”€ backups/                   # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›å…ˆï¼ˆ.gitignoreï¼‰
    â”œâ”€ requirements.txt
    â”œâ”€ .gitignore
    â”œâ”€ README.md                  # ç°¡æ˜“ç‰ˆï¼ˆå½“é¢ã®èµ·å‹•æ‰‹é †ï¼‰
    â””â”€ RUNBOOK.md                 # æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

---

## 0. å‰æ

- OS: Raspberry Pi OS (64bit, Bookworm æƒ³å®š)
- NFCãƒªãƒ¼ãƒ€ãƒ¼: PC/SC å¯¾å¿œï¼ˆ`pcscd` çµŒç”±ï¼‰
- ãƒãƒ¼ãƒˆ:
  - ã‚¢ãƒ—ãƒª: `:8501`ï¼ˆ0.0.0.0ï¼‰
  - Postgres: `127.0.0.1:5432`ï¼ˆDocker ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚¤ãƒ³ãƒ‰ï¼‰
  - Grafana: `127.0.0.1:3000`ï¼ˆä»»æ„ï¼‰

---

## 1. åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã¾ã£ã•ã‚‰ãªç’°å¢ƒï¼‰

1) APT ã¨ PC/SC

    sudo apt update && sudo apt upgrade -y
    sudo apt install -y git curl python3-venv python3-dev build-essential swig pkg-config
    sudo apt install -y pcscd pcsc-tools libpcsclite1 libpcsclite-dev libccid
    sudo systemctl enable --now pcscd
    # èªè­˜ãƒ†ã‚¹ãƒˆï¼ˆè¡¨ç¤ºã‚’ç¢ºèªã—ãŸã‚‰ Ctrl+Cï¼‰
    pcsc_scan

2) Docker / Composeï¼ˆå…¬å¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰

    cd ~
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
    # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆâ†’å†ãƒ­ã‚°ã‚¤ãƒ³ã€ã¾ãŸã¯ newgrp docker ã§åæ˜ 
    newgrp docker  # åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç¶šã‘ã‚‹å ´åˆ
    docker --version
    docker compose version

3) ãƒªãƒã‚¸ãƒˆãƒªå–å¾—ã¨ Python ä»®æƒ³ç’°å¢ƒ

    git clone https://github.com/denkoushi/tool-management-system02.git
    cd tool-management-system02
    python3 -m venv venv
    source venv/bin/activate
    pip install -U pip setuptools wheel
    pip install -r requirements.txt

4) Postgres / Grafana èµ·å‹•

    docker compose pull
    docker compose up -d
    docker compose ps
    docker inspect -f '{{.State.Health.Status}}' pg

5) psql ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

    sudo apt install -y postgresql-client

6) å‰é¢èµ·å‹•ãƒ†ã‚¹ãƒˆï¼ˆã¾ãšã¯æ‰‹å‹•ï¼‰

    source venv/bin/activate
    python app_flask.py
    curl -I http://localhost:8501 | head -n 1

    - Pi ä¸Šã§ Chromium ãªã©ã‚’èµ·å‹•ã— `http://127.0.0.1:8501` ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã° OKã€‚LAN å´ã® IPï¼ˆä¾‹: `http://192.168.x.x:8501`ï¼‰ã§ã‚‚ UI ã¯è¡¨ç¤ºã•ã‚Œã‚‹ãŒã€å®‰å…¨ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ã¯ localhost ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ã¿è¨±å¯ã•ã‚Œã‚‹ç‚¹ã«æ³¨æ„ã€‚

---

## 2. è‡ªå‹•èµ·å‹•ï¼ˆsystemdï¼‰ã¨ UTF-8 ãƒ­ã‚°

- ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼š

    cd ~/tool-management-system02
    sudo bash setup_auto_start.sh
    systemctl --no-pager --full status toolmgmt.service
    # ãƒ­ã‚°è¿½å°¾ï¼ˆæ—¥æœ¬èª/çµµæ–‡å­—ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
    journalctl -u toolmgmt.service -f -n 100

- ä»•çµ„ã¿ï¼ˆè¦ç‚¹ï¼‰  
  - `After=network-online.target pcscd.service docker.service`ï¼šèµ·å‹•é †ã®å®‰å®šåŒ–  
  - `LANG/LC_ALL/PYTHONIOENCODING/TZ`ï¼š**UTF-8 ãƒ­ã‚°/æ—¥æœ¬æ™‚é–“**  
  - `ExecStart=.../venv/bin/python app_flask.py`ï¼šä»®æƒ³ç’°å¢ƒã‹ã‚‰èµ·å‹•

---

## 3. ç”»é¢æ“ä½œï¼ˆåŸºæœ¬é‹ç”¨ï¼‰

1) ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://<Piã®IP>:8501` ã‚’é–‹ãï¼ˆPi æœ¬ä½“ãªã‚‰ `http://localhost:8501`ï¼‰ã€‚  
2) ã‚¿ãƒ–æ§‹æˆï¼š
   - **å·¥å…·åãƒã‚¹ã‚¿**ï¼šå·¥å…·åã¨ã‚³ãƒ¼ãƒ‰ã‚’ç™»éŒ²
   - **ã‚¿ã‚°ç™»éŒ²**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã‚¿ã‚°ã€å·¥å…·ç”¨ã‚¿ã‚°ã®ç´ã¥ã‘
   - **å€Ÿç”¨/è¿”å´**ï¼šå·¦åŠåˆ†ã®æ“ä½œã‚¨ãƒªã‚¢ã§å€Ÿç”¨/è¿”å´ã‚’å®Ÿæ–½ã€‚**ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ å·¥å…·** ã®é †ã§ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨è²¸å‡ºã€åŒã˜é †åºã§å†ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨è¿”å´ã€‚
3) è£œåŠ©æ“ä½œï¼š
   - **æ‰‹å‹•è¿”å´**ãƒœã‚¿ãƒ³ï¼ˆè²¸å‡ºä¸­ãƒªã‚¹ãƒˆå†…ï¼‰â€¦ ã‚¹ã‚­ãƒ£ãƒ³ã§ããªã„å ´åˆã§ã‚‚è¿”å´æ¸ˆã¿ã«ã§ãã€å±¥æ­´ã¸ç§»å‹•ã—ã¾ã™ã€‚
   - **å‰Šé™¤**ãƒœã‚¿ãƒ³ï¼ˆè²¸å‡ºä¸­ãƒªã‚¹ãƒˆå†…ï¼‰â€¦ èª¤ç™»éŒ²ç­‰ã§è²¸å‡ºè¨˜éŒ²ã‚’ç ´æ£„ã™ã‚‹ç”¨é€”ã€‚è²¸å‡ºãƒªã‚¹ãƒˆã®ã¿ã‹ã‚‰å‰Šé™¤ã•ã‚Œã€ã‚¿ã‚°IDã¨ã‚¢ã‚¤ãƒ†ãƒ åã®ç´ã¥ã‘ã¯ç¶­æŒã•ã‚Œã¾ã™ã€‚

> ç”»é¢ã¯å·¦åŠåˆ†ã®ã¿ã‚’æ“ä½œé ˜åŸŸã¨ã—ã¦ä½¿ç”¨ã—ã€å³åŠåˆ†ã¯ä»Šå¾Œã®æ‹¡å¼µç”¨ã«ç©ºã‘ã¦ã„ã¾ã™ã€‚

> æ³¨æ„ï¼šä¸¦è¡Œã§ `pcsc_scan` ã‚’èµ·å‹•ã—ãªã„ï¼ˆPC/SC ã‚’å æœ‰ã—ã¦ç«¶åˆã—ã¾ã™ï¼‰

---

### 3.1 ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿åŒæœŸï¼ˆUSBï¼‰

1. **USB ã®æº–å‚™**
   - ext4 ãªã©ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€å¿…ãšãƒ©ãƒ™ãƒ«ã‚’ **`TOOLMASTER`** ã«è¨­å®šï¼ˆä¾‹: `sudo e2label /dev/sdX1 TOOLMASTER`ï¼‰ã€‚
   - ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã« `master/`ï¼ˆCSV ç”¨ï¼‰ã¨ `docviewer/`ï¼ˆPDF ç”¨ï¼‰ã‚’ä½œæˆã—ã€åˆå›ã¯ç©ºã§ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼ˆPi å´ãŒè‡ªå‹•ç”Ÿæˆã—ã¾ã™ï¼‰ã€‚
2. **Pi ã§ã®åˆæœŸè¨­å®š**
   - `sudo bash scripts/install_usb_master_sync.sh` ã‚’å®Ÿè¡Œã—ã€`/usr/local/bin/tool_master_sync.sh` ã¨ `tool-master-sync@.service` / udev ãƒ«ãƒ¼ãƒ«ã‚’é…ç½®ã€‚
   - è¨­å®šã¯ 1 åº¦ã ã‘ã§ OKã€‚ä»¥å¾Œã¯ USB ã‚’æŒ¿ã™ã ã‘ã§åŒæœŸãŒèµ°ã‚Šã¾ã™ã€‚
3. **åŒæœŸã®æµã‚Œ**
   - USB ã‚’æŒ¿å…¥ â†’ `/media/tool-master/` ã«è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆ â†’ `master/*.csv` ã‚’å–ã‚Šè¾¼ã¿ï¼ˆUSB ã®æ›´æ–°ãŒæ–°ã—ã‘ã‚Œã° Pi ã‚’ä¸Šæ›¸ãï¼‰ã€‚
   - å–ã‚Šè¾¼ã¿å¯¾è±¡ã® CSV/JSON ã¯æ‹¡å¼µå­ã¨ MIME ã‚¿ã‚¤ãƒ—ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæ¤œè¨¼ã—ã€è¨±å¯å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„å½¢å¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯åŒæœŸã‚’ä¸­æ–­ã— `/var/log/toolmgmt/usbsync.log` ã«è¨˜éŒ²ã€‚
   - å–ã‚Šè¾¼ã¿å¾Œã€Pi å´ã®æœ€æ–°ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ USB ã«æ›¸ãæˆ»ã—ã€`meta.json` ã«æ›´æ–°æ™‚åˆ»ã‚’è¨˜éŒ²ã€‚
   - ç¶šã‘ã¦ `../DocumentViewer/scripts/usb-import.sh` ã‚’å‘¼ã³å‡ºã—ã€`docviewer/*.pdf` ã‚’å–ã‚Šè¾¼ã¿ï¼ˆUSB å´ãŒæ–°ã—ã„å ´åˆï¼‰ã€‚å®Œäº†å¾Œã«è‡ªå‹•ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã€‚`docviewer.service` ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ãŒå‰æã€‚
   - ãƒ­ã‚°ã¯ `journalctl -u tool-master-sync@*`ï¼ˆç›´è¿‘ãªã‚‰ `journalctl -u tool-master-sync@$(ls /dev/disk/by-label/TOOLMASTER)` ç­‰ï¼‰ãŠã‚ˆã³ `/var/log/toolmgmt/usbsync.log`ã€DocumentViewer å´ã¯ `/var/log/document-viewer/import.log` ã‚’å‚ç…§ã€‚
   - **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘ŠãŒå‡ºãŸã¨ãã®ç¢ºèªæ‰‹é †**
     1. ç”»é¢ã‚„ãƒ­ã‚°ã« `USB ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ã«å¤±æ•—` / `unexpected file 'xxx'` ãŒå‡ºãŸã‚‰ USB ã‚’æŠœã‹ãšã«ç½®ãã€‚
     2. `tail -n 20 /var/log/toolmgmt/usbsync.log` ã§å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¢ºèªã€‚DocumentViewer å´ã®è­¦å‘Šã¯ `tail -n 20 /var/log/document-viewer/import.log` ã§ç¢ºèªã€‚
     3. åˆ¥ PC ã§ USB ã‚’é–‹ãã€ãƒ­ã‚°ã«è¼‰ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã¾ãŸã¯æ­£ã—ã„å½¢å¼ã«ä¿®æ­£ï¼ˆä¾‹: `.csv`/.`pdf` ä»¥å¤–ã‚’å‰Šé™¤ï¼‰ã€‚
     4. USB ã‚’å®‰å…¨ã«å–ã‚Šå¤–ã—ã€ãƒ©ã‚ºãƒ‘ã‚¤ã¸å†æ¥ç¶šã—ãŸä¸Šã§å†åº¦åŒæœŸã‚’å®Ÿè¡Œã€‚
     5. æ­£å¸¸ã«å®Œäº†ã—ãŸã‹ã‚’ãƒ­ã‚°ã§å†ç¢ºèªã€‚ç–‘ã‚ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŸå› ã§ã‚ã‚Œã°ã€USB ã‚’åˆæœŸåŒ–ã—ã¦æ­£è¦ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚³ãƒ”ãƒ¼ã—ç›´ã™ã€‚
   - **ã‚¦ã‚¤ãƒ«ã‚¹æ¤œçŸ¥æ™‚ã®å¯¾å¿œï¼ˆexit=3ï¼‰**
     1. ãƒ­ã‚°ã« `ClamAV ãŒè„…å¨ã‚’æ¤œçŸ¥` ãŒå‡ºãŸå ´åˆã¯ã€ãã® USB ã‚’éš”é›¢ã—æ¥­å‹™ã§ä½¿ç”¨ã—ãªã„ã€‚
     2. å®‰å…¨ãª PC ã§ USB å†…ã®æ„ŸæŸ“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€USB å…¨ä½“ã‚’å†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‚
     3. å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ€æ–°åŒ–ã—ãŸåˆ¥ USB ã§å†ã‚¹ã‚­ãƒ£ãƒ³ã—ã€è„…å¨ãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å†é…å¸ƒã™ã‚‹ã€‚
     4. å¿…è¦ã§ã‚ã‚Œã°æƒ…ã‚·ã‚¹ã¸å ±å‘Šã—ã€ä»–ç«¯æœ«ã¸ã®å½±éŸ¿ãŒç„¡ã„ã‹ç¢ºèªã™ã‚‹ã€‚
   - **ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å¿œï¼ˆexit=4ï¼‰**
     1. ãƒ­ã‚°ã« `ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ã®ãŸã‚æ‰‹å‹•ç¢ºèªãŒå¿…è¦ã§ã™` ãŒå‡ºãŸå ´åˆã€`clamscan` å®Ÿè¡Œç’°å¢ƒã‚’ç¢ºèªã€‚
     2. `which clamscan` ã§ã‚³ãƒãƒ³ãƒ‰æœ‰ç„¡ã€`clamscan --version` ã§å‹•ä½œç¢ºèªã€‚
     3. å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å¾Œè¿°ã®æ›´æ–°æ‰‹é †ã§ `main.cvd` ãªã©ã‚’å…¥ã‚Œç›´ã™ã€‚
     4. è§£æ±ºå¾Œã« USB ã‚’å†ã‚¹ã‚­ãƒ£ãƒ³ã—ã€æ­£å¸¸çµ‚äº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚
   - UI ã‹ã‚‰åŒæœŸã™ã‚‹å ´åˆã¯ã€ŒğŸ›  ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€ã‚¿ãƒ–å†…ã®ã€ŒUSB åŒæœŸã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’åˆ©ç”¨ã€‚å†…éƒ¨çš„ã«ä¸Šè¨˜ 2 ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç›´åˆ—ã§å®Ÿè¡Œã—ã€çµæœã¯ç”»é¢ã®ãƒ­ã‚°ã«æ•´å½¢ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
   - sudoers ã«ä¸‹è¨˜ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨é‹ç”¨ãŒæ¥½ã«ãªã‚Šã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ã¯ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ï¼‰ã€‚

        sudo tee /etc/sudoers.d/toolmgmt-usbsync >/dev/null <<'SUDO'
        tools01 ALL=(root) NOPASSWD: /bin/bash /home/tools01/tool-management-system02/scripts/usb_master_sync.sh
        tools01 ALL=(root) NOPASSWD: /bin/bash /home/tools01/DocumentViewer/scripts/usb-import.sh
        SUDO
        sudo visudo -cf /etc/sudoers.d/toolmgmt-usbsync
4. **CSV ã‚’äººæ‰‹ã§ç·¨é›†ã™ã‚‹å ´åˆ**
   - `master/tool_master.csv`ï¼ˆå·¥å…·åãƒã‚¹ã‚¿ï¼š1åˆ—ã€é‡è¤‡ä¸å¯ï¼‰
   - `master/users.csv`ï¼ˆ2åˆ—ï¼š`uid`,`full_name`ï¼‰
   - `master/tools.csv`ï¼ˆ2åˆ—ï¼š`uid`,`name`ã€‚`name` ã¯ `tool_master.csv` ã«å­˜åœ¨ã™ã‚‹å€¤ï¼‰
   - ã„ãšã‚Œã‚‚ UTF-8ãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã§ä¿å­˜å¾Œã€USB ã‚’ Pi ã«æŒ¿ã™ã¨å–ã‚Šè¾¼ã¿ â†’ æœ€æ–° CSV ã«æ›¸ãæˆ»ã—ã€‚
   - ç·¨é›†å¾Œã¯ PC ã§å®‰å…¨ãªå–ã‚Šå¤–ã—ã‚’è¡Œã£ã¦ã‹ã‚‰ Pi ã«æ¥ç¶šï¼ˆæ›¸ãè¾¼ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´æã‚’é˜²ãï¼‰ã€‚
   - DocumentViewer ã«è¿½åŠ ã™ã‚‹ PDF ã¯ `docviewer/` é…ä¸‹ã¸ã‚³ãƒ”ãƒ¼ã—ã€å¿…è¦ã«å¿œã˜ã¦ `meta.json` ã® `updated_at` ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ï¼ˆæœªè¨­å®šã®å ´åˆã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè‡ªå‹•ã§è£œå®Œã—ã¾ã™ï¼‰ã€‚
5. **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**
   - å–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ CSV ã®åˆ—é †ã‚„ãƒ˜ãƒƒãƒ€ãƒ¼ã€å‚ç…§æ•´åˆæ€§ï¼ˆ`tools.csv` ã® `name` ãŒ `tool_master.csv` ã«å­˜åœ¨ã™ã‚‹ã‹ï¼‰ã‚’ç¢ºèªã€‚
   - `meta.json` ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç®¡ç†ã™ã‚‹ã®ã§æ‰‹å‹•ã§ç·¨é›†ã—ãªã„ã“ã¨ã€‚

> ã™ã¹ã¦ã®å‡¦ç†ãŒãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§å®Œäº†ã™ã‚‹ãŸã‚ã€USB ã‚’æŠœãå·®ã—ã™ã‚‹ã ã‘ã§ä»–æ‹ ç‚¹ã¸ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’é…å¸ƒã§ãã¾ã™ã€‚å±¥æ­´ï¼ˆè²¸å‡ºãƒ­ã‚°ï¼‰ã¯å«ã¾ã‚Œãªã„ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

#### ClamAV å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ›´æ–°æ‰‹é †

1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã§ãã‚‹ PC ã§ [ClamAV Signature Database](https://www.clamav.net/downloads) ã‹ã‚‰ `main.cvd`, `daily.cvd`, `bytecode.cvd` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚
2. USB ãƒ¡ãƒ¢ãƒªãªã©ã§ `/var/lib/clamav/` ã«ã‚³ãƒ”ãƒ¼ã€‚ä¾‹ï¼š

    ```bash
    sudo cp /media/USB/main.cvd /var/lib/clamav/
    sudo cp /media/USB/daily.cvd /var/lib/clamav/
    sudo cp /media/USB/bytecode.cvd /var/lib/clamav/
    sudo chown clamav:clamav /var/lib/clamav/*.cvd
    ```

3. æ—¢å­˜ã®å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹å ´åˆã¯ `sudo rm /var/lib/clamav/*.cvd` ã§å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã€‚
4. åæ˜ å¾Œã« `sudo systemctl restart clamav-freshclam.service 2>/dev/null || true` ã‚’å®Ÿè¡Œã—ã€`clamscan --version` ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèªã€‚
5. USB ã‚’å†ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦æ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

### 3.2 ã‚­ã‚ªã‚¹ã‚¯é‹ç”¨ï¼ˆä»»æ„ï¼‰

- `sudo bash setup_auto_start.sh` ã§ Flask ã‚¢ãƒ—ãƒªã‚’ systemd ã‚µãƒ¼ãƒ“ã‚¹åŒ–ã€‚
- `bash scripts/install_kiosk_autostart.sh` ã‚’é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã—ã€`~/.config/autostart/chromium-kiosk.desktop` ã‚’ç”Ÿæˆã€‚
- `sudo raspi-config` â†’ System Options â†’ Boot / Auto Login â†’ Desktop Autologin ã‚’é¸æŠã€‚
- å†èµ·å‹•ã™ã‚‹ã¨ GUI ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã« Chromium ãŒ `http://127.0.0.1:8501` ã‚’å…¨ç”»é¢è¡¨ç¤ºã—ã¾ã™ã€‚åœæ­¢ã—ãŸã„å ´åˆã¯ `~/.config/autostart/chromium-kiosk.desktop` ã‚’å‰Šé™¤ã—ã€å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚

### 3.3 OS ãƒ¬ãƒ™ãƒ«é˜²å¾¡ï¼ˆFirewall / SSHï¼‰

1. **äº‹å‰èª¿æŸ»**
   - ç¾åœ¨ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æŠŠæ¡ï¼š`ip -4 addr show` ã‚„ `hostname -I` ã§ç®¡ç†ç«¯æœ«ã® IP ã‚’ç¢ºèªã€‚
   - ç®¡ç†ç«¯æœ«ã‹ã‚‰ã®æ¥ç¶šãƒ†ã‚¹ãƒˆï¼š`ssh tools01@<ãƒ©ã‚ºãƒ‘ã‚¤IP>` ãŒéµèªè¨¼ã§æˆåŠŸã™ã‚‹ã“ã¨ã€‚

2. **UFW ã®è¨­å®š**
   - ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åˆ©ç”¨ï¼š

        cd ~/tool-management-system02
        sudo ./scripts/configure_ufw.sh <è¨±å¯ã—ãŸã„CIDR> [è¿½åŠ CIDR...] --no-enable

     - ä¾‹ï¼š`sudo ./scripts/configure_ufw.sh 192.168.10.0/24 --no-enable`
     - ç¾å ´ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªå¾Œã€`sudo ufw enable` ã‚’å®Ÿè¡Œã—ã¦æœ‰åŠ¹åŒ–ã€‚
     - åˆ¥ç«¯æœ«ã‹ã‚‰ã®ç–é€šç¢ºèªå¾Œã€`sudo ufw status numbered` ã‚’è¨˜éŒ²ã€‚

3. **SSH è¨­å®šå¼·åŒ–**
   - `/etc/ssh/sshd_config` ã«ä»¥ä¸‹ã‚’æ˜ç¤ºçš„ã«è¿½åŠ ï¼ˆæ—¢å­˜è¡ŒãŒã‚ã‚Œã°ä¸Šæ›¸ãï¼‰ï¼š

        PermitRootLogin no
        PasswordAuthentication no
        PubkeyAuthentication yes
        AllowUsers tools01

   - ç·¨é›†å¾Œã«æ§‹æ–‡ç¢ºèªï¼š`sudo sshd -t`
   - åæ˜ ï¼š`sudo systemctl restart ssh`
   - åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§éµèªè¨¼ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‹ç¢ºèªã€‚

4. **fail2ban**ï¼ˆãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–ï¼‰
   - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š`sudo apt install fail2ban`
   - `/etc/fail2ban/jail.local` ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã‚’è¿½è¨˜ï¼š

        [sshd]
        enabled = true
        maxretry = 5
        bantime = 600

   - æœ‰åŠ¹åŒ–ï¼š`sudo systemctl enable --now fail2ban`
   - çŠ¶æ…‹ç¢ºèªï¼š`sudo fail2ban-client status sshd`

5. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †**
   - UFW ã‚’ä¸€æ™‚åœæ­¢ï¼š`sudo ufw disable`
   - SSH ã‚’å…ƒã«æˆ»ã™å ´åˆã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãŠã„ãŸ `sshd_config` ã‚’å¾©æ—§ã—ã¦ã‹ã‚‰ `sudo systemctl restart ssh`
   - fail2ban ã‚’åœæ­¢ï¼š`sudo systemctl disable --now fail2ban`

> **æ³¨æ„**: UFW ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å‰ã«å¿…ãšç¾åœ°ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œã‚’è¡Œã„ã€æƒ³å®šå¤–ã®é®æ–­ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### 3.4 ç®¡ç† API ã®èªè¨¼ã¨ç›£æŸ»ãƒ­ã‚°

1. **API ãƒˆãƒ¼ã‚¯ãƒ³ã®è¨­å®š**
   - æ—¢å®šã§ã¯ `/etc/toolmgmt/api_token.json` ã« `{ "token": "...", "station_id": "CUTTING-01", "issued_at": "..." }` å½¢å¼ã§ä¿å­˜ã™ã‚‹ã€‚
   - ç¢ºèªï¼š`python scripts/manage_api_token.py show`ï¼ˆ`--reveal` ã§å…¨è¡¨ç¤ºï¼‰
   - ç™ºè¡Œï¼š`python scripts/manage_api_token.py issue --station-id CUTTING-01`
   - å†ç™ºè¡Œï¼š`python scripts/manage_api_token.py rotate --station-id CUTTING-01`
   - ç„¡åŠ¹åŒ–ï¼š`python scripts/manage_api_token.py revoke --token <å€¤>` ã¾ãŸã¯ `--station-id`, `--all`, `--file`
   - `/etc/toolmgmt` ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ `sudo mkdir -p /etc/toolmgmt && sudo chown tools01:tools01 /etc/toolmgmt && sudo chmod 755 /etc/toolmgmt`
   - æ—§æ¥ã©ãŠã‚Šç’°å¢ƒå¤‰æ•° `API_AUTH_TOKEN` ã‚’è¨­å®šã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹ã€‚
   - ã‚­ã‚ªã‚¹ã‚¯ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ `localStorage` ã«ä¿å­˜ã™ã‚‹ãŸã‚ã€æ¯æœå†å…¥åŠ›ã™ã‚‹å¿…è¦ã¯ãªã„ã€‚ç«¯æœ«å…¥ã‚Œæ›¿ãˆæ™‚ã‚„æ¼æ´©æ‡¸å¿µãŒã‚ã‚‹å ´åˆã¯ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ã§å‰Šé™¤ã—ã€å†ç™ºè¡Œãƒ»å†å…¥åŠ›ã™ã‚‹ã€‚
   - **è¨­ç½®ã®ç›®çš„**:
     1. **æ­£å½“ãªç«¯æœ«ã®è­˜åˆ¥** â€¦ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿æŒã™ã‚‹ç«¯æœ«ã ã‘ãŒ API ã‚’å©ã‘ã‚‹ãŸã‚ã€åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã«ä¸å¯©ãªç«¯æœ«ãŒã‚ã£ã¦ã‚‚æ“ä½œã§ããªã„ã€‚
     2. **ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å˜ä½ã®ç›£æŸ»** â€¦ station_id ã¨ã²ã‚‚ä»˜ã„ã¦ãƒ­ã‚°ã«æ®‹ã‚‹ã®ã§ã€ã©ã®å·¥ç¨‹ã®ç«¯æœ«ãŒæ“ä½œã—ãŸã‹è¿½è·¡ã§ãã‚‹ã€‚
     3. **å®¹æ˜“ãªç„¡åŠ¹åŒ–** â€¦ ç«¯æœ«ã®å…¥ã‚Œæ›¿ãˆãƒ»ç´›å¤±æ™‚ã¯ `revoke` + å†ç™ºè¡Œã§å³åº§ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ­¢ã‚ã‚‰ã‚Œã‚‹ã€‚

     > **é‹ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸**: ç‰©ç†çš„ã«ç®¡ç†ã•ã‚ŒãŸã‚­ã‚ªã‚¹ã‚¯ç«¯æœ«ã§éµã‚’å·®ã—ãŸã¾ã¾ä½¿ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ `localStorage` ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚æ¯æœã®å…¥åŠ›ã¯ä¸è¦ã§ã™ãŒã€éµã‚’æŠœããŸã„ã¨ãï¼ˆç«¯æœ«ç§»è¨­ãƒ»æ¼æ´©ç–‘ã„ï¼‰ã¯ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ã€â†’ å†ç™ºè¡Œã™ã‚‹ã ã‘ã§ãƒªã‚»ãƒƒãƒˆã§ãã¾ã™ã€‚

2. **ãƒ˜ãƒƒãƒ€ä»•æ§˜**
   - æ—¢å®šã§ã¯ `X-API-Token` ãƒ˜ãƒƒãƒ€ã‚’ä½¿ç”¨ã€‚å¿…è¦ãªã‚‰ `API_TOKEN_HEADER` ã§åç§°ã‚’å¤‰æ›´å¯èƒ½ã€‚
   - `API_AUTH_TOKEN` ãŒæœªè¨­å®šã®å ´åˆã¯å¾“æ¥ã©ãŠã‚Šãƒˆãƒ¼ã‚¯ãƒ³ç„¡ã—ã§åˆ©ç”¨ã§ãã‚‹ï¼ˆé–‹ç™ºç”¨é€”ï¼‰ã€‚

3. **ç›£æŸ»ãƒ­ã‚°**
   - ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼š`logs/api_actions.log`ï¼ˆ`API_AUDIT_LOG` ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰ã€‚
   - è¨˜éŒ²å†…å®¹ï¼šaction / statusï¼ˆsuccess,error,deniedï¼‰/ remote_addr / è©³ç´°ã€‚
   - ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¨å¥¨ï¼š`logrotate` ã‚’è¿½åŠ ã—ã€90 æ—¥ç¨‹åº¦ã‚’ç›®å®‰ã«ä¿ç®¡ã€‚

4. **å¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
   - USB åŒæœŸã€è²¸å‡ºç®¡ç†ï¼ˆæ‰‹å‹•è¿”å´ãƒ»å‰Šé™¤ï¼‰ã€æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼å·¥å…·ç™»éŒ²ã€ãƒã‚¹ã‚¿ç·¨é›†ã€çŠ¶æ…‹åˆ¶å¾¡ï¼ˆstart/stop/resetï¼‰ã€å®‰å…¨ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã€‚
   - GET ã®å‚ç…§ç³»ï¼ˆä¾‹ï¼š`/api/loans`ï¼‰ã¯ç¾çŠ¶ãƒˆãƒ¼ã‚¯ãƒ³ç„¡ã—ã§é–²è¦§å¯ã€‚å¿…è¦ã«å¿œã˜ã¦ `require_api_token` ã‚’è¿½åŠ ã™ã‚‹ã€‚

5. **é‹ç”¨ãƒ¡ãƒ¢**
   - ãƒ­ã‚°ã« 401 ãŒé€£ç¶šã™ã‚‹å ´åˆã¯ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³å…¥åŠ›ãƒŸã‚¹ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€`fail2ban` ã®çµæœã¨ä½µã›ã¦ç¢ºèªã™ã‚‹ã€‚
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ç™ºè¡Œã—ãŸå ´åˆã¯ã€ç™ºè¡Œã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨è€…ã«å‘¨çŸ¥ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã® `sessionStorage` ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†å…¥åŠ›ã‚’ä¿ƒã™ã€‚

### 3.5 ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆtoolmgmt/document-viewerï¼‰

1. åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼š

        cd ~/tool-management-system02
        ./scripts/install_logrotate_toolmgmt.sh

   - `/etc/logrotate.d/toolmgmt` ãŒä½œæˆã•ã‚Œã€`usbsync.log` / `api_actions.log` / `import.log` ãŒ 14 æ—¥ä¿æŒã§åœ§ç¸®ã•ã‚Œã‚‹ã€‚
2. åæ˜ ç¢ºèªï¼š`sudo logrotate --debug /etc/logrotate.d/toolmgmt | head -n 20`
3. ãƒ«ãƒ¼ãƒ«è¿½åŠ å¾Œã¯ `sudo systemctl status cron`ï¼ˆã¾ãŸã¯ `anacron`ï¼‰ã‚’ç¢ºèªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® logrotate ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
4. ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ­ã‚°ã¯ `/var/log/toolmgmt/*.log.*.gz` ã¸ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ä¿ç®¡ãƒãƒªã‚·ãƒ¼ã«å¾“ã£ã¦å¤–éƒ¨åª’ä½“ã¸ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚

### 3.6 ç”Ÿç”£è¨ˆç”»ï¼æ¨™æº–å·¥æ•°ã®åŒæœŸï¼ˆUSBï¼‰

USB ãƒ¡ãƒ¢ãƒªçµŒç”±ã§ç”Ÿç”£è¨ˆç”»ã¨æ¨™æº–å·¥æ•°ã® CSV ã‚’é…å¸ƒã—ã€å·¦ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

1. **USB å†…ã®é…ç½®å ´æ‰€ï¼ˆ`master/` ç›´ä¸‹ï¼‰**

        production_plan.csv      # ç”Ÿç”£è¨ˆç”»ï¼šç´æœŸ,å€‹æ•°,éƒ¨å“ç•ªå·,éƒ¨å“å,è£½ç•ª,å·¥ç¨‹å
        standard_times.csv       # æ¨™æº–å·¥æ•°ï¼šéƒ¨å“å,æ©Ÿæ¢°æ¨™æº–å·¥æ•°,è£½é€ ã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·,éƒ¨å“ç•ªå·,å·¥ç¨‹å

   - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ `docs/sample-data/` ã‚’å‚ç…§ã€‚
   - æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ UTF-8ï¼ˆBOM å¯ï¼‰ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯ä¸Šè¨˜ã¨åŒä¸€ã§ã‚ã‚‹ã“ã¨ã€‚

2. **å–ã‚Šè¾¼ã¿å…ˆ**
   - USB åŒæœŸ (`scripts/usb_master_sync.sh`) å®Ÿè¡Œæ™‚ã« `/var/lib/toolmgmt/plan/` ã¸ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã€‚
   - ãƒ•ã‚¡ã‚¤ãƒ«æ‰€æœ‰è€…ã¯ `tools01:tools01`ã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ 640ã€‚

3. **æ¤œè¨¼å†…å®¹**
   - æ‹¡å¼µå­ã¨ MIME ã‚’ç¢ºèªã—ã€æƒ³å®šå¤–å½¢å¼ã¯ WARN ã¨ã—ã¦ãƒ­ã‚°ã«æ®‹ã—ã‚¹ã‚­ãƒƒãƒ—ã€‚
   - ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸€è‡´ã—ãªã„å ´åˆã¯ `usbsync.log` ã« WARN ã‚’å‡ºã—ã‚³ãƒ”ãƒ¼ã—ãªã„ã€‚

4. **è¡¨ç¤º**
   - Flask UI å·¦ä¸Šãƒšã‚¤ãƒ³ã«ã€Œç”Ÿç”£è¨ˆç”»ã€ã¨ã€Œæ¨™æº–å·¥æ•°ã€ã® 2 ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä¸¦ã³ã€USB ã‹ã‚‰å–ã‚Šè¾¼ã‚“ã æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥ã€…ã«ç¢ºèªã§ãã‚‹ã€‚
   - ç”Ÿç”£è¨ˆç”»ã¯ç´æœŸé †ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã€æ¨™æº–å·¥æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã¯éƒ¨å“ç•ªå·ï¼‹å·¥ç¨‹åã§æ˜‡é †è¡¨ç¤ºã€‚
   - å°†æ¥çªåˆã®ãŸã‚ã€ä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«ã¯éƒ¨å“ç•ªå·ã¨å·¥ç¨‹åã®å…±é€šæƒ…å ±ã§å‚ç…§å¯èƒ½ã€‚

5. **ã‚ˆãã‚ã‚‹ã‚±ãƒ¼ã‚¹**
   - CSV ãŒç½®ã‹ã‚Œã¦ã„ãªã„ï¼šUI ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã ã‘ã§ã‚¨ãƒ©ãƒ¼ã«ã¯ãªã‚‰ãªã„ã€‚
   - å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼š`/var/log/toolmgmt/usbsync.log` ã‚’ç¢ºèªã—ã€CSV ã‚’ä¿®æ­£ã—ã¦å†åŒæœŸã€‚

---

### 3.7 å·¥ç¨‹è¨­å®šï¼ˆstation.jsonï¼‰

1. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
   - æ—¢å®šãƒ‘ã‚¹: `/var/lib/toolmgmt/station.json`ï¼ˆ`STATION_CONFIG_PATH` ã§å¤‰æ›´å¯ï¼‰
   - ä¾‹:

        {
          "process": "åˆ‡å‰Š",
          "available": ["åˆ‡å‰Š", "ç ”ç£¨"],
          "updated_at": "2025-10-05T12:34:56"
        }

   - ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç’°å¢ƒå¤‰æ•° `STATION_PROCESS` ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ¡ç”¨ã—ã€UI ä¸Šã§ã¯ã€Œæœªè¨­å®šã€è¡¨ç¤ºã«ãªã‚‹ã€‚

2. **UI æ“ä½œæ‰‹é †ï¼ˆæ¨å¥¨ï¼‰**
   - ç”»é¢ã€ŒğŸ›  ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€ã‚¿ãƒ– â†’ ã€Œå·¥ç¨‹è¨­å®šã€ã§å€™è£œè¿½åŠ ãƒ»å‰Šé™¤ã¨ç¾åœ¨ã®å·¥ç¨‹ã®ä¿å­˜ãŒå¯èƒ½ã€‚
   - ä¿å­˜æˆåŠŸæ™‚ã¯ station.json ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã€DocumentViewer ã®è¡¨ç¤ºã¨ç”Ÿç”£è¨ˆç”»ãƒã‚¤ãƒ©ã‚¤ãƒˆã«åæ˜ ã•ã‚Œã‚‹ã€‚

3. **CLI æ“ä½œæ‰‹é †**

        python scripts/manage_station_config.py show
        python scripts/manage_station_config.py add åˆ‡å‰Š
        python scripts/manage_station_config.py set --process åˆ‡å‰Š --available åˆ‡å‰Š,ç ”ç£¨

   - `remove` ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã§å€™è£œã‹ã‚‰é™¤å¤–ã§ãã‚‹ï¼ˆç¾åœ¨ã®å·¥ç¨‹ã‚’å‰Šé™¤ã—ãŸå ´åˆã¯ã€Œæœªè¨­å®šã€ã¸æˆ»ã‚‹ï¼‰ã€‚

4. **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆ**
   - station.json ãŒç ´æã—ã¦ã„ã‚‹å ´åˆ: CLI ã§ `set` ã‚’å®Ÿè¡Œã™ã‚‹ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã¨å†ç”Ÿæˆã•ã‚Œã‚‹ã€‚
   - UI ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãŒå‡ºã‚‹å ´åˆ: æ›¸ãè¾¼ã¿æ¨©é™ã€ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã€API ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã€‚
   - åˆå›ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆ:  
        sudo mkdir -p /var/lib/toolmgmt  
        sudo chown tools01:tools01 /var/lib/toolmgmt  
        sudo chmod 755 /var/lib/toolmgmt

---

### 3.8 ãƒªãƒ¢ãƒ¼ãƒˆé…å¸ƒï¼ˆä»»æ„ï¼‰

- ç’°å¢ƒå¤‰æ•° `PLAN_REMOTE_BASE_URL` ã‚’è¨­å®šã™ã‚‹ã¨ã€`/var/lib/toolmgmt/plan/` ã‚’è‡ªå‹•æ›´æ–°ã™ã‚‹ã€‚ä¾‹: `https://example.com/toolmgmt/plan` é…ä¸‹ã« `production_plan.csv`, `standard_times.csv` ã‚’é…ç½®ã€‚
- 600 ç§’ã”ã¨ï¼ˆ`PLAN_REMOTE_REFRESH_SECONDS`ï¼‰ã«æ›´æ–°ã‚’ç¢ºèªã€‚`PLAN_REMOTE_TOKEN` ã‚’è¨­å®šã™ã‚‹ã¨ Bearer ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦é€ä¿¡ã™ã‚‹ã€‚
- `file://` ã‚¹ã‚­ãƒ¼ãƒ ã‚‚åˆ©ç”¨å¯èƒ½ï¼ˆä¾‹: `PLAN_REMOTE_BASE_URL=file:///mnt/share`ï¼‰ã€‚
- å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ­ã‚°ã« `[plan-cache]` ãŒå‡ºåŠ›ã•ã‚Œã€ãƒ­ãƒ¼ã‚«ãƒ«ã®å‰å›ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä½¿ã†ã€‚

---

### 3.9 ãƒ†ã‚¹ãƒˆï¼ˆpytestï¼‰

- å˜ä½“ãƒ†ã‚¹ãƒˆ / ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ: `make test`ï¼ˆå†…éƒ¨ã§ `python -m pytest` ã‚’å®Ÿè¡Œï¼‰
- **å®Ÿè¡Œæ‰‹é †**ï¼ˆä»®æƒ³ç’°å¢ƒä¸Šã§å®Ÿæ–½ï¼‰

        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt -r requirements-dev.txt
        pytest -q

- ãƒªãƒ¢ãƒ¼ãƒˆé…å¸ƒã‚’æ¨¡æ“¬ã™ã‚‹å ´åˆ: `PLAN_REMOTE_BASE_URL=file:///path/to/sample make test`
- CI å°å…¥æ™‚ã¯ `make test-smoke` ã‚’ã‚¸ãƒ§ãƒ–ã«ç™»éŒ²ã—ã€å°†æ¥çš„ã«ã¯å®Ÿæ©Ÿã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹ã€‚


### 3.10 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆï¼ˆæŠœç²‹ï¼‰

- **å·¥ç¨‹è¨­å®šãŒä¿å­˜ã§ããªã„ (`Permission denied: /var/lib/toolmgmt/station.json`)**
  - `sudo mkdir -p /var/lib/toolmgmt && sudo chown tools01:tools01 /var/lib/toolmgmt && sudo chmod 755 /var/lib/toolmgmt`
- **å·¦ä¸Šãƒšã‚¤ãƒ³ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãªã„**
  - DocumentViewer ãŒ `{type:'dv-barcode', part, order}` ã‚’ postMessage ã—ã¦ã„ã‚‹ã‹ç¢ºèªã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèªã™ã‚‹ã€‚
- **API ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ï¼ˆ401ï¼‰ã«ãªã‚‹**
  - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ â†’ ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ã€ã§ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜åˆ†ã‚’å‰Šé™¤ã—ã€`scripts/manage_api_token.py rotate` ã§å†ç™ºè¡Œã—ã¦å…¥åŠ›ã€‚
- **ãƒªãƒ¢ãƒ¼ãƒˆé…å¸ƒãŒæ›´æ–°ã•ã‚Œãªã„**
  - `journalctl -u toolmgmt.service --since now-5m | grep plan-cache` ãªã©ã§ãƒ­ã‚°ã‚’ç¢ºèªã—ã€ç’°å¢ƒå¤‰æ•°ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã‚’ç‚¹æ¤œã€‚

### æ±ºå®šè¨˜éŒ² (Decision Log)

1. **DocumentViewer å·¥ç¨‹è¨­å®šã®ä¿æŒæ–¹æ³•**  
   - **æ–¹é‡**: å„ãƒ©ã‚ºãƒ‘ã‚¤ã«å·¥ç¨‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: `/var/lib/toolmgmt/station.json`ï¼‰ã‚’é…ç½®ã—ã€ç®¡ç† UI ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå·¥ç¨‹ã‚’é¸æŠã—ã¦ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚Flask / DocumentViewer ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆçš„ã«èª­ã¿å–ã‚Šã€ç’°å¢ƒå¤‰æ•° `STATION_PROCESS` ã¯åˆæœŸå€¤ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ®‹ã™ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ JSON å½¢å¼ã§ `{"process": "ç ”ç£¨", "updated_at": "...", "available": ["åˆ‡å‰Š", "ç ”ç£¨"]}` ã®ã‚ˆã†ã«å·¥ç¨‹å€™è£œãƒªã‚¹ãƒˆã‚‚ä¿æŒã—ã€UI ã‹ã‚‰è¿½åŠ ãƒ»å‰Šé™¤ã§ãã‚‹ã€‚  
   - **ç†ç”±**: å·¥ç¨‹åˆ‡æ›¿ã‚’ UI æ“ä½œã®ã¿ã§å®Œçµã•ã›ã€å†èµ·å‹•å¾Œã‚‚è¨­å®šã‚’ä¿æŒã™ã‚‹ãŸã‚ã€‚systemd è¨­å®šã®æ›¸ãæ›ãˆã‚„ sudo æ¨©é™ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ±‚ã‚ãšã€å®‰å…¨ã«é‹ç”¨ã§ãã‚‹ã€‚  
   - **TODO**: è¨­å®šç·¨é›† APIãƒ»ç®¡ç† UI ã®è¿½åŠ ï¼ˆå·¥ç¨‹ãƒªã‚¹ãƒˆã® CRUD å«ã‚€ï¼‰ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ•´å‚™ã€DocumentViewer å´ã§æ–°è¨­å®šã‚’èª­ã¿è¾¼ã‚€å‡¦ç†ã€‚è¨­å®šå¤‰æ›´æ™‚ã¯ JSON æ›´æ–°â†’å³æ™‚é€šçŸ¥ã§åæ˜ ã—ã€ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•å¾Œã‚‚åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚Runbook/README ã®æ‰‹é †æ›´æ–°ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¬ æãƒ»ç ´æã—ãŸå ´åˆã¯ã€UI ä¸Šã§ã€Œå·¥ç¨‹æœªè¨­å®šã€ã‚’è¡¨ç¤ºã—ã¦å†è¨­å®šã‚’ä¿ƒã™ã€‚DocumentViewer ã¯åŒã˜ JSON ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ã€å®šæœŸçš„ã«æ›´æ–°ã‚’æ¤œçŸ¥ã™ã‚‹ã€‚

2. **ãƒãƒ¼ã‚³ãƒ¼ãƒ‰é€£æºï¼ˆéƒ¨å“ç•ªå·ï¼è£½é€ ã‚ªãƒ¼ãƒ€ãƒ¼ï¼‰**  
   - **æ±ºå®šæ¸ˆã¿è¦ç´ **: ç§»å‹•ç¥¨ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¯ã€Œéƒ¨å“ç•ªå· â†’ è£½é€ ã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·ã€ã®é †ã«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã€‚éƒ¨å“ç•ªå·ã ã‘ã§ã‚‚ DocumentViewer ã¯å·¥ç¨‹è¨­å®šã§è©²å½“æ‰‹é †æ›¸ã‚’é–‹ãã€TMS å·¦ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯è©²å½“å€™è£œã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹ã€‚ç¶šã‘ã¦è£½é€ ã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·ã‚’èª­ã¿å–ã‚‹ã¨å€™è£œã‚’ 1 ä»¶ã«ç¢ºå®šã—ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ã€‚  
   - **ã‚¤ãƒ™ãƒ³ãƒˆé€£æº**: DocumentViewer (iframe) ã‹ã‚‰ `postMessage` ã§ `{type: "dv-barcode", part, order}` ã‚’é€ä¿¡ã—ã€TMS å´ `message` ãƒªã‚¹ãƒŠãƒ¼ã§å—ä¿¡ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã‚’è¡Œã†ã€‚å°†æ¥ iframe ä»¥å¤–ã«å¯¾å¿œã™ã‚‹å ´åˆã¯ Socket.IO / REST API ã¸ã®æ‹¡å¼µã‚’æ¤œè¨ã€‚
   - **UI æ–¹é‡**: ç”Ÿç”£è¨ˆç”»ãƒ†ãƒ¼ãƒ–ãƒ«ã§éƒ¨å“ç•ªå·ä¸€è‡´ã®è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã€ä¸Šéƒ¨ã«å€™è£œä»¶æ•°ã¨ã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·å…¥åŠ›æ¡ˆå†…ã‚’è¡¨ç¤ºã€‚æœªç¢ºå®šã®å ´åˆã¯è¡Œæœ«ã«ã€Œã‚ªãƒ¼ãƒ€ãƒ¼æœªç¢ºå®šã€ãƒãƒƒã‚¸ã‚’å‡ºã™ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒèª­ã‚ãªã„å ´åˆã¯å€™è£œè¡Œã‚’ã‚¿ãƒƒãƒ—ã—ã¦æš«å®šç¢ºå®šã§ãã€å¾Œã‹ã‚‰å†ã‚¹ã‚­ãƒ£ãƒ³ã§ä¸Šæ›¸ãã§ãã‚‹ã€‚


---

3. **ãƒ‡ãƒ¼ã‚¿é…å¸ƒï¼ˆUSB â†’ ã‚µãƒ¼ãƒãƒ¼ï¼ã‚¯ãƒ©ã‚¦ãƒ‰ç§»è¡Œï¼‰**  
   - **æ–¹é‡**: å½“é¢ã¯ USB åŒæœŸã‚’ç¶­æŒã—ã¤ã¤ã€å°†æ¥çš„ã« API çµŒç”±ã§è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ§‹æˆã¸ç§»è¡Œã™ã‚‹ã€‚å…·ä½“çš„ã«ã¯ã€Flask èµ·å‹•æ™‚ã« API ã‹ã‚‰æœ€æ–° CSV ã‚’å–å¾—ã— `/var/lib/toolmgmt/plan` ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚ã¯æœ€å¾Œã«å–å¾—ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã€‚USB ã¯æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ç·Šæ€¥æ‰‹æ®µã¨ã—ã¦æ®‹ã™ã€‚  
   - **TODO**: API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã€å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€èªè¨¼/ç›£æŸ»ã®è¦‹ç›´ã—ã€‚ç§»è¡Œãƒ•ã‚§ãƒ¼ã‚ºã§ã®é‹ç”¨æ‰‹é †ï¼ˆUSB vs APIï¼‰ã‚’ README/RUNBOOK ã«è¿½è¨˜ã€‚

---

4. **API ãƒˆãƒ¼ã‚¯ãƒ³é‹ç”¨ï¼ˆã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å˜ä½ï¼‰**  
   - **æ–¹é‡**: å„ãƒ©ã‚ºãƒ‘ã‚¤/ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã« API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å€‹åˆ¥ç™ºè¡Œã—ã€`/etc/toolmgmt/api_token.json` ã«ä¿å­˜ã—ã¦èªè¨¼ã™ã‚‹ã€‚åˆæœŸæ®µéšã§ã¯ CLI ãƒ„ãƒ¼ãƒ«ã§ç™ºè¡Œãƒ»å¤±åŠ¹ã‚’è¡Œã„ã€å°†æ¥çš„ã«ç®¡ç† UI ã‹ã‚‰ã‚‚ç™ºè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚  
   - **é‹ç”¨**: `scripts/manage_api_token.py issue --station-id CUTTING-01` ã§ç™ºè¡Œã—ã€å‡ºåŠ›ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨è€…ã«å…±æœ‰ã€‚`show` ã§ç¾åœ¨å€¤ç¢ºèªã€`revoke` ã§å‰Šé™¤ã€‚ç›£æŸ»ãƒ­ã‚°ï¼ˆ`logs/api_actions.log`ï¼‰ã«ã¯ station_id ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã€‚  
   - **TODO**: ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é«˜åº¦åŒ–ï¼ˆè¤‡æ•°ãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œã‚„å±¥æ­´ç®¡ç†ï¼‰ã€åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã¸ã®çµ„ã¿è¾¼ã¿ã€GUI é€£æºã‚’è¦‹æ®ãˆãŸ API è¨­è¨ˆã€‚

---

5. **é‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™**  
   - **å„ªå…ˆé †**: â‘  æ–°è¦ãƒ©ã‚ºãƒ‘ã‚¤æ§‹ç¯‰ãƒ•ãƒ­ãƒ¼ï¼ˆOS æ›¸ãè¾¼ã¿â†’ãƒªãƒã‚¸ãƒˆãƒªå–å¾—â†’å·¥ç¨‹è¨­å®šâ†’ãƒˆãƒ¼ã‚¯ãƒ³é©ç”¨â†’å‹•ä½œç¢ºèªï¼‰ã‚’ README/RUNBOOK ã«è©³è¿° â‘¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆé›†ï¼ˆUSB åŒæœŸãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹ãªã©ï¼‰ â‘¢ ç®¡ç† UI ã‚„å€™è£œè¡¨ç¤ºã®æ“ä½œèª¬æ˜ â‘£ Decision Log ã®è¦ç´„ç‰ˆã€‚  
   - **TODO**: åˆæœŸæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰ã‚’æ›¸ãèµ·ã“ã—ã€å¿…è¦ãª CLI ã‚³ãƒãƒ³ãƒ‰ã¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¾‹ã‚’è¿½è¨˜ã€‚ä»£è¡¨çš„ãªéšœå®³å¯¾å¿œæ‰‹é †ã‚’æ•´ç†ã—ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚„å›³ã¯ UI å®‰å®šå¾Œã«è¿½åŠ ã™ã‚‹ã€‚Decision Log æ›´æ–°ã¨å†…å®¹ã®ç›¸äº’å‚ç…§ã‚’ç¶­æŒã™ã‚‹ã€‚

---

6. **ãƒ†ã‚¹ãƒˆæˆ¦ç•¥**  
   - **æ–¹é‡**: ãƒ©ã‚ºãƒ‘ã‚¤ä¸Šã§ã®ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’æ•´å‚™ã—ã€USB åŒæœŸãƒ»å·¥ç¨‹è¨­å®šãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰çµã‚Šè¾¼ã¿ãŒã²ã¨é€šã‚Šå‹•ãã“ã¨ã‚’ `make test-smoke` ç­‰ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚åŒæ™‚ã«ä¸»è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ Python é–¢æ•°ã¯ pytest ã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ç”¨æ„ã™ã‚‹ã€‚  
   - **TODO**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ USB ãƒ¢ãƒƒã‚¯ã‚’ç”¨æ„ã—ã€ãƒ©ã‚ºãƒ‘ã‚¤å‘ã‘ pytest ã‚¹ã‚¤ãƒ¼ãƒˆï¼ã‚·ã‚§ãƒ«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã€‚GitHub Actions ç­‰ã® CI ã«ã‚‚ä¸€éƒ¨ãƒ†ã‚¹ãƒˆï¼ˆlint, unitï¼‰ã‚’çµ„ã¿è¾¼ã¿ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ README/RUNBOOK ã«è¿½è¨˜ã™ã‚‹ã€‚

---

## 4. ãƒ‡ãƒ¼ã‚¿ä¿å…¨ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ãƒªã‚¹ãƒˆã‚¢ï¼‰

### 4.1 æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä¿æŒ 14 æ—¥ï¼‰

- ã‚¿ã‚¤ãƒãƒ¼å°å…¥ï¼ˆæ¸ˆã§ã‚ã‚Œã°ä¸è¦ï¼‰ï¼š

    cd ~/tool-management-system02
    chmod +x scripts/*.sh
    sudo bash scripts/install_backup_timer.sh
    systemctl list-timers --all | grep backup_db

- å³æ™‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œï¼š

    sudo systemctl start backup_db.service
    ls -lh backups | tail -n 3

- ä»•æ§˜ï¼š
  - å®Ÿè¡Œï¼šæ¯æ—¥ 02:30ï¼ˆJSTï¼‰
  - å‡ºåŠ›ï¼š`backups/sensordb-YYYYmmdd-HHMMSS.sql.gz`
  - ä¿æŒï¼š14 æ—¥ã‚ˆã‚Šå¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•å‰Šé™¤

### 4.2 å¾©å…ƒãƒ†ã‚¹ãƒˆï¼ˆæ¤œè¨¼ç”¨ DBï¼š`sensordb_verify`ï¼‰

- æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—ï¼š

    LATEST=$(ls -1t backups/sensordb-*.sql.gz | head -n 1); echo "$LATEST"

- æ¤œè¨¼ç”¨ DB ä½œæˆã¨èª­ã¿æˆ»ã—ï¼š

    docker exec -i pg psql -U app -d postgres -c "DROP DATABASE IF EXISTS sensordb_verify;"
    docker exec -i pg psql -U app -d postgres -c "CREATE DATABASE sensordb_verify OWNER app;"
    gunzip -c "$LATEST" | docker exec -i pg psql -U app -d sensordb_verify

- ç¢ºèªï¼š

    docker exec -it pg psql -U app -d sensordb_verify -c "\dt"
    docker exec -it pg psql -U app -d sensordb_verify -c "SELECT COUNT(*) AS users FROM users;"
    docker exec -it pg psql -U app -d sensordb_verify -c "SELECT COUNT(*) AS tools FROM tools;"
    docker exec -it pg psql -U app -d sensordb_verify -c "SELECT COUNT(*) AS open_loans FROM loans WHERE returned_at IS NULL;"

- ç‰‡ä»˜ã‘ï¼ˆä»»æ„ï¼‰ï¼š

    docker exec -i pg psql -U app -d postgres -c "DROP DATABASE sensordb_verify;"

### 4.3 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç‚¹æ¤œï¼ˆé€±æ¬¡æ¨å¥¨ï¼‰

1. æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼š

        cd ~/tool-management-system02
        ./scripts/check_backup_status.sh            # 24æ™‚é–“ä»¥å†…ã‚’ç¢ºèª

   - ã—ãã„å€¤ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ `./scripts/check_backup_status.sh 48` ã®ã‚ˆã†ã«æ™‚é–“ã‚’æŒ‡å®šã€‚
   - çµæœã« `WARNING` ã‚„ `ERROR` ãŒå‡ºãŸå ´åˆã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‘ã‚¹ã‚’å†ç¢ºèªã—ã€`journalctl -u backup_db.service -n 20` ã§å¤±æ•—åŸå› ã‚’è¿½ã†ã€‚

2. `systemctl status backup_db.timer` ã§ã‚¿ã‚¤ãƒãƒ¼ãŒ `active (running)` ã‹ç¢ºèªã€‚
3. `backups/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é€±æ¬¡ã§å¤–éƒ¨åª’ä½“ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ï¼ˆUSB ç­‰ï¼‰ã€‚
4. ç‚¹æ¤œçµæœã¯é‹ç”¨ãƒãƒ¼ãƒˆï¼ˆä¾‹ï¼šGoogle Sheetsï¼‰ã«æ—¥ä»˜ãƒ»æ‹…å½“è€…ãƒ»åˆ¤å®šã‚’è¨˜éŒ²ã™ã‚‹ã€‚

---

## 5. èª¿æ•´ãƒ»å¼·åŒ–ç‚¹ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

- **DB æ¥ç¶šãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§ 30 ç§’ï¼‰**ï¼šDB èµ·å‹•å¾…ã¡ã§ã‚¢ãƒ—ãƒªãŒè½ã¡ãªã„
- **docker-compose**ï¼š`restart: unless-stopped`ã€`pg_isready` **healthcheck**ã€**localhost ãƒã‚¤ãƒ³ãƒ‰**ã€`TZ=Asia/Tokyo`
- **systemd è‡ªå‹•èµ·å‹•**ï¼šUTF-8 ãƒ­ã‚°ã€`pcscd/docker` å¾…ã¡åˆã‚ã›ã€`PYTHONUNBUFFERED=1`
- **DB ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³**ï¼š`ALTER DATABASE sensordb SET timezone='Asia/Tokyo';`
- **æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**ï¼š`scripts/backup_db.sh` + `backup_db.timer`ï¼ˆä¿æŒ14æ—¥ã€æ¤œè¨¼æ‰‹é †ä»˜ãï¼‰
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆloansï¼‰**ï¼šæœªè¿”å´æ¤œç´¢ã¨å±¥æ­´ã‚½ãƒ¼ãƒˆã®é«˜é€ŸåŒ–
  - `loans_open_by_tool_idx`ï¼ˆ`WHERE returned_at IS NULL`ï¼‰
  - `loans_open_by_borrower_idx`ï¼ˆåŒä¸Šï¼‰
  - `loans_loaned_at_idx` / `loans_returned_at_idx`ï¼ˆé™é †ã‚½ãƒ¼ãƒˆå‘ã‘ï¼‰

---

## 11. UI ã‹ã‚‰ã®å®‰å…¨ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é™å®šï¼‰

**æ¦‚è¦**  
- ç”»é¢å³ä¸‹ã«ã€Œå®‰å…¨ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€‚  
- **ã“ã®Raspberry Pi ä¸Šã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆã‚­ã‚ªã‚¹ã‚¯å«ã‚€ï¼‰**ã‹ã‚‰ã®ã¿å®Ÿè¡Œå¯èƒ½ï¼ˆ127.0.0.1/::1 ãŠã‚ˆã³ Pi è‡ªèº«ã® NIC ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è‡ªå‹•åˆ¤å®šï¼‰ã€‚  
- å¿…è¦ã«å¿œã˜ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ`SHUTDOWN_TOKEN`ï¼‰ã§LANå†…ã‹ã‚‰ã®å®Ÿè¡Œã‚‚è¨±å¯ã§ãã¾ã™ã€‚

**å‰æï¼ˆsudoers ã‚’ä¸€åº¦ã ã‘è¨­å®šï¼‰**  
- é‹ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¾‹ï¼š`tools01`ï¼‰ã«å¯¾ã—ã€`shutdown -h now` ã®ã¿ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ã§è¨±å¯ã€‚

    sudo tee /etc/sudoers.d/toolmgmt-shutdown >/dev/null <<'SUDO'
    tools01 ALL=(root) NOPASSWD: /sbin/shutdown -h now, /usr/sbin/shutdown -h now
    SUDO
    sudo visudo -cf /etc/sudoers.d/toolmgmt-shutdown && echo "sudoers OK"

**API**  
- `POST /api/shutdown`  
  - è¦æ±‚: JSON `{"confirm": true}`  
  - è¨±å¯: Pi è‡ªèº«ã®IPã‹ã‚‰ã®ã¿ï¼ˆ`127.0.0.1`/`::1`/NICã®ãƒ­ãƒ¼ã‚«ãƒ«IPã‚’è‡ªå‹•ç™ºè¦‹ï¼‰ã€‚ã‚‚ã—ãã¯ `SHUTDOWN_TOKEN` ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ä¸€è‡´æ™‚ã«è¨±å¯ã€‚  
  - å¿œç­”: `{"ok": true, "message": "Shutting down..."}`ï¼ˆå¿œç­”å¾Œã€æ•°ç§’ã§åœæ­¢å‡¦ç†ã¸ï¼‰

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**  
- å³ä¸‹å›ºå®šã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ï¼ˆ`index.html` ã® `</body>` ç›´å‰ã§JSã«ã‚ˆã‚Šå‹•çš„æŒ¿å…¥ï¼‰ã€‚  
- ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã€ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°â†’ `/api/shutdown` ã‚’å‘¼ã³å‡ºã—ã€‚æˆåŠŸãªã‚‰ã€Œé–‹å§‹ã—ã¾ã—ãŸã€ã¨ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã€‚

**ä»»æ„: é éš”ã§ä½¿ã†ï¼ˆæ¨å¥¨ã—ãªã„ï¼‰**  
- `setup_auto_start.sh` ã® systemd ãƒ¦ãƒ‹ãƒƒãƒˆã¸ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆä¾‹ï¼‰  
    Environment=SHUTDOWN_TOKEN=<ãƒ©ãƒ³ãƒ€ãƒ ãªé•·ã„æ–‡å­—åˆ—>
- ãã®ä¸Šã§ãƒ•ãƒ­ãƒ³ãƒˆã® fetch ã«ãƒ˜ãƒƒãƒ€ã‚’è¿½åŠ   
    X-Shutdown-Token: <ä¸Šã¨åŒã˜å€¤>
  - èª¤æ“ä½œ/æ‚ªç”¨ã®ãƒªã‚¹ã‚¯ãŒä¸ŠãŒã‚‹ãŸã‚ã€ååˆ†ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶å¾¡ã‚’å‰æã¨ã™ã‚‹ã“ã¨ã€‚

> **é‹ç”¨ãƒ¡ãƒ¢**: LAN å´ã® IP ã§ç”»é¢ã‚’é–‹ã„ãŸå ´åˆã¯ `forbidden` ãŒè¿”ã‚‹ä»•æ§˜ã€‚Pi æœ¬ä½“ã§ `http://127.0.0.1:8501` ã‚’é–‹ãé‹ç”¨ãŒåŸºæœ¬ã¨ãªã‚Šã¾ã™ã€‚

**æ³¨æ„ç‚¹**  
- å®Ÿè¡Œå¾Œã¯LEDæ¶ˆç¯ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é›»æºã‚’æŠœãã“ã¨ã€‚  
- `pcsc_scan` ãªã©åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚«ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ã‚’æ´ã‚“ã§ã„ã¦ã‚‚ã€åœæ­¢ãƒ—ãƒ­ã‚»ã‚¹ã¨ã¯ç„¡é–¢ä¿‚ã€‚



## 6. é‹ç”¨ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆï¼ˆã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰ï¼‰

- ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã¨ãƒ­ã‚°ï¼š

    systemctl is-active --quiet toolmgmt.service && echo "toolmgmt: OK" || (echo "toolmgmt: NG"; systemctl status toolmgmt.service --no-pager)
    journalctl -u toolmgmt.service -n 200 --no-pager
    journalctl -u toolmgmt.service -f

- DB/Grafanaï¼š

    docker compose ps
    docker inspect -f '{{.State.Health.Status}}' pg
    docker logs pg --tail 100

- ã‚¢ãƒ—ãƒªç–é€šï¼ˆHTTP ãƒ˜ãƒƒãƒ€ï¼‰ï¼š

    curl -I http://localhost:8501 | head -n 1

- Postgres ã¸ä¸€ç™ºã‚¯ã‚¨ãƒªï¼š

    docker exec -it pg psql -U app -d sensordb -c "\dt"
    docker exec -it pg psql -U app -d sensordb -P pager=off -c "SELECT id, tool_uid, borrower_uid, loaned_at, return_user_uid, returned_at FROM loans ORDER BY id DESC LIMIT 5;"

- RealVNC ã§ã®æ¥ç¶šï¼ˆMac ä¾‹ï¼‰ï¼š

    # Mac å´ã§ IP ã‚’ç¢ºèª
    ipconfig getifaddr en1

    # ãƒ©ã‚ºãƒ‘ã‚¤å´ã§ VNC (5900/tcp) ã‚’è¨±å¯
    sudo ufw allow from <Macã®IP> to any port 5900 proto tcp

    # ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
    sudo ufw status numbered

    # VNC ã‚µãƒ¼ãƒãƒ¼ã®ç¨¼åƒç¢ºèª
    systemctl status vncserver-x11-serviced --no-pager

---

## 7. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

- **DB æ¥ç¶šæ‹’å¦ï¼ˆconnection refusedï¼‰**
  - `docker compose ps` â†’ `pg` ãŒ Up/healthy ã‹
  - `docker compose up -d`ã€`docker logs pg --tail 100`
  - èµ·å‹•ç›´å¾Œã¯ã‚¢ãƒ—ãƒªãŒ **è‡ªå‹•ã§ãƒªãƒˆãƒ©ã‚¤**ã™ã‚‹ã®ã§æ•°åç§’å¾…ã¤

- **NFC ãŒèª­ã‚ãªã„ / åå¿œãŒãªã„**
  - `sudo systemctl status pcscd`ã€`pcsc_scan`ï¼ˆç«¶åˆæ³¨æ„ï¼špcsc_scan ã‚’çµ‚äº†ã—ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªã¸ï¼‰
  - USB ã®æŠœãå·®ã—ã€`sudo systemctl restart pcscd`

- **ç”»é¢ãŒæ›´æ–°ã•ã‚Œãªã„ / Socket.IO ãŒä¸å®‰å®š**
  - ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èª­ã¿è¾¼ã¿ã€åˆ¥ç«¯æœ«ã§ã‚‚å†ç¾ã‹ç¢ºèª
  - `journalctl -u toolmgmt.service -n 200` ã§ã‚¨ãƒ©ãƒ¼æœ‰ç„¡

- **VNC çµŒç”±ã®ã‚³ãƒ”ãƒšã§æ–‡å­—åŒ–ã‘**
  - VNC ã®ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰çµŒè·¯ã«ã‚ˆã‚‹æ–‡å­—ã‚³ãƒ¼ãƒ‰å•é¡Œ
  - å›é¿ï¼šSSH ã§ `pbpaste | ssh ... "wl-copy"` / `"wl-paste" | pbcopy` ãªã©

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨å…¬é–‹ãƒãƒ¼ãƒˆ

- æ—¢å®šã§ã¯ Postgres/Grafana ã¯ **127.0.0.1** ã§ã®ã¿å…¬é–‹ã€‚
- LAN ã¸é–‹ããŸã„å ´åˆã¯ã€`docker-compose.yml` ã® `ports` ã‚’ `3000:3000` ã®ã‚ˆã†ã«å¤‰æ›´ã€‚
- ã•ã‚‰ã«åˆ¶å¾¡ã™ã‚‹å ´åˆã¯ `ufw` ç­‰ã§è¨±å¯å…ƒã‚’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé™å®šã€‚
- ã‚¢ãƒ—ãƒª `:8501` ã¯ LAN ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆå¿…è¦ã«å¿œã˜ã¦ Reverse Proxy ç­‰ã§ä¿è­·ï¼‰ã€‚

---

## 9. å°†æ¥ã®è¨ˆç”»ï¼ˆä»»æ„ï¼‰

- æœ¬ç•ªå‘ã‘ã‚µãƒ¼ãƒï¼ˆ`gunicorn -k eventlet` ãªã©ï¼‰ã¸ã®ç§»è¡Œ
- æ§‹é€ åŒ–ï¼ˆ`app/` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ†å‰²ï¼‰ã¨ãƒ†ã‚¹ãƒˆå°å…¥
- æœªè¿”å´ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆSlack/ãƒ¡ãƒ¼ãƒ«ï¼‰ã€CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ APIã€Grafana ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é››å½¢

---
## 10. å†ç¾æ€§ç¢ºä¿ï¼ˆScripts Inventoryï¼‰

æœ¬ç•ªæ©Ÿã§æ‰‹ä½œæ¥­ã—ãŸè¨­å®šã‚’ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚æ–°ã—ã„ç’°å¢ƒã§ã¯ä»¥ä¸‹ã‚’é †ã«å®Ÿè¡Œã™ã‚Œã°ã€åŒã˜çŠ¶æ…‹ã‚’å†ç¾ã§ãã¾ã™ã€‚

- OSå‰æå°å…¥  
    bash scripts/os_prereqs.sh

- Docker + Compose å°å…¥ï¼ˆå®Ÿè¡Œå¾Œã«ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ/ãƒ­ã‚°ã‚¤ãƒ³ï¼‰  
    bash scripts/install_docker.sh

- ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ï¼ˆæ—¢å­˜æ‰‹é †ã©ãŠã‚Šï¼‰  
    docker compose up -d

- DBãƒã‚¹ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆJSTã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ & ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰  
    bash scripts/apply_db_tuning.sh

- ã‚­ã‚ªã‚¹ã‚¯è‡ªå‹•èµ·å‹•ï¼ˆXDG ã‚ªãƒ¼ãƒˆã‚¹ã‚¿ãƒ¼ãƒˆã€ä»»æ„ï¼‰  
    bash scripts/install_kiosk_autostart.sh
    # ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆ:
    bash scripts/remove_kiosk_autostart.sh

## 12. ã‚¹ã‚­ãƒ£ãƒ³ã®ã‚¿ãƒ–ç‹¬ç«‹ & UI åŒæœŸ

- ã€Œå€Ÿç”¨/è¿”å´ã€ã‚¿ãƒ–ã§ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¦ã‚‚ã€ã‚¿ãƒ–ã‚’ç§»å‹•ã™ã‚‹ã¨ **è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢** ã—ã¾ã™ã€‚
- ã€Œå€Ÿç”¨/è¿”å´ã€ä»¥å¤–ã®ã‚¿ãƒ–ã«ã„ã‚‹é–“ã¯ã€UI ãŒ **åœæ­¢çŠ¶æ…‹ï¼ˆã€Šã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã€‹=æŠ¼ã›ã‚‹ã€ã€Šåœæ­¢ã€‹=æŠ¼ã›ãªã„ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=ã€Œâ— åœæ­¢ä¸­ã€ï¼‰** ã«æˆ»ã‚Šã¾ã™ã€‚
- å„ã‚¿ãƒ–ã¯ç‹¬ç«‹ã—ã¦å€¤ã‚’æ‰±ã„ã€**ç™»éŒ²ã‚¿ãƒ–ã§ã®ã‚¹ã‚­ãƒ£ãƒ³çµæœãŒå€Ÿç”¨/è¿”å´ã®æ¬„ã«æ··å…¥ã—ã¾ã›ã‚“**ã€‚
- å®Ÿè£…æ¦‚è¦ï¼š
  - ãƒ•ãƒ­ãƒ³ãƒˆã§ `appScan.start('loan') / appScan.stop()` ã®ãƒ©ãƒƒãƒ‘ã‚’ä½¿ç”¨ã—ã¦æ–‡è„ˆã‚’ç®¡ç†
  - ã‚¿ãƒ–åˆ‡æ›¿æ¤œçŸ¥ã§ `appScan.stop()` ã‚’å¼·åˆ¶å®Ÿè¡Œ
  - `scan_update` å—ä¿¡æ™‚ã€æ–‡è„ˆãŒ `loan` ã§ãªã„å ´åˆã¯ UI æ›´æ–°ã—ãªã„

 ## ç”¨èªçµ±ä¸€ï¼ˆUIè¡¨ç¤ºï¼‰ã«ã¤ã„ã¦

- æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ UI ä¸Šã®è¡¨ç¤ºæ–‡è¨€ã‚’ã€Œå·¥å…·ã€â†’ã€Œã‚¢ã‚¤ãƒ†ãƒ ã€ã«çµ±ä¸€ã—ã¦ã„ã¾ã™ã€‚
- æ—¢å­˜DB/APIã®è­˜åˆ¥å­ï¼ˆ`tool`, `tools`, `/api/tool_names` ç­‰ï¼‰ã¯ **äº’æ›æ€§ç¶­æŒã®ãŸã‚å¤‰æ›´ã—ã¾ã›ã‚“**ï¼ˆå¤–éƒ¨é€£æºã‚„éå»ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿å›é¿ï¼‰ã€‚
- ãƒ©ãƒ™ãƒ«ã®ã¿ã‚’å·®ã—æ›¿ãˆã¦ã„ã‚‹ãŸã‚ã€æ—¢å­˜é‹ç”¨ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾åˆ©ç”¨ã§ãã¾ã™ã€‚

## é«˜å¯†åº¦è¡¨ç¤ºï¼ˆãƒ•ãƒ«HD/21ã‚¤ãƒ³ãƒå‰æï¼‰

- `templates/index.html` ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–æ¸ˆã¿ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œé«˜ã¨ä½™ç™½ã‚’åœ§ç¸®ã—ã€**è²¸å‡ºä¸­ï¼å±¥æ­´**ã®å¯è¦–ä»¶æ•°ã‚’å¢—ã‚„ã—ã¦ã„ã¾ã™ã€‚
- ä¸€è¦§ãƒ˜ãƒƒãƒ€ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã‚‚è¦‹ãˆã‚‹ã‚ˆã† **å›ºå®šåŒ–** ã—ã¦ã„ã¾ã™ï¼ˆ`position: sticky`ï¼‰ã€‚

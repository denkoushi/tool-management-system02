<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>アイテム管理システム</title>
  <script src="/static/js/socket.io.js"></script>
  

  <style>
  /* ===== Design tokens (light / modern / compact) ===== */
  :root{
    --bg: #f6f7f9;
    --surface: #ffffff;
    --surface-2: #f3f4f6;
    --border: #e5e7eb;
    --text: #111827;
    --muted: #6b7280;
    --brand: #2d6cdf;
    --brand-2: #0ea5e9;
    --success: #16a34a;
    --danger: #dc2626;
    --warning: #f59e0b;

    /* タイポ・サイズ（フルHD/21"想定の高密度） */
    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-md: 14px;
    --fs-lg: 16px;
    --fs-xl: 18px;
    --radius: 8px;

    /* コンポーネント密度 */
    --space-1: 4px;
    --space-2: 6px;
    --space-3: 8px;
    --space-4: 10px;
    --space-5: 12px;
  }

  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{width:100%;height:100%;overflow:hidden;}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: var(--bg); color: var(--text);
    display:flex; justify-content:flex-start; align-items:stretch;
  }
  body.modal-locked{overflow:hidden;}
  .app-layout{display:flex;width:100vw;height:100vh;}
  .container{flex:0 0 50vw;height:100vh;background:var(--surface);display:flex;flex-direction:column;box-shadow:2px 0 12px rgba(15,23,42,.08);}
  .future-panel{
    flex:1;
    background:var(--bg);
    display:flex;
    flex-direction:column;
    border-left:1px solid var(--border);
    position:relative;
  }

  .doc-viewer-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:var(--space-3);
    padding: var(--space-4);
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.92);
    backdrop-filter: blur(6px);
  }
  .doc-viewer-header h2{font-size:var(--fs-lg); font-weight:700; color:var(--text);}
  .doc-viewer-header-actions{display:flex; align-items:center; gap:var(--space-3);}

  .doc-viewer-status{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    font-size:var(--fs-sm);
    font-weight:700;
    background:var(--surface-2);
    color:var(--muted);
    transition:.2s;
  }
  .doc-viewer-status__dot{width:8px;height:8px;border-radius:50%;background:currentColor;display:block;}
  .doc-viewer-status--online{background:#dcfce7;border-color:#bbf7d0;color:#166534;}
  .doc-viewer-status--offline{background:#fef2f2;border-color:#fecaca;color:#991b1b;}

  .btn-reload{
    padding:6px 12px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    color:var(--text);
    font-size:var(--fs-sm);
    font-weight:700;
    cursor:pointer;
    transition:.15s;
  }
  .btn-reload:hover{background:var(--surface-2);}

  .doc-viewer-wrapper{
    flex:1;
    position:relative;
    background:var(--surface-2);
    overflow:hidden;
  }
  #docViewerFrame{
    width:100%;
    height:100%;
    border:0;
    background:#fff;
  }
  .doc-viewer-overlay{
    position:absolute;
    inset:12px;
    border-radius:var(--radius);
    background:rgba(15,23,42,.72);
    color:#f8fafc;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:24px;
    font-size:var(--fs-md);
    line-height:1.5;
    box-shadow:0 12px 32px rgba(15,23,42,.35);
  }
  .doc-viewer-overlay.is-hidden{display:none;}

  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.62);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .modal-overlay.is-visible{display:flex;}
  .modal-body{
    background:#0f172a;
    color:#e2e8f0;
    padding:32px 40px;
    border-radius:12px;
    box-shadow:0 24px 48px rgba(15,23,42,.45);
    width:min(420px, 90vw);
    text-align:center;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .modal-body h3{font-size:18px; margin:0; font-weight:700;}
  .modal-body p{margin:0; font-size:14px; color:#cbd5f5;}
  .modal-spinner{
    width:42px;
    height:42px;
    border-radius:50%;
    border:4px solid rgba(226,232,240,0.25);
    border-top-color:#38bdf8;
    margin:0 auto;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}

  /* Tabs */
  .tabs{
    display:flex; position:sticky; top:0; z-index:10;
    background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
    box-shadow: 0 2px 6px rgba(17,24,39,.08);
  }
  .tab-button{
    flex:1; padding: var(--space-4) var(--space-3);
    background:none; border:none; cursor:pointer;
    font-size: var(--fs-lg); font-weight:700;
    color: rgba(255,255,255,.9);
    border-bottom: 3px solid transparent; transition: .2s;
    white-space: nowrap;
  }
  .tab-button.active{background:rgba(255,255,255,.16); color:#fff; border-bottom-color:#fff;}

  .tab-content{display:none; padding: var(--space-4) var(--space-4); flex:1; overflow-y:auto;}
  .tab-content.active{display:flex; flex-direction:column;}

  /* Operations (Borrow/Return) */
  #operations{padding: var(--space-4);}
  #operations h2{font-size: var(--fs-lg); font-weight:700; color: var(--text);}

  .operation-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom:1px solid var(--border);
  }

  /* Buttons: compact */
  .button-row{display:flex; gap: var(--space-3); margin-bottom: var(--space-3);}
  .btn{
    padding: 10px 12px; border:none; border-radius: 6px; cursor:pointer;
    font-size: 18px; font-weight:700; transition:.15s;
    display:flex; align-items:center; justify-content:center; gap:6px;
    min-height: 42px;
  }
  .btn-primary{background:var(--brand); color:#fff;}
  .btn-primary:active{transform:scale(.98);}
  .btn-secondary{background:#6b7280; color:#fff;}
  .btn-danger{background:var(--danger); color:#fff;}
  .btn:disabled{opacity:.5; cursor:not-allowed;}

  .btn-table{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    font-size: var(--fs-sm);
    font-weight:700;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
    min-height:30px;
    transition:.15s;
  }
  .btn-table:hover{background:var(--surface-2);} 
  .btn-manual-return{border-color:var(--brand); color:var(--brand);} 
  .btn-manual-return:hover{background:#eef6ff;}
  .btn-delete{border-color:var(--danger); color:var(--danger);} 
  .btn-delete:hover{background:#fef2f2;}

  /* Status pill */
  .status-indicator{
    display:inline-flex; align-items:center; gap:6px;
    padding: 2px 10px; border-radius: 999px;
    font-size: var(--fs-sm); font-weight:700; transition:.2s;
    background: var(--surface-2); color: var(--muted);
    border:1px solid var(--border);
  }
  .status-active{
    background: #dcfce7; color:#166534; border-color:#bbf7d0;
    animation: pulse 2s infinite;
  }
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.85}}

  /* Scan progress: more compact */
  .scan-progress{
    display:flex; gap: var(--space-3);
    margin: var(--space-4) 0 var(--space-3);
    background: var(--surface-2); border-radius: var(--radius);
    padding: var(--space-3);
    border:1px solid var(--border);
  }
  .scan-step{flex:1;}
  .scan-step label{display:block; font-size: var(--fs-sm); color: var(--muted); margin-bottom:4px; font-weight:700;}
  .scan-display{
    background:#fff; border:1px solid var(--border); border-radius:6px;
    padding: 6px 8px;
    font-size: 20px; min-height: 36px;
    display:flex; align-items:center; overflow:hidden; text-overflow:ellipsis; word-break:break-all;
  }
  .scan-display.active{border-color: var(--brand); background:#eef6ff;}
  .scan-display.completed{border-color:#22c55e; background:#ecfdf5;}

  /* Alerts */
  .alert{padding:8px 12px; border-radius:6px; margin:8px 0; font-size: var(--fs-md);}
  .alert-success{background:#ecfdf5; border:1px solid #bbf7d0; color:#166534;}
  .alert-danger{background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d;}
  .alert-info{background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a;}
  .alert-warning{background:#fffbeb; border:1px solid #fde68a; color:#7c2d12;}

  .section-divider{border:none; border-top:2px solid var(--border); margin: 12px 0 10px;}
  .section-title{font-size: var(--fs-md); font-weight:700; color:#374151; margin-bottom:8px; display:flex; align-items:center; gap:6px;}

  /* Tables: compact/high-density with sticky header */
  .data-table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--border); border-radius:8px; overflow:hidden; font-size: 13.5px;}
  .data-table thead th{
    position: sticky; top: 0; z-index: 1;
    background:#f8fafc; color:#334155;
    padding: 6px 8px; text-align:left; font-weight:800; border-bottom:1px solid var(--border);
  }
  .data-table tbody td{
    padding: 4px 8px;
    border-bottom:1px solid #f1f5f9;
    line-height: 1.15;
  }
  .data-table tbody tr:hover{background:#f9fafb;}
  .table-actions{display:flex; gap:6px; flex-wrap:wrap;}

  /* Lists layout: more space for tables without変更多段 */
  .bottom-tables{flex:1; display:flex; flex-direction:column; gap: 8px; overflow:hidden;}
  .table-section{flex:1; display:flex; flex-direction:column; min-height:0;}
  .scrollable-section{flex:1; overflow:auto; -webkit-overflow-scrolling:touch;}

  /* Forms compact */
  #registration, #master{padding: 14px; overflow-y:auto;}
  #registration h2, #master h2{font-size: var(--fs-xl); margin-bottom: 10px; color:#111827;}
  #registration h3, #master h3{font-size: var(--fs-lg); margin: 12px 0 8px; color:#1f2937;}

  .input-row{display:flex; gap:10px; margin-bottom:12px; align-items:end;}
  .input-group{flex:1;}
  .input-group label{display:block; margin-bottom:5px; font-weight:700; color:#374151; font-size: var(--fs-sm);}
  .form-control{
    width:100%; padding: 8px 10px; border:1px solid var(--border); border-radius:6px; font-size: var(--fs-md);
    transition: border-color .15s, box-shadow .15s;
  }
  .form-control:focus{outline:none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(45,108,223,.12);}

  @media (orientation:portrait){
    .operation-header{flex-direction:column; align-items:flex-start; gap:6px;}
    .status-indicator{align-self:flex-end;}
    .button-row{flex-wrap:wrap;}
  }
</style>


  
</head>
<body>
<div class="app-layout">
<div class="container">
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('operations')">📲 借用/返却</button>
    <button class="tab-button" onclick="showTab('registration')">🔖 タグ登録</button>
    <button class="tab-button" onclick="showTab('master')">📚 マスタ</button>
    <button class="tab-button" onclick="showTab('maintenance')">🛠 メンテ</button>
  </div>

  <!-- 借用/返却 -->
  <div id="operations" class="tab-content active">
    <div class="operation-header">
      <h2>①ユーザー → ②アイテム の順にスキャン</h2>
      <span id="scanStatus" class="status-indicator status-inactive">● 停止中</span>
    </div>

    <div class="button-row">
      <button class="btn btn-primary" id="startScanBtn" onclick="startScan()">スキャン開始</button>
      <button class="btn btn-secondary" id="stopScanBtn" onclick="stopScan()" disabled>停止</button>
      <button class="btn btn-danger" onclick="resetState()">リセット</button>
    </div>

    <div class="scan-progress">
      <div class="scan-step">
        <label>①ユーザー</label>
        <div id="userDisplay" class="scan-display"></div>
      </div>
      <div class="scan-step">
        <label>②アイテム</label>
        <div id="toolDisplay" class="scan-display"></div>
      </div>
    </div>

    <div id="scanMessage"></div>
    <div id="transactionResult"></div>

    <hr class="section-divider">

    <div class="bottom-tables">
      <div class="table-section">
        <div class="section-title">📋 貸出中</div>
        <div class="scrollable-section">
          <table class="data-table" id="openLoansTable">
            <thead><tr><th>アイテム</th><th>借用者</th><th>借用日時</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="table-section" style="margin-top:min(10px,2vh);">
        <div class="section-title">🕒 履歴</div>
        <div class="scrollable-section">
          <table class="data-table" id="historyTable">
            <thead><tr><th>区分</th><th>アイテム</th><th>ユーザー</th><th>日時</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- タグ登録 -->
  <div id="registration" class="tab-content">
    <h2>🔖 タグ登録</h2>

    <div style="margin-bottom:30px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #17a2b8;">
      <h3>🔍 タグ情報確認</h3>
      <p style="margin-bottom:15px; color:#6c757d; font-size:14px;">NFCタグをスキャンして、現在の登録状況を確認できます</p>
      <div class="input-group" style="margin-bottom:15px;">
        <button class="btn btn-primary" onclick="checkTagInfo()" style="background:#17a2b8; border-color:#17a2b8;">🔍 タグ情報を確認</button>
      </div>
      <div id="tagCheckResult"></div>
    </div>

    <div style="display:flex; gap:30px; flex-wrap:wrap;">
      <!-- ユーザー登録 -->
      <div style="flex:1; min-width:300px;">
        <h3>👤 ユーザー登録</h3>
        <div class="input-group" style="margin-bottom:15px;">
          <button class="btn btn-primary" onclick="scanForUser()">スキャンしてUID取得</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>UID（自動入力）</label>
          <input type="text" id="userUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>氏名（例：山田太郎）</label>
          <input type="text" id="userNameInput" class="form-control" placeholder="山田太郎">
        </div>
        <button class="btn btn-primary" onclick="registerUser()">💾 登録 / 更新（ユーザー）</button>
        <div id="userRegResult"></div>
      </div>

      <!-- アイテム登録 -->
      <div style="flex:1; min-width:300px;">
        <h3>📦 アイテム登録</h3>
        <div class="input-group" style="margin-bottom:15px;">
          <button class="btn btn-primary" onclick="scanForTool()">スキャンしてUID取得</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>UID（自動入力）</label>
          <input type="text" id="toolUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>アイテム名（マスタから選択）</label>
          <select id="toolNameSelect" class="form-control">
            <option value="">（選択してください）</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="registerTool()">💾 登録 / 更新（アイテム）</button>
        <div id="toolRegResult"></div>
      </div>
    </div>
  </div>

  <!-- アイテム名マスタ -->
  <div id="master" class="tab-content">
    <h2>📚 アイテム名マスタ</h2>

    <div class="input-row">
      <div class="input-group">
        <label>アイテム名を追加</label>
        <input type="text" id="newToolNameInput" class="form-control" placeholder="新しいアイテム名">
      </div>
      <button class="btn btn-primary" onclick="addToolName()">➕ 追加</button>
    </div>

    <div id="masterResult"></div>

    <h3>現在のアイテム名一覧</h3>
    <div class="input-row">
      <div class="input-group">
        <label>削除するアイテム名を選択</label>
        <select id="deleteToolNameSelect" class="form-control">
          <option value="">（選択してください）</option>
        </select>
      </div>
      <button class="btn btn-danger" onclick="deleteToolName()">🗑️ 削除</button>
  </div>
</div>
  
  <!-- メンテナンス -->
  <div id="maintenance" class="tab-content">
    <h2>🛠 メンテナンス</h2>
    <div style="margin-bottom:20px; padding:16px; background:#f8f9fa; border-radius:8px; border:1px solid #e5e7eb;">
      <h3>USB 同期（手動）</h3>
      <p style="color:#6b7280; font-size:14px;">ラベル <code>TOOLMASTER</code> の USB メモリを挿入してから実行すると、マスターデータ（工具名・ユーザー・タグ紐づけ）を同期します。</p>
      <div class="button-row">
        <button class="btn btn-primary" onclick="runUsbSync()">USB 同期を実行</button>
      </div>
      <pre id="usbSyncOutput" style="background:#1f2937; color:#e5e7eb; padding:12px; border-radius:6px; min-height:120px; overflow:auto; font-size:13px;">(まだ実行していません)</pre>
    </div>
  </div>
</div>
<div class="future-panel" id="docViewerPanel"
     data-doc-viewer-url="{{ doc_viewer_url|default('', true) }}"
     data-doc-viewer-online="{{ 'true' if doc_viewer_online else 'false' }}">
  <div class="doc-viewer-header">
    <h2>📄 ドキュメントビューア</h2>
    <div class="doc-viewer-header-actions">
      <div id="docViewerStatus"
           class="doc-viewer-status {{ 'doc-viewer-status--online' if doc_viewer_online else 'doc-viewer-status--offline' }}">
        <span class="doc-viewer-status__dot"></span>
        <span class="doc-viewer-status__label">{{ '接続済み' if doc_viewer_online else '未接続' }}</span>
      </div>
      <button type="button" id="docViewerReloadBtn" class="btn-reload">再読み込み</button>
    </div>
  </div>
  <div class="doc-viewer-wrapper">
    <iframe id="docViewerFrame" title="Document Viewer"
            src="{{ doc_viewer_url if doc_viewer_online else '' }}"
            loading="lazy"></iframe>
    <div id="docViewerOverlay" class="doc-viewer-overlay">
      {% if doc_viewer_online %}
        ドキュメントビューアを読み込み中です…
      {% else %}
        DocumentViewer サービスが見つかりませんでした。<br>
        起動後に「再読み込み」を押してください。
      {% endif %}
    </div>
  </div>
</div>
</div>

<div id="usbSyncOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal-body">
    <div class="modal-spinner" aria-hidden="true"></div>
    <h3>USB 同期中...</h3>
    <p id="usbSyncOverlayMessage">処理が完了するまで USB メモリを抜かないでください。</p>
  </div>
</div>

<!-- ===== メインスクリプト（タブ独立運用 & UI同期） ===== -->
<script>
  // WebSocket
  const socket = io();

  // 状態
  let scanActive = false;
  let currentUserUid = '';
  let currentToolUid = '';
  let activeTab = 'operations';

  // ドキュメントビューア（右パネル）制御
  (function setupDocViewer(){
    const panel = document.getElementById('docViewerPanel');
    if (!panel) return;

    const frame    = document.getElementById('docViewerFrame');
    const overlay  = document.getElementById('docViewerOverlay');
    const statusEl = document.getElementById('docViewerStatus');
    const statusLbl= statusEl ? statusEl.querySelector('.doc-viewer-status__label') : null;
    const reloadBtn= document.getElementById('docViewerReloadBtn');
    const docViewerUrl = (panel.dataset.docViewerUrl || '').trim();
    const initialOnline = panel.dataset.docViewerOnline === 'true';

    const setStatus = (state, label) => {
      if (!statusEl) return;
      statusEl.classList.remove('doc-viewer-status--online', 'doc-viewer-status--offline');
      statusEl.classList.add(state === 'online' ? 'doc-viewer-status--online' : 'doc-viewer-status--offline');
      if (statusLbl) statusLbl.textContent = label;
    };

    const showOverlay = (message) => {
      if (!overlay) return;
      overlay.innerHTML = message;
      overlay.classList.remove('is-hidden');
    };

    const hideOverlay = () => {
      if (!overlay) return;
      overlay.classList.add('is-hidden');
    };

    const reloadFrame = () => {
      if (!frame) return;
      if (!docViewerUrl) {
        showOverlay('DocumentViewer の URL が設定されていません。<br>環境変数 <code>DOCUMENT_VIEWER_URL</code> を確認してください。');
        setStatus('offline', '未設定');
        return;
      }
      showOverlay('ドキュメントビューアを読み込み中です…');
      setStatus('offline', '接続確認中…');
      const cacheBust = docViewerUrl.includes('?') ? '&' : '?';
      frame.src = `${docViewerUrl}${cacheBust}v=${Date.now()}`;
    };

    if (initialOnline && frame && docViewerUrl) {
      frame.src = docViewerUrl;
    } else if (!initialOnline) {
      setStatus('offline', '未接続');
    }

    if (reloadBtn) {
      reloadBtn.addEventListener('click', () => {
        reloadFrame();
      });
    }

    if (frame) {
      frame.addEventListener('load', () => {
        if (!frame.src) return;
        setStatus('online', '接続済み');
        hideOverlay();
      });
      frame.addEventListener('error', () => {
        setStatus('offline', '読み込み失敗');
        showOverlay('DocumentViewer が応答しません。サービスを起動してから再試行してください。');
      });
    }

    // オフライン状態でロード不可だった場合に備えリロードボタンで再試行
    panel.dataset.docViewerUrl = docViewerUrl;
  })();

  // タブ切り替え（借用/返却以外に移動したら UI を停止状態に戻す）
  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    const tabEl = document.getElementById(tabName);
    if (tabEl) tabEl.classList.add('active');
    if (event && event.target) event.target.classList.add('active');
    activeTab = tabName;

    // 借用/返却タブ以外に移動したら見た目も停止状態へ（誤解防止）
    if (tabName !== 'operations') {
      scanActive = false;
      if (typeof updateScanStatus === 'function') updateScanStatus(false);
    }

    if (tabName === 'registration' || tabName === 'master') loadToolNames();
    if (tabName === 'operations')   loadLoansData();
  }

  const usbOverlay = document.getElementById('usbSyncOverlay');
  const usbOverlayMessage = document.getElementById('usbSyncOverlayMessage');

  function showUsbOverlay(message){
    if (!usbOverlay) return;
    if (message && usbOverlayMessage) usbOverlayMessage.textContent = message;
    usbOverlay.classList.add('is-visible');
    document.body.classList.add('modal-locked');
  }

  function hideUsbOverlay(){
    if (!usbOverlay) return;
    usbOverlay.classList.remove('is-visible');
    document.body.classList.remove('modal-locked');
  }

  function formatUsbSyncSteps(data){
    if (!data || !Array.isArray(data.steps)){
      return (data && data.stdout) ? data.stdout : '(結果データがありません)';
    }
    const blocks = data.steps.map(step => {
      const title = step.title || step.name || '処理';
      const code = Number(step.returncode || 0);
      let statusLabel = code === 0 ? '成功' : '失敗';
      if (code === 127) statusLabel = '未実施';
      const lines = [`【${title}】 ${statusLabel} (code=${code})`];
      if (step.stdout) lines.push(`stdout:\n${step.stdout.trim()}`);
      if (step.stderr) lines.push(`stderr:\n${step.stderr.trim()}`);
      return lines.join('\n\n');
    });
    return blocks.join('\n\n');
  }

  async function runUsbSync(){
    const outputEl = document.getElementById('usbSyncOutput');
    showUsbOverlay('工具マスタとドキュメントを同期しています...');
    outputEl.textContent = '同期中...';
    try{
      const res = await fetch('/api/usb_sync',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({device:'/dev/sda1'})});
      const data = await res.json();
      const summary = formatUsbSyncSteps(data);
      outputEl.textContent = summary;
      if (data.status === 'success'){
        showMessage('transactionResult','USB同期が完了しました','success');
      } else {
        showMessage('transactionResult','USB同期でエラーが発生しました','danger');
      }
    }catch(err){
      outputEl.textContent = `error: ${err}`;
      showMessage('transactionResult','USB同期でエラーが発生しました','danger');
    } finally {
      hideUsbOverlay();
    }
  }

  // スキャン開始/停止：appScan ラッパ経由（loan 文脈）
  function startScan() {
    appScan.start('loan')
      .then(() => { scanActive = true;  updateScanStatus(true);  showMessage('scanMessage','スキャンを開始しました','info'); })
      .catch(()  => { showMessage('scanMessage','スキャン開始に失敗しました','danger'); });
  }
  function stopScan() {
    appScan.stop()
      .then(() => { scanActive = false; updateScanStatus(false); showMessage('scanMessage','スキャンを停止しました','warning'); })
      .catch(()=>{});
  }

  // 表示更新
  function updateScanStatus(active) {
    const s = document.getElementById('scanStatus');
    const startBtn = document.getElementById('startScanBtn');
    const stopBtn  = document.getElementById('stopScanBtn');
    if (active) {
      s.className='status-indicator status-active'; s.innerHTML='スキャン中';
      startBtn.disabled = true; stopBtn.disabled = false;
    } else {
      s.className='status-indicator status-inactive'; s.innerHTML='● 停止中';
      startBtn.disabled = false; stopBtn.disabled = true;
    }
  }
  function updateDisplays() {
    const u = document.getElementById('userDisplay');
    const t = document.getElementById('toolDisplay');
    u.textContent = currentUserUid || ''; t.textContent = currentToolUid || '';
    if (currentUserUid) { u.classList.add('completed'); } else { u.classList.remove('completed','active'); }
    if (currentToolUid) { t.classList.add('completed'); } else { t.classList.remove('completed'); currentUserUid ? t.classList.add('active') : t.classList.remove('active'); }
  }
  function showMessage(id, msg, type) {
    const el = document.getElementById(id);
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 5000);
  }

  // 一覧
  function loadLoansData() {
    fetch('/api/loans').then(r=>r.json()).then(data=>{
      const openBody=document.querySelector('#openLoansTable tbody'); openBody.innerHTML='';
      data.open_loans.forEach(v=>{
        const tr=openBody.insertRow();
        tr.dataset.loanId = v.id;
        tr.dataset.toolUid = v.tool_uid;
        tr.dataset.toolLabel = v.tool;
        const tdTool = tr.insertCell(0); tdTool.textContent=v.tool;
        tr.insertCell(1).textContent=v.borrower;
        const d=new Date(v.loaned_at);
        tr.insertCell(2).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        const actions=tr.insertCell(3);
        actions.className='table-actions';

        const btnReturn=document.createElement('button');
        btnReturn.className='btn-table btn-manual-return';
        btnReturn.textContent='手動返却';
        btnReturn.addEventListener('click',()=>manualReturnLoan(v.id, v.tool, v.borrower));

        const btnDelete=document.createElement('button');
        btnDelete.className='btn-table btn-delete';
        btnDelete.textContent='削除';
        btnDelete.addEventListener('click',()=>deleteLoanEntry(v.id, v.tool_uid, v.tool));

        actions.appendChild(btnReturn);
        actions.appendChild(btnDelete);
      });
      const histBody=document.querySelector('#historyTable tbody'); histBody.innerHTML='';
      data.history.forEach(h=>{
        const tr=histBody.insertRow(); tr.insertCell(0).textContent=h.action; tr.insertCell(1).textContent=h.tool; tr.insertCell(2).textContent=h.borrower;
        const d=new Date(h.returned_at || h.loaned_at); tr.insertCell(3).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      });
    });
  }

  async function manualReturnLoan(loanId, toolLabel, borrowerLabel){
    if(!confirm(`「${toolLabel}」を手動で返却済みにします。${borrowerLabel}からの貸出を閉じてもよろしいですか？`)) return;
    try{
      const res = await fetch(`/api/loans/${loanId}/manual_return`, {method:'POST'});
      const data = await res.json();
      if(res.ok && data.status==='success'){
        showMessage('transactionResult', data.message, 'info');
        loadLoansData();
      }else{
        showMessage('scanMessage', data.error || '返却処理に失敗しました', 'danger');
      }
    }catch(e){
      showMessage('scanMessage', `エラー: ${e}`, 'danger');
    }
  }

  async function deleteLoanEntry(loanId, toolUid, toolLabel){
    if(!confirm(`UID ${toolUid}\n「${toolLabel}」の貸出記録を削除します。履歴には残りません。よろしいですか？`)) return;
    try{
      const res = await fetch(`/api/loans/${loanId}`, {method:'DELETE'});
      const data = await res.json();
      if(res.ok && data.status==='success'){
        showMessage('transactionResult', data.message, 'warning');
        loadLoansData();
      }else{
        showMessage('scanMessage', data.error || '削除に失敗しました', 'danger');
      }
    }catch(e){
      showMessage('scanMessage', `エラー: ${e}`, 'danger');
    }
  }

  // リセット
  function resetState() {
    fetch('/api/reset',{method:'POST'}).then(r=>r.json()).then(()=>{
      currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage','🔄 リセット完了','info');
      document.getElementById('transactionResult').innerHTML='';
    });
  }

  // 登録タブ：単発スキャンAPI
  function scanForUser() {
    showMessage('userRegResult','スキャン中...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('userUidInput').value=d.uid; showMessage('userRegResult',`✅ UID: ${d.uid}`,'success'); }
      else{ showMessage('userRegResult','❌ 読み取りタイムアウト（タグを一度離して再タッチ）','danger'); }
    });
  }
  function scanForTool() {
    showMessage('toolRegResult','スキャン中...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('toolUidInput').value=d.uid; showMessage('toolRegResult',`✅ UID: ${d.uid}`,'success'); }
      else{ showMessage('toolRegResult','❌ 読み取りタイムアウト（タグを一度離して再タッチ）','danger'); }
    });
  }

  // 登録/マスタ
  function registerUser(){
    const uid=document.getElementById('userUidInput').value;
    const name=document.getElementById('userNameInput').value.trim();
    if(!uid||!name){ showMessage('userRegResult','❌ UID と 氏名 は必須です','danger'); return; }
    fetch('/api/register_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('userRegResult',d.message,'success'),document.getElementById('userNameInput').value='') : showMessage('userRegResult',d.error,'danger');});
  }
  function registerTool(){
    const uid=document.getElementById('toolUidInput').value;
    const name=document.getElementById('toolNameSelect').value;
    if(!uid||!name){ showMessage('toolRegResult','❌ UID と アイテム名 は必須です','danger'); return; }
    fetch('/api/register_tool',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('toolRegResult',d.message,'success'),document.getElementById('toolUidInput').value='',document.getElementById('toolNameSelect').value='') : showMessage('toolRegResult',d.error,'danger');});
  }
  function loadToolNames(){
    fetch('/api/tool_names').then(r=>r.json()).then(d=>{
      if(!d.names) return;
      const toolSel=document.getElementById('toolNameSelect'); toolSel.innerHTML='<option value="">（選択してください）</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; toolSel.appendChild(o); });
      const delSel=document.getElementById('deleteToolNameSelect'); delSel.innerHTML='<option value="">（選択してください）</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; delSel.appendChild(o); });
    });
  }
  function addToolName(){
    const name=document.getElementById('newToolNameInput').value.trim();
    if(!name){ showMessage('masterResult','❌ アイテム名を入力してください','danger'); return; }
    fetch('/api/add_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),document.getElementById('newToolNameInput').value='',loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }
  function deleteToolName(){
    const name=document.getElementById('deleteToolNameSelect').value;
    if(!name){ showMessage('masterResult','❌ 削除するアイテム名を選択してください','danger'); return; }
    if(!confirm(`「${name}」を削除してもよろしいですか？`)) return;
    fetch('/api/delete_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }

  // WebSocket受信：借用/返却タブのときだけ UI 反映（文脈ガード）
  socket.on('scan_update', function(data){
    const ctx = (window.appScan && window.appScan.get && window.appScan.get())
              || (document.getElementById('operations').classList.contains('active') ? 'loan' : 'register');
    if (ctx !== 'loan') return;

    currentUserUid = data.user_uid || currentUserUid;
    currentToolUid = data.tool_uid || currentToolUid;

    const u=document.getElementById('userDisplay');
    const t=document.getElementById('toolDisplay');
    if (data.user_name) u.textContent = data.user_name;
    if (data.tool_name) t.textContent = data.tool_name;

    updateDisplays();
    if (data.message) showMessage('scanMessage', data.message, 'info');
  });
  socket.on('transaction_complete', function(data){
    document.getElementById('userDisplay').textContent = data.user_name;
    document.getElementById('toolDisplay').textContent = data.tool_name;
    showMessage('transactionResult', data.message, data.action==='borrow'?'success':'info');
    loadLoansData();
  });
  socket.on('state_reset',  function(d){ currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage',d.message,'info'); });
  socket.on('error',        function(d){ showMessage('scanMessage', d.message,'danger'); });

  // タグ情報確認（登録タブ）
  function checkTagInfo(){
    showMessage('tagCheckResult','タグをスキャンしています...','info');
    fetch('/api/check_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){
        let type=d.type, msg=d.message, uid=d.uid, name=d.name, html='', cls='info';
        if(type==='user'){ cls='success'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>🆔 UID:</strong> ${uid}<br><strong>📝 登録タイプ:</strong> ユーザー<br><strong>👤 氏名:</strong> ${name}</div>`; }
        else if(type==='tool'){ cls='info'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>🆔 UID:</strong> ${uid}<br><strong>📝 登録タイプ:</strong> アイテム<br><strong>📦 アイテム名:</strong> ${name}</div>`; }
        else { cls='warning'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>🆔 UID:</strong> ${uid}<br><strong>📝 登録状況:</strong> 未登録<br><em>このタグはまだユーザーまたはアイテムとして登録されていません</em></div>`; }
        document.getElementById('tagCheckResult').innerHTML = `<div class="alert alert-${cls}">${msg}${html}</div>`;
      } else {
        showMessage('tagCheckResult','❌ 読み取りタイムアウト（タグを一度離して再タッチ）','danger');
      }
    });
  }

  // 初期化
  document.addEventListener('DOMContentLoaded', function(){ loadLoansData(); loadToolNames(); });
</script>

<!-- ===== 安全シャットダウン（動的・右下固定） ===== -->
<script>
(function(){
  if (document.getElementById('btnShutdownFixed')) return;
  const wrap=document.createElement('div');
  wrap.id='shutdownFixedWrap';
  wrap.style.cssText='position:fixed;right:16px;bottom:16px;z-index:2147483647;display:flex;flex-direction:column;align-items:flex-end;gap:6px;';
  const btn=document.createElement('button');
  btn.id='btnShutdownFixed';
  btn.textContent='安全にシャットダウン';
  btn.style.cssText='background:#d9534f;color:#fff;border:0;padding:10px 14px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer;font-size:14px;';
  const note=document.createElement('small');
  note.textContent='この端末（Raspberry Pi）上で開いている場合のみ実行できます';
  note.style.cssText='color:#333;background:rgba(255,255,255,.85);padding:2px 6px;border-radius:4px;text-align:right;';
  btn.addEventListener('click', async ()=>{
    if(!confirm('Raspberry Pi を安全にシャットダウンします。よろしいですか？\n処理開始後は数十秒で電源LEDが消灯します。')) return;
    try{
      const res=await fetch('/api/shutdown',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({confirm:true})});
      const j=await res.json().catch(()=>({}));
      if(res.ok && j.ok) alert('シャットダウンを開始しました。LED消灯を確認してから電源を抜いてください。');
      else alert('失敗: '+(j.error||res.status));
    }catch(e){ alert('エラー: '+e); }
  });
  wrap.appendChild(btn); wrap.appendChild(note); document.body.appendChild(wrap);
})();
</script>

<!-- ===== スキャン制御（タブ独立運用） ===== -->
<script>
  // 文脈付きスキャン制御（loan / register）
  window.appScan = (function(){
    let active=false, ctx=null;

    async function start(newCtx){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } ctx=newCtx; active=true; await fetch('/api/start_scan',{method:'POST'}); }
      catch(_){}
    }

    async function stop(){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } }
      catch(_){}
      // UI も停止状態に戻す（誤解防止）
      active=false; ctx=null;
      try{ window.scanActive=false; if (typeof updateScanStatus==='function') updateScanStatus(false); }catch(_){}
    }

    function get(){ return ctx; }

    // ページ離脱時も停止（できるだけ通知）
    window.addEventListener('beforeunload', ()=>{
      try{
        if(navigator.sendBeacon){
          const b=new Blob([], {type:'application/json'}); navigator.sendBeacon('/api/stop_scan', b);
        } else { fetch('/api/stop_scan',{method:'POST', keepalive:true}); }
      } catch(_){}
    });

    return { start, stop, get };
  })();

  // タブ切替時は必ず停止（.tab-button を検知対象に含める）
  document.addEventListener('click', (ev)=>{
    const tabLike = ev.target.closest('a[data-bs-toggle="tab"],[role="tab"],.tablinks,.tab-button,[data-tab-target],[data-tab]');
    if (tabLike) { window.appScan.stop(); }
  });
</script>
<!-- ===== /スキャン制御 ===== -->

</body>
</html>

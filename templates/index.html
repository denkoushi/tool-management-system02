<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>アイテム管理システム</title>
  <script src="/static/js/socket.io.js"></script>
  <script>
    (function(){
      const tokenRequired = {{ 'true' if api_token_required else 'false' }};
      const tokenHeader = {{ api_token_header|tojson }};
      if (!tokenRequired){
        return;
      }
      const originalFetch = window.fetch.bind(window);
      const storageKey = 'apiToken';

      const tokenStorage = {
        get(){
          try {
            return localStorage.getItem(storageKey) || sessionStorage.getItem(storageKey);
          } catch (_) {
            return sessionStorage.getItem(storageKey);
          }
        },
        set(value){
          try {
            localStorage.setItem(storageKey, value);
          } catch (_) {
            sessionStorage.setItem(storageKey, value);
          }
        },
        clear(){
          try { localStorage.removeItem(storageKey); } catch (_) {}
          sessionStorage.removeItem(storageKey);
        }
      };

      window.clearStoredApiToken = () => {
        tokenStorage.clear();
      };

      function obtainToken(){
        let token = tokenStorage.get();
        if (!token){
          token = window.prompt('管理用パスコードを入力してください');
          if (token){
            tokenStorage.set(token);
          }
        }
        return token;
      }

      window.fetch = function(url, options){
        const opts = options ? {...options} : {};
        const headers = new Headers(options && options.headers ? options.headers : undefined);
        const token = obtainToken();
        if (!token){
          return Promise.reject(new Error('APIトークンが設定されていません'));
        }
        headers.set(tokenHeader, token);
        opts.headers = headers;
        return originalFetch(url, opts).then(response => {
          if (response.status === 401){
            tokenStorage.clear();
            alert('APIトークンが無効です。再入力してください。');
          }
          return response;
        });
      };
    })();
  </script>
  

  <style>
  /* ===== Design tokens (light / modern / compact) ===== */
  :root{
    --bg: #f6f7f9;
    --surface: #ffffff;
    --surface-2: #f3f4f6;
    --border: #e5e7eb;
    --text: #111827;
    --muted: #6b7280;
    --brand: #2d6cdf;
    --brand-2: #0ea5e9;
    --success: #16a34a;
    --danger: #dc2626;
    --warning: #f59e0b;

    /* タイポ・サイズ（フルHD/21"想定の高密度） */
    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-md: 14px;
    --fs-lg: 16px;
    --fs-xl: 18px;
    --radius: 8px;

    /* コンポーネント密度 */
    --space-1: 4px;
    --space-2: 6px;
    --space-3: 8px;
    --space-4: 10px;
    --space-5: 12px;
  }

  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{width:100%;height:100%;overflow:hidden;}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: var(--bg); color: var(--text);
    display:flex; justify-content:flex-start; align-items:stretch;
  }
  body.modal-locked{overflow:hidden;}
  .app-layout{display:flex;width:100vw;height:100vh;background:var(--bg);}
  .left-pane{flex:0 0 50vw;height:100vh;display:flex;flex-direction:column;padding:var(--space-4);gap:var(--space-4);}
  .operation-shelf{flex:0 0 58%;display:flex;flex-direction:column;gap:var(--space-3);background:var(--surface);border-radius:var(--radius);box-shadow:0 10px 30px rgba(15,23,42,.12);padding:var(--space-3);overflow:hidden;}
  .operation-shelf .tab-content{background:transparent;padding:var(--space-2);}
  .operation-shelf .tabs{margin-bottom:var(--space-2);}
  .production-dashboard{flex:1;display:flex;flex-direction:column;background:var(--surface);border-radius:12px;box-shadow:0 10px 28px rgba(15,23,42,.14);overflow:hidden;border:1px solid rgba(148,163,184,.22);}
  .production-dashboard__header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);background:#111827;color:#f8fafc;gap:8px;}
  .production-dashboard__title{margin:0;font-size:13px;letter-spacing:.06em;font-weight:600;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
  .production-dashboard__meta{display:flex;align-items:center;gap:8px;font-size:11px;color:rgba(226,232,240,.72);}
  .production-dashboard__sections{flex:1;display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:10px;overflow:hidden;}
  .production-dashboard__section{display:flex;flex-direction:column;gap:6px;overflow:hidden;}
  .production-dashboard__section-header{display:flex;align-items:center;justify-content:space-between;gap:6px;font-size:11px;color:#334155;}
  .production-dashboard__section-title{margin:0;font-size:11px;font-weight:600;color:#0f172a;text-transform:uppercase;letter-spacing:.04em;}
  .production-dashboard__section-meta{font-size:10px;color:#64748b;}
  .dashboard-alert{padding:10px 12px;border-radius:6px;font-size:var(--fs-sm);line-height:1.5;border:1px solid rgba(248,113,113,.35);background:rgba(248,113,113,.12);color:#7f1d1d;}
  .dashboard-note{padding:8px 12px;border-radius:6px;font-size:var(--fs-xs);background:rgba(14,165,233,.12);color:#0369a1;border:1px solid rgba(56,189,248,.3);}
  .production-dashboard__table-wrapper{flex:1;overflow:auto;border:1px solid rgba(148,163,184,.2);border-radius:10px;background:#fff;}
  .production-dashboard__table{width:100%;border-collapse:collapse;font-size:12px;}
  .production-dashboard__table thead{background:rgba(241,245,249,.9);position:sticky;top:0;z-index:2;}
  .production-dashboard__table th,
  .production-dashboard__table td{padding:6px 8px;border-bottom:1px solid rgba(148,163,184,.2);text-align:left;}
  .production-dashboard__table th{font-weight:600;font-size:10px;letter-spacing:.06em;color:#475569;text-transform:uppercase;}
  .production-dashboard__table tbody tr:hover{background:rgba(30,64,175,.12);}
  .production-dashboard__table .is-primary{font-weight:600;color:#1d4ed8;}
  .production-dashboard__empty{padding:18px;border:1px dashed rgba(148,163,184,.4);border-radius:10px;text-align:center;font-size:12px;color:#64748b;background:rgba(148,163,184,.1);}
  .production-dashboard__table tr.is-highlight{background:rgba(14,165,233,.18) !important;box-shadow:inset 3px 0 0 var(--brand);}
  .production-dashboard__table tr.is-candidate{background:rgba(250,204,21,.18) !important;}
  .maintenance-card{margin-bottom:20px;padding:16px;background:#f8f9fa;border-radius:8px;border:1px solid #e5e7eb;}
  .station-chip-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
  .station-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;background:rgba(37,99,235,.12);color:#1d4ed8;border:1px solid rgba(37,99,235,.2);border-radius:999px;font-size:var(--fs-xs);}
  .station-chip button{background:none;border:0;color:inherit;font-size:12px;cursor:pointer;padding:0 4px;line-height:1;}
  .station-chip button:hover{color:#dc2626;}
  .station-meta{margin-top:6px;font-size:var(--fs-xs);color:var(--muted);}
  .future-panel{
    flex:1;
    background:#0f172a;
    display:flex;
    flex-direction:column;
    position:relative;
    overflow:hidden;
  }
  .future-tabs{
    display:flex;
    background:linear-gradient(135deg, rgba(37,99,235,.82) 0%, rgba(14,165,233,.78) 100%);
    border-bottom:1px solid rgba(148,163,184,.25);
    box-shadow:0 6px 18px rgba(15,23,42,.3);
    z-index:2;
  }
  .future-tab-button{
    flex:1;
    appearance:none;
    background:none;
    border:0;
    color:rgba(241,245,249,.76);
    font-size:13px;
    font-weight:600;
    letter-spacing:.04em;
    padding:10px 14px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    position:relative;
    transition:background .2s ease,color .2s ease;
  }
  .future-tab-button.active{
    color:#fff;
    background:rgba(15,23,42,.2);
  }
  .future-tab-button .tab-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:20px;
    height:20px;
    padding:0 6px;
    background:rgba(15,23,42,.35);
    border-radius:999px;
    font-size:11px;
    font-weight:700;
    color:#e0f2fe;
  }
  .future-panel-contents{
    flex:1;
    display:flex;
    flex-direction:column;
    position:relative;
  }
  .future-panel-body{
    display:none;
    flex:1;
    position:relative;
  }
  .future-panel-body.active{
    display:flex;
  }
  .future-panel-body--doc{
    padding:64px 0 12px;
  }
  .future-panel-body--doc .doc-viewer-wrapper{
    flex:1;
  }

  .doc-viewer-header{position:absolute;top:12px;left:12px;right:12px;display:flex;align-items:center;justify-content:space-between;background:rgba(15,23,42,.88);padding:8px 14px;border-radius:10px;border:1px solid rgba(148,163,184,.28);gap:12px;}
  .doc-viewer-status-group{display:flex;align-items:center;gap:8px;min-width:0;}
  .doc-viewer-status{padding:2px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-size:12px;font-weight:600;color:#f8fafc;background:rgba(34,197,94,.2);display:inline-flex;align-items:center;gap:6px;letter-spacing:.04em;white-space:nowrap;}
  .doc-viewer-chip{padding:2px 10px;border-radius:999px;background:rgba(148,163,184,.25);color:#e2e8f0;font-size:12px;letter-spacing:.04em;white-space:nowrap;display:inline-flex;align-items:center;gap:4px;transition:background .2s ease,color .2s ease;}
  .doc-viewer-chip[data-state="idle"], .doc-viewer-status[data-state="idle"]{background:rgba(56,189,248,.25);color:#bae6fd;}
  .doc-viewer-chip[data-state="viewer"], .doc-viewer-status[data-state="viewer"]{background:rgba(16,185,129,.28);color:#bbf7d0;}
  .doc-viewer-chip[data-state="searching"], .doc-viewer-status[data-state="searching"]{background:rgba(250,204,21,.28);color:#fef08a;}
  .doc-viewer-chip[data-state="error"], .doc-viewer-status[data-state="error"]{background:rgba(248,113,113,.28);color:#fecaca;}
  .doc-viewer-chip--part{max-width:260px;overflow:hidden;text-overflow:ellipsis;}
  .doc-viewer-chip--part[data-empty="true"]{color:rgba(226,232,240,.6);background:rgba(148,163,184,.15);}
  .doc-viewer-header-actions{display:flex;align-items:center;gap:8px;}
  .doc-viewer-status__dot{width:6px;height:6px;border-radius:50%;background:currentColor;display:block;}
  .doc-viewer-status--online{color:#bbf7d0;border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.18);}
  .doc-viewer-status--offline{color:#fecaca;border-color:rgba(248,113,113,.45);background:rgba(248,113,113,.18);}
  .btn-reload{background:none;border:1px solid rgba(148,163,184,.35);color:#e2e8f0;font-size:12px;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .15s, border .15s;}
  .btn-reload:hover{background:rgba(148,163,184,.18);border-color:rgba(148,163,184,.55);}
  .doc-viewer-wrapper{flex:1;position:relative;}
  #docViewerFrame{width:100%;height:100%;border:0;background:#0f172a;}
  .doc-viewer-overlay{position:absolute;inset:6px;border-radius:var(--radius);background:rgba(15,23,42,.72);color:#f8fafc;display:flex;align-items:center;justify-content:center;text-align:center;padding:12px;font-size:var(--fs-sm);line-height:1.4;box-shadow:0 12px 32px rgba(15,23,42,.35);}
  .doc-viewer-overlay.is-hidden{display:none;}

  .part-locations-shell{flex:1;display:flex;flex-direction:column;gap:18px;padding:18px 22px;color:#e2e8f0;}
  .part-locations-header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;}
  .part-locations-title{margin:0;font-size:17px;font-weight:700;color:#f8fafc;letter-spacing:.05em;}
  .part-locations-subtitle{margin:0;font-size:12px;color:rgba(226,232,240,.7);}
  .part-locations-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .part-location-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.35);font-size:12px;color:#e2e8f0;letter-spacing:.03em;transition:background .2s ease,color .2s ease;}
  .part-location-chip[data-state="live"]{background:rgba(34,197,94,.25);color:#bbf7d0;border-color:rgba(34,197,94,.45);}
  .part-location-chip[data-state="offline"]{background:rgba(248,113,113,.25);color:#fecaca;border-color:rgba(248,113,113,.45);}
  .part-location-chip[data-state="loading"]{background:rgba(250,204,21,.25);color:#fef08a;border-color:rgba(250,204,21,.45);}
  .part-locations-table-wrapper{flex:1;overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.65);box-shadow:inset 0 1px 6px rgba(15,23,42,.4);}
  .part-locations-table{width:100%;border-collapse:collapse;font-size:12px;color:#e2e8f0;}
  .part-locations-table thead{background:rgba(10,20,35,.74);backdrop-filter:blur(6px);position:sticky;top:0;z-index:1;}
  .part-locations-table th{font-weight:600;text-transform:uppercase;letter-spacing:.06em;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.35);text-align:left;}
  .part-locations-table td{padding:7px 10px;border-bottom:1px solid rgba(148,163,184,.2);vertical-align:middle;}
  .part-locations-table tbody tr:nth-child(even){background:rgba(15,23,42,.32);}
  .part-locations-table tbody tr.is-flash{animation:flash-row 2s ease-out;}
  @keyframes flash-row{0%{background:rgba(34,197,94,.45);}100%{background:transparent;}}
  .part-locations-empty{padding:18px;border:1px dashed rgba(148,163,184,.45);border-radius:12px;text-align:center;font-size:13px;color:rgba(226,232,240,.78);background:rgba(14,23,42,.6);}
  .part-locations-message{min-height:22px;}

  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.62);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .modal-overlay.is-visible{display:flex;}
  .modal-body{
    background:#0f172a;
    color:#e2e8f0;
    padding:32px 40px;
    border-radius:12px;
    box-shadow:0 24px 48px rgba(15,23,42,.45);
    width:min(420px, 90vw);
    text-align:center;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .modal-body h3{font-size:18px; margin:0; font-weight:700;}
  .modal-body p{margin:0; font-size:14px; color:#cbd5f5;}
  .modal-spinner{
    width:42px;
    height:42px;
    border-radius:50%;
    border:4px solid rgba(226,232,240,0.25);
    border-top-color:#38bdf8;
    margin:0 auto;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}

  /* Tabs */
  .tabs{display:flex;background:linear-gradient(135deg,var(--brand) 0%,var(--brand-2) 100%);box-shadow:0 1px 4px rgba(17,24,39,.12);}
  .tab-button{flex:1;padding:var(--space-3);background:none;border:none;cursor:pointer;font-size:var(--fs-sm);font-weight:600;color:rgba(255,255,255,.85);border-bottom:2px solid transparent;transition:.2s;letter-spacing:.02em;min-width:0;}
  .tab-toggle-history{flex:0 0 88px;}
  .tab-button.active{background:rgba(255,255,255,.16);color:#fff;border-bottom-color:#fff;}

  .tab-content{display:none;padding:var(--space-3);flex:1;overflow-y:auto;}
  .tab-content.active{display:flex; flex-direction:column;}

  /* Operations (Borrow/Return) */
  #operations{padding: var(--space-4);}
  #operations h2{font-size: var(--fs-lg); font-weight:700; color: var(--text);}

  .operation-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:var(--space-3);
    padding-bottom:var(--space-2);
    border-bottom:1px solid var(--border);
    margin-bottom:var(--space-3);
  }
  .operation-header h2{margin:0;font-size:var(--fs-md);letter-spacing:.02em;}
  .operation-controls{display:flex;align-items:center;gap:var(--space-2);flex-shrink:0;}

  /* Buttons: compact */
  .button-row{display:flex;gap:var(--space-2);margin-bottom:var(--space-3);flex-wrap:wrap;}
  .btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:var(--fs-sm);font-weight:600;transition:.15s;display:flex;align-items:center;justify-content:center;gap:4px;min-height:30px;}
  .btn-primary{background:var(--brand); color:#fff;}
  .btn-primary:active{transform:scale(.98);}
  .btn-secondary{background:#6b7280; color:#fff;}
  .btn-danger{background:var(--danger); color:#fff;}
  .btn:disabled{opacity:.5; cursor:not-allowed;}

  .btn-table{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    font-size: var(--fs-sm);
    font-weight:700;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
    min-height:30px;
    transition:.15s;
  }
  .btn-table:hover{background:var(--surface-2);} 
  .btn-manual-return{border-color:var(--brand); color:var(--brand);} 
  .btn-manual-return:hover{background:#eef6ff;}
  .btn-delete{border-color:var(--danger); color:var(--danger);} 
  .btn-delete:hover{background:#fef2f2;}

  /* Status pill */
  .status-indicator{
    display:inline-flex; align-items:center; gap:6px;
    padding: 2px 10px; border-radius: 999px;
    font-size: var(--fs-sm); font-weight:700; transition:.2s;
    background: var(--surface-2); color: var(--muted);
    border:1px solid var(--border);
  }
  .status-active{
    background: #dcfce7; color:#166534; border-color:#bbf7d0;
    animation: pulse 2s infinite;
  }
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.85}}

  /* Scan progress: more compact */
  .scan-progress{display:flex;gap:var(--space-2);margin:var(--space-3) 0;background:var(--surface-2);border-radius:var(--radius);padding:var(--space-2);border:1px solid var(--border);}
  .scan-step{flex:1;}
  .scan-step label{display:block;font-size:var(--fs-xs);color:var(--muted);margin-bottom:3px;font-weight:600;letter-spacing:.01em;}
  .scan-display{background:#fff;border:1px solid var(--border);border-radius:6px;padding:4px 6px;font-size:var(--fs-md);min-height:28px;display:flex;align-items:center;overflow:hidden;text-overflow:ellipsis;word-break:break-all;}
  .scan-display.active{border-color: var(--brand); background:#eef6ff;}
  .scan-display.completed{border-color:#22c55e; background:#ecfdf5;}

  /* Alerts */
  .alert{padding:8px 12px; border-radius:6px; margin:8px 0; font-size: var(--fs-md);}
  .alert-success{background:#ecfdf5; border:1px solid #bbf7d0; color:#166534;}
  .alert-danger{background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d;}
  .alert-info{background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a;}
  .alert-warning{background:#fffbeb; border:1px solid #fde68a; color:#7c2d12;}

  .section-divider{border:none; border-top:2px solid var(--border); margin: 12px 0 10px;}
  .section-title{font-size: var(--fs-md); font-weight:700; color:#374151; margin-bottom:8px; display:flex; align-items:center; gap:6px;}

  /* Tables: compact/high-density with sticky header */
  .data-table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--border);border-radius:8px;overflow:hidden;font-size:12px;}
  .data-table thead th{position:sticky;top:0;z-index:1;background:#f8fafc;color:#334155;padding:5px 6px;text-align:left;font-weight:700;border-bottom:1px solid var(--border);}
  .data-table tbody td{padding:4px 6px;border-bottom:1px solid #f1f5f9;line-height:1.1;}
  .data-table tbody tr:hover{background:#f9fafb;}
  .table-actions{display:flex; gap:6px; flex-wrap:wrap;}

  /* Lists layout: more space for tables without変更多段 */
  .bottom-tables{flex:1; display:flex; flex-direction:column; gap: 8px; overflow:hidden;}
  .table-section{flex:1; display:flex; flex-direction:column; min-height:0;}
  .scrollable-section{flex:1; overflow:auto; -webkit-overflow-scrolling:touch;}

  /* Forms compact */
  #registration, #master{padding:10px;overflow-y:auto;}
  #registration h2, #master h2{font-size:var(--fs-lg);margin-bottom:8px;color:#111827;}
  #registration h3, #master h3{font-size:var(--fs-md);margin:10px 0 6px;color:#1f2937;}

  .input-row{display:flex;gap:8px;margin-bottom:10px;align-items:end;}
  .input-group{flex:1;}
  .input-group label{display:block;margin-bottom:4px;font-weight:600;color:#374151;font-size:var(--fs-xs);}
  .form-control{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:var(--fs-sm);transition:border-color .15s,box-shadow .15s;}
  .form-control:focus{outline:none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(45,108,223,.12);}

  @media (orientation:portrait){
    .operation-header{flex-direction:column; align-items:flex-start; gap:6px;}
    .status-indicator{align-self:flex-end;}
    .button-row{flex-wrap:wrap;}
  }
</style>


  
</head>
<body>
<div class="app-layout">
  <div class="left-pane">
    <section class="production-dashboard" aria-labelledby="productionDashboardTitle">
      <div class="production-dashboard__header">
        <h2 id="productionDashboardTitle" class="production-dashboard__title">工程別 生産計画</h2>
        <div class="production-dashboard__meta">
          {% if production_view.plan_updated_at %}<span>生産計画: <strong>{{ production_view.plan_updated_at }}</strong></span>{% endif %}
          {% if production_view.standard_updated_at %}<span>標準工数: <strong>{{ production_view.standard_updated_at }}</strong></span>{% endif %}
        </div>
      </div>
      <div class="production-dashboard__body">
        <div class="production-dashboard__alerts">
          {% if production_view.plan_error %}
            <div class="dashboard-alert">{{ production_view.plan_error }}</div>
          {% elif production_view.standard_error %}
            <div class="dashboard-alert">{{ production_view.standard_error }}</div>
          {% else %}
            <div class="production-dashboard__note">USB同期後に最新 CSV を配置すると即時反映されます</div>
          {% endif %}
        </div>
        <div id="productionHighlightMessage" class="production-dashboard__note" style="display:none;"></div>
        <div class="production-dashboard__sections">
          <div class="production-dashboard__section">
            <div class="production-dashboard__section-header">
              <h3 class="production-dashboard__section-title">生産計画</h3>
              {% if production_view.plan_updated_at %}<span class="production-dashboard__section-meta">更新: {{ production_view.plan_updated_at }}</span>{% endif %}
            </div>
            {% if production_view.plan_entries %}
              <div class="production-dashboard__table-wrapper">
                <table class="production-dashboard__table" id="productionPlanTable">
                  <thead>
                    <tr>
                      <th style="width:100px;">納期</th>
                      <th style="width:80px;">製番</th>
                      <th style="width:95px;">部品番号</th>
                      <th>部品名</th>
                      <th style="width:80px;">工程名</th>
                      <th style="width:60px;">個数</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in production_view.plan_entries %}
                      <tr data-part="{{ row['部品番号'] }}" data-order="{{ row['標準工数_製造オーダー']|default('', true) }}" data-process="{{ row['工程名'] }}">
                        <td class="is-primary">{{ row['納期'] }}</td>
                        <td>{{ row['製番'] }}</td>
                        <td>{{ row['部品番号'] }}</td>
                        <td>{{ row['部品名'] }}</td>
                        <td>{{ row['工程名'] }}</td>
                        <td style="text-align:right;">{{ row['個数'] }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% elif not production_view.plan_error %}
              <div class="production-dashboard__empty">生産計画のデータがありません。USB に CSV を配置して同期してください。</div>
            {% endif %}
          </div>

          <div class="production-dashboard__section">
            <div class="production-dashboard__section-header">
              <h3 class="production-dashboard__section-title">標準工数</h3>
              {% if production_view.standard_updated_at %}<span class="production-dashboard__section-meta">更新: {{ production_view.standard_updated_at }}</span>{% endif %}
            </div>
            {% if production_view.standard_entries %}
              <div class="production-dashboard__table-wrapper">
                <table class="production-dashboard__table" id="standardTimesTable">
                  <thead>
                    <tr>
                      <th style="width:120px;">部品名</th>
                      <th style="width:95px;">部品番号</th>
                      <th style="width:90px;">工程名</th>
                      <th style="width:90px;">標準工数</th>
                      <th style="width:120px;">製造オーダー</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in production_view.standard_entries %}
                      <tr data-part="{{ row['部品番号'] }}" data-order="{{ row['製造オーダー番号']|default('', true) }}" data-process="{{ row['工程名'] }}">
                        <td>{{ row['部品名'] }}</td>
                        <td>{{ row['部品番号'] }}</td>
                        <td>{{ row['工程名'] }}</td>
                        <td style="text-align:right;">{{ row['機械標準工数'] }}</td>
                        <td>{{ row['製造オーダー番号'] }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% elif not production_view.standard_error %}
              <div class="production-dashboard__empty">標準工数のデータがありません。USB に CSV を配置して同期してください。</div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
    <div class="operation-shelf">
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('operations')">借用/返却</button>
    <button class="tab-button" onclick="showTab('registration')">タグ登録</button>
    <button class="tab-button" onclick="showTab('master')">マスタ</button>
    <button class="tab-button" onclick="showTab('maintenance')">メンテ</button>
    <button class="tab-button tab-toggle-history" onclick="toggleHistory()">履歴</button>
  </div>

  <!-- 借用/返却 -->
  <div id="operations" class="tab-content active">
    <div class="operation-header">
      <h2>①ユーザー → ②アイテム の順にスキャン</h2>
      <div class="operation-controls">
        <div class="button-row" style="margin:0;">
          <button class="btn btn-primary" id="startScanBtn" onclick="startScan()">スキャン開始</button>
          <button class="btn btn-secondary" id="stopScanBtn" onclick="stopScan()" disabled>停止</button>
          <button class="btn btn-danger" onclick="resetState()">リセット</button>
        </div>
        <span id="scanStatus" class="status-indicator status-inactive">● 停止中</span>
      </div>
    </div>

    <div class="scan-progress">
      <div class="scan-step">
        <label>①ユーザー</label>
        <div id="userDisplay" class="scan-display"></div>
      </div>
      <div class="scan-step">
        <label>②アイテム</label>
        <div id="toolDisplay" class="scan-display"></div>
      </div>
    </div>

    <div id="scanMessage"></div>
    <div id="transactionResult"></div>

    <hr class="section-divider">

    <div class="bottom-tables">
      <div class="table-section">
        <div class="section-title">📋 貸出中</div>
        <div class="scrollable-section">
          <table class="data-table" id="openLoansTable">
            <thead><tr><th>アイテム</th><th>借用者</th><th>借用日時</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="table-section" id="historySection" style="margin-top:min(10px,2vh);display:none;">
        <div class="section-title">履歴</div>
        <div class="scrollable-section">
          <table class="data-table" id="historyTable">
            <thead><tr><th>区分</th><th>アイテム</th><th>ユーザー</th><th>日時</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- タグ登録 -->
  <div id="registration" class="tab-content">
    <h2>🔖 タグ登録</h2>

    <div style="margin-bottom:16px; padding:12px 14px; background:#f0f4ff; border-radius:8px; border-left:3px solid #17a2b8;">
      <h3>🔍 タグ情報確認</h3>
      <p style="margin-bottom:8px; color:#64748b; font-size:12px;">NFCタグをスキャンして、現在の登録状況を確認できます</p>
      <div class="input-group" style="margin-bottom:8px;">
        <button class="btn btn-primary" onclick="checkTagInfo()" style="background:#17a2b8; border-color:#17a2b8;">🔍 タグ情報を確認</button>
      </div>
      <div id="tagCheckResult"></div>
    </div>

    <div style="display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start;">
      <!-- ユーザー登録 -->
      <div style="flex:1; min-width:240px;">
        <h3>👤 ユーザー登録</h3>
        <div class="input-group" style="margin-bottom:10px;">
          <button class="btn btn-primary" onclick="scanForUser()">スキャンしてUID取得</button>
        </div>
        <div class="input-group" style="margin-bottom:10px;">
          <label>UID（自動入力）</label>
          <input type="text" id="userUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:10px;">
          <label>氏名（例：山田太郎）</label>
          <input type="text" id="userNameInput" class="form-control" placeholder="山田太郎">
        </div>
        <button class="btn btn-primary" onclick="registerUser()">💾 登録 / 更新（ユーザー）</button>
        <div id="userRegResult"></div>
      </div>

      <!-- アイテム登録 -->
      <div style="flex:1; min-width:240px;">
        <h3>📦 アイテム登録</h3>
        <div class="input-group" style="margin-bottom:10px;">
          <button class="btn btn-primary" onclick="scanForTool()">スキャンしてUID取得</button>
        </div>
        <div class="input-group" style="margin-bottom:10px;">
          <label>UID（自動入力）</label>
          <input type="text" id="toolUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:10px;">
          <label>アイテム名（マスタから選択）</label>
          <select id="toolNameSelect" class="form-control">
            <option value="">（選択してください）</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="registerTool()">💾 登録 / 更新（アイテム）</button>
        <div id="toolRegResult"></div>
      </div>
    </div>
  </div>

  <!-- アイテム名マスタ -->
  <div id="master" class="tab-content">
    <h2>📚 アイテム名マスタ</h2>

    <div class="input-row">
      <div class="input-group">
        <label>アイテム名を追加</label>
        <input type="text" id="newToolNameInput" class="form-control" placeholder="新しいアイテム名">
      </div>
      <button class="btn btn-primary" onclick="addToolName()">➕ 追加</button>
    </div>

    <div id="masterResult"></div>

    <h3>現在のアイテム名一覧</h3>
    <div class="input-row">
      <div class="input-group">
        <label>削除するアイテム名を選択</label>
        <select id="deleteToolNameSelect" class="form-control">
          <option value="">（選択してください）</option>
        </select>
      </div>
      <button class="btn btn-danger" onclick="deleteToolName()">🗑️ 削除</button>
  </div>
</div>
  
  <!-- メンテナンス -->
  <div id="maintenance" class="tab-content">
    <h2>🛠 メンテナンス</h2>
    <div class="maintenance-card">
      <h3>USB 同期（手動）</h3>
      <p style="color:#6b7280; font-size:14px;">ラベル <code>TOOLMASTER</code> の USB メモリを挿入してから実行すると、マスターデータ（工具名・ユーザー・タグ紐づけ）を同期します。</p>
      <div class="button-row"><label style="font-size:13px;color:#6b7280;">USB 同期（手動）：ラベル <code>TOOLMASTER</code> の USB メモリを挿入してから実行してください。</label></div>
      <div class="button-row" style="gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="runUsbSync()">USB 同期を実行</button>
        <pre id="usbSyncOutput" style="background:#111827; color:#e5e7eb; padding:8px 10px; border-radius:6px; margin:0; font-size:11px; min-width:200px; max-width:320px; max-height:120px; overflow:auto; white-space:pre-wrap;">(まだ実行していません)</pre>
      </div>
    </div>

    <div class="maintenance-card">
      <h3>工程設定</h3>
      <p style="color:#6b7280; font-size:14px;">ラズパイが属する工程を設定します。変更すると DocumentViewer や生産計画の候補表示に反映されます。</p>
      <div class="input-row">
        <div class="input-group">
          <label>現在の工程</label>
          <select id="stationProcessSelect" class="form-control">
            <option value="">（未設定）</option>
            {% for name in station_config.available %}
              <option value="{{ name }}" {% if station_config.process == name %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <button class="btn btn-primary" onclick="saveStationProcess()">💾 保存</button>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label>工程候補を追加</label>
          <input type="text" id="stationNewProcessInput" class="form-control" placeholder="例：研磨">
        </div>
        <button class="btn btn-secondary" onclick="addStationProcess()">候補に追加</button>
      </div>

      <div class="station-chip-list" id="stationAvailableList"></div>
      <div class="station-meta" id="stationConfigMeta">
        {% if station_config.updated_at %}
          最終更新: {{ station_config.updated_at }}
        {% else %}
          station.json はまだ保存されていません（環境変数または未設定）
        {% endif %}
        <br>設定ファイル: {{ station_config.path }}
        {% if api_station_id %}
          <br>APIトークン station_id: {{ api_station_id }}
        {% endif %}
      </div>
      <div class="station-meta" id="stationConfigNotice" style="display:none;"></div>
      <div id="stationConfigMessage"></div>
      {% if api_token_error %}
        <div class="dashboard-alert">API トークンの読み込みでエラーが発生しています: {{ api_token_error }}</div>
      {% endif %}
    </div>

    <div class="maintenance-card">
      <h3>API トークン管理</h3>
      <p style="color:#6b7280; font-size:14px;">ステーションごとの API トークンを発行・一覧・無効化できます。新しいトークンは即座に有効になります（古いトークンは無効化してください）。</p>

      <div class="button-row" style="margin-bottom:6px;">
        <button class="btn btn-secondary" onclick="loadApiTokens()">一覧を更新</button>
      </div>

      <div class="scrollable" style="max-height:200px; overflow:auto; border:1px solid #e2e8f0; border-radius:8px;">
        <table class="production-dashboard__table" id="apiTokenTable">
          <thead>
            <tr>
              <th style="width:100px;">ステーション</th>
              <th style="width:120px;">発行日時</th>
              <th style="width:120px;">無効化</th>
              <th>メモ</th>
              <th style="width:70px;">状態</th>
              <th style="width:130px;">トークン</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="apiTokenMessage" style="margin-top:8px;"></div>

      <h4 style="margin-top:12px;">新しいトークンを発行</h4>
      <div class="input-row">
        <div class="input-group">
          <label>station_id</label>
          <input type="text" id="apiTokenStationInput" class="form-control" placeholder="例: CUTTING-01">
        </div>
        <div class="input-group">
          <label>メモ（任意）</label>
          <input type="text" id="apiTokenNoteInput" class="form-control" placeholder="端末の設置場所など">
        </div>
      </div>
      <div class="input-row" style="align-items:center;">
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="apiTokenKeepExisting"> 既存トークンを無効化せず追加する
        </label>
        <button class="btn btn-primary" onclick="issueApiToken()">新しいトークンを発行</button>
      </div>
      <pre id="apiTokenIssued" style="display:none;background:#1f2937;color:#f8fafc;padding:10px;border-radius:8px;font-size:12px;overflow:auto;"></pre>

      <h4 style="margin-top:12px;">トークンを無効化</h4>
      <div class="input-row">
        <div class="input-group">
          <label>トークン文字列で無効化</label>
          <input type="text" id="apiTokenRevokeTokenInput" class="form-control" placeholder="発行したトークン文字列（任意）">
        </div>
        <div class="input-group">
          <label>station_id で無効化</label>
          <input type="text" id="apiTokenRevokeStationInput" class="form-control" placeholder="例: CUTTING-01">
        </div>
      </div>
      <div class="input-row" style="align-items:center;">
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="apiTokenRevokeAll"> すべてのトークンを無効化する
        </label>
        <button class="btn btn-danger" onclick="revokeApiToken()">無効化を実行</button>
      </div>
    </div>
  </div>
    </div>
  </div>
  <div class="future-panel" id="rightPanel">
    <div class="future-tabs" role="tablist">
      <button type="button" class="future-tab-button active" data-target="docViewerPanel">要領書</button>
      <button type="button" class="future-tab-button" data-target="partLocationsPanel">
        所在一覧
        <span class="tab-badge" id="partLocationsTabBadge">{{ part_locations|length }}</span>
      </button>
    </div>
    <div class="future-panel-contents">
      <section class="future-panel-body future-panel-body--doc active"
               id="docViewerPanel"
               data-doc-viewer-url="{{ doc_viewer_url|default('', true) }}"
               data-doc-viewer-online="{{ 'true' if doc_viewer_online else 'false' }}"
               data-station-process="{{ station_config.process|default('', true) }}">
        <div class="doc-viewer-header">
          <div class="doc-viewer-status-group">
            <div id="docViewerStatus"
                 class="doc-viewer-status {{ 'doc-viewer-status--online' if doc_viewer_online else 'doc-viewer-status--offline' }}">
              <span class="doc-viewer-status__dot"></span>
              <span class="doc-viewer-status__label">{{ '接続済み' if doc_viewer_online else '未接続' }}</span>
            </div>
            <span id="docViewerStateChip" class="doc-viewer-chip">状態: 未表示</span>
            <span id="docViewerPartChip" class="doc-viewer-chip doc-viewer-chip--part" data-empty="true">部品番号: -</span>
          </div>
          <div class="doc-viewer-header-actions">
            <button type="button" id="docViewerReloadBtn" class="btn-reload">再読み込み</button>
            <button type="button" id="docViewerReturnBtn" class="btn-reload">待機画面に戻る</button>
          </div>
        </div>
        <div class="doc-viewer-wrapper">
          <iframe id="docViewerFrame" title="Document Viewer"
                  src="{{ doc_viewer_url if doc_viewer_online else '' }}"
                  loading="lazy"></iframe>
          <div id="docViewerOverlay" class="doc-viewer-overlay">
            {% if doc_viewer_online %}
              読み込み中…
            {% else %}
              DocumentViewer サービスが見つかりません。<br>
              起動後に「再読み込み」を押してください。
            {% endif %}
          </div>
        </div>
      </section>
      <section class="future-panel-body future-panel-body--locations" id="partLocationsPanel">
        <div class="part-locations-shell">
          <div class="part-locations-header">
            <div>
              <h3 class="part-locations-title">部品所在一覧</h3>
              <p class="part-locations-subtitle">ハンディリーダの最新スキャンをリアルタイムに反映します</p>
            </div>
            <div class="part-locations-meta">
              <span id="partLocationSocketStatus" class="part-location-chip" data-state="loading">接続確認中…</span>
              <span id="partLocationCount" class="part-location-chip">件数: {{ part_locations|length }}</span>
              <span id="partLocationLastUpdated" class="part-location-chip">最終更新: -</span>
              <button type="button" id="partLocationRefreshBtn" class="btn-reload">最新を取得</button>
            </div>
          </div>
          <div id="partLocationsMessage" class="part-locations-message"></div>
          <div class="part-locations-table-wrapper">
            <table class="part-locations-table" id="partLocationsTable">
              <thead>
                <tr>
                  <th style="width:28%;">部品番号</th>
                  <th style="width:22%;">棚位置</th>
                  <th style="width:16%;">デバイス</th>
                  <th style="width:17%;">スキャン時刻</th>
                  <th style="width:17%;">更新時刻</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="partLocationsEmpty" class="part-locations-empty">
            まだ所在データが登録されていません。ハンディリーダからスキャンを送信すると表示されます。
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script id="initialPartLocations" type="application/json">{{ part_locations|tojson|safe }}</script>

<div id="usbSyncOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal-body">
    <div class="modal-spinner" aria-hidden="true"></div>
    <h3>USB 同期中...</h3>
    <p id="usbSyncOverlayMessage">処理が完了するまで USB メモリを抜かないでください。</p>
  </div>
</div>

<!-- ===== メインスクリプト（タブ独立運用 & UI同期） ===== -->
<script>
  // WebSocket
  const socket = io();

  const dateTimeFormatter = new Intl.DateTimeFormat('ja-JP', { dateStyle: 'short', timeStyle: 'medium' });
  const partLocationElements = {
    panel: document.getElementById('partLocationsPanel'),
    tableBody: document.querySelector('#partLocationsTable tbody'),
    empty: document.getElementById('partLocationsEmpty'),
    message: document.getElementById('partLocationsMessage'),
    count: document.getElementById('partLocationCount'),
    lastUpdated: document.getElementById('partLocationLastUpdated'),
    refreshBtn: document.getElementById('partLocationRefreshBtn'),
    socketStatus: document.getElementById('partLocationSocketStatus'),
    tabBadge: document.getElementById('partLocationsTabBadge'),
  };
  const partLocationState = new Map();
  let partLocationMessageTimer = null;
  let partLocationHighlightTimer = null;
  let partLocationLastHighlight = null;

  const cssEscape = window.CSS && typeof window.CSS.escape === 'function'
    ? window.CSS.escape.bind(window.CSS)
    : (value) => String(value).replace(/[^a-zA-Z0-9_-]/g, '\\$&');

  function parseTimestamp(value){
    if (!value) return null;
    const dt = new Date(value);
    return Number.isNaN(dt.getTime()) ? null : dt;
  }

  function formatTimestampDisplay(value){
    const dt = parseTimestamp(value);
    return dt ? dateTimeFormatter.format(dt) : '—';
  }

  function normalizePartLocation(entry){
    if (!entry || !entry.order_code) return null;
    const scanned = entry.scanned_at || entry.scannedAt || null;
    const updated = entry.updated_at || entry.updatedAt || scanned;
    return {
      order_code: entry.order_code,
      location_code: entry.location_code || '',
      device_id: entry.device_id || '',
      scan_id: entry.scan_id || entry.last_scan_id || '',
      scanned_at: scanned,
      updated_at: updated,
    };
  }

  function setPartLocationStatus(state, label){
    const el = partLocationElements.socketStatus;
    if (!el) return;
    const messages = {
      live: 'LIVE',
      offline: 'OFFLINE',
      loading: '接続確認中…',
      reconnect: '再接続中…',
    };
    el.dataset.state = state;
    el.textContent = label || messages[state] || '—';
  }

  function showPartLocationMessage(level, message, duration = 5000){
    const container = partLocationElements.message;
    if (!container) return;
    const classes = {
      success: 'alert-success',
      info: 'alert-info',
      warning: 'alert-warning',
      danger: 'alert-danger',
    };
    const className = classes[level] || classes.info;
    container.innerHTML = `<div class="alert ${className}">${message}</div>`;
    if (partLocationMessageTimer) clearTimeout(partLocationMessageTimer);
    if (duration){
      partLocationMessageTimer = setTimeout(() => {
        if (container.innerHTML.includes(message)) container.innerHTML = '';
      }, duration);
    }
  }

  function queueHighlightRow(key){
    if (!partLocationElements.tableBody || !key) return;
    const selector = `tr[data-key="${cssEscape(key)}"]`;
    const row = partLocationElements.tableBody.querySelector(selector);
    if (!row) return;
    row.classList.add('is-flash');
    if (partLocationHighlightTimer) clearTimeout(partLocationHighlightTimer);
    partLocationHighlightTimer = setTimeout(() => {
      row.classList.remove('is-flash');
      partLocationHighlightTimer = null;
    }, 2200);
  }

  function renderPartLocations(options = {}){
    if (!partLocationElements.tableBody) return;
    const entries = Array.from(partLocationState.values()).sort((a, b) => {
      const aTime = parseTimestamp(a.updated_at)?.getTime() || 0;
      const bTime = parseTimestamp(b.updated_at)?.getTime() || 0;
      return bTime - aTime;
    });
    const fragment = document.createDocumentFragment();
    entries.forEach(entry => {
      const tr = document.createElement('tr');
      tr.dataset.key = entry.order_code;
      const cells = [
        entry.order_code,
        entry.location_code || '-',
        entry.device_id || '-',
        formatTimestampDisplay(entry.scanned_at),
        formatTimestampDisplay(entry.updated_at),
      ];
      cells.forEach(text => {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      });
      fragment.appendChild(tr);
    });
    partLocationElements.tableBody.innerHTML = '';
    partLocationElements.tableBody.appendChild(fragment);

    if (partLocationElements.count){
      partLocationElements.count.textContent = `件数: ${entries.length}`;
    }
    if (partLocationElements.tabBadge){
      partLocationElements.tabBadge.textContent = entries.length;
    }
    if (partLocationElements.lastUpdated){
      const latest = entries.length ? entries[0].updated_at : null;
      partLocationElements.lastUpdated.textContent = `最終更新: ${latest ? formatTimestampDisplay(latest) : '—'}`;
    }
    if (partLocationElements.empty){
      partLocationElements.empty.style.display = entries.length ? 'none' : 'block';
    }

    const highlightKey = options.highlightKey || partLocationLastHighlight;
    if (highlightKey){
      partLocationLastHighlight = highlightKey;
      queueHighlightRow(highlightKey);
    }
  }

  function hydratePartLocations(list){
    partLocationState.clear();
    (list || []).forEach(item => {
      const normalized = normalizePartLocation(item);
      if (normalized) partLocationState.set(normalized.order_code, normalized);
    });
    renderPartLocations();
  }

  async function refreshPartLocations(){
    if (!partLocationElements.refreshBtn) return;
    partLocationElements.refreshBtn.disabled = true;
    setPartLocationStatus('loading', '更新中…');
    try{
      const res = await fetch('/api/part_locations?limit=200');
      const data = await res.json();
      if (!res.ok){
        throw new Error(data.error || '所在一覧の取得に失敗しました');
      }
      hydratePartLocations(data.items || []);
      if (isPartLocationsActive()){
        showPartLocationMessage('success', `所在一覧を更新しました（${(data.items || []).length}件）`, 3000);
      }
    }catch(err){
      console.error('part_locations refresh error', err);
      showPartLocationMessage('danger', err.message || String(err));
    }finally{
      partLocationElements.refreshBtn.disabled = false;
      setPartLocationStatus(socket.connected ? 'live' : 'offline', socket.connected ? 'LIVE' : 'OFFLINE');
    }
  }

  function loadInitialPartLocations(){
    try{
      const el = document.getElementById('initialPartLocations');
      if (!el) return [];
      return JSON.parse(el.textContent || '[]') || [];
    }catch(err){
      console.warn('Failed to parse initial part locations', err);
      return [];
    }
  }

  function isPartLocationsActive(){
    return !!(partLocationElements.panel && partLocationElements.panel.classList.contains('active'));
  }

  const partLocationInitialData = loadInitialPartLocations();

  (function setupPartLocations(){
    if (!partLocationElements.tableBody) return;
    setPartLocationStatus(socket.connected ? 'live' : 'loading', socket.connected ? 'LIVE' : '接続確認中…');
    hydratePartLocations(partLocationInitialData);
    if (partLocationElements.refreshBtn){
      partLocationElements.refreshBtn.addEventListener('click', refreshPartLocations);
    }
    if (!isPartLocationsActive() && partLocationElements.message){
      partLocationElements.message.innerHTML = '';
    }
  })();

  socket.on('part_location_updated', (payload) => {
    if (!partLocationElements.tableBody) return;
    const normalized = normalizePartLocation(payload);
    if (!normalized) return;
    partLocationState.set(normalized.order_code, normalized);
    renderPartLocations({ highlightKey: normalized.order_code });
    if (isPartLocationsActive()){
      showPartLocationMessage('info', `更新: ${normalized.order_code} → ${normalized.location_code || '-'}`, 4000);
    }
    if (socket.connected){
      setPartLocationStatus('live', 'LIVE');
    }
  });

  socket.on('connect', () => {
    setPartLocationStatus('live', 'LIVE');
  });
  socket.on('connect_error', () => {
    setPartLocationStatus('offline', 'OFFLINE');
  });
  socket.on('disconnect', () => {
    setPartLocationStatus('offline', 'OFFLINE');
  });
  if (socket.io){
    socket.io.on('reconnect_attempt', () => setPartLocationStatus('loading', '再接続中…'));
    socket.io.on('reconnect', () => setPartLocationStatus('live', 'LIVE'));
    socket.io.on('reconnect_error', () => setPartLocationStatus('offline', 'OFFLINE'));
  }

  (function setupRightPanelTabs(){
    const container = document.getElementById('rightPanel');
    if (!container) return;
    const buttons = Array.from(container.querySelectorAll('.future-tab-button'));
    const panels = {};
    buttons.forEach(btn => {
      const target = btn.dataset.target;
      if (target) panels[target] = document.getElementById(target);
    });
    let active = buttons.find(btn => btn.classList.contains('active'))?.dataset.target || (buttons[0] && buttons[0].dataset.target);
    function activate(target){
      if (!target || target === active) return;
      const panel = panels[target];
      if (!panel) return;
      active = target;
      buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.target === target));
      Object.entries(panels).forEach(([key, pane]) => {
        if (!pane) return;
        pane.classList.toggle('active', key === target);
      });
      if (target === 'docViewerPanel' && typeof window.requestDocViewerFocus === 'function'){
        setTimeout(() => {
          try { window.requestDocViewerFocus(); } catch (_) {}
        }, 150);
      }
      if (target === 'partLocationsPanel'){
        renderPartLocations();
      }
    }
    buttons.forEach(btn => {
      btn.addEventListener('click', () => activate(btn.dataset.target));
    });
  })();

  socket.on('station_config_updated', (data) => {
    if (!data || typeof data !== 'object') return;
    refreshStationUI(data);
    try { window.notifyDocViewerStationChange(data); } catch (_) {}
    if (suppressNextStationNotice){
      suppressNextStationNotice = false;
      return;
    }
    showStationMessage('info', '他の端末で工程設定が更新されました');
  });

  const stationConfigInitial = {{ station_config|tojson }};
  let stationConfig = stationConfigInitial;
  let suppressNextStationNotice = false;

  window.notifyDocViewerStationChange = window.notifyDocViewerStationChange || function(){ };

  function showStationMessage(type, msg){
    const el = document.getElementById('stationConfigMessage');
    if (!el) return;
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(()=>{ if (el.innerHTML.includes(msg)) el.innerHTML=''; }, 5000);
  }

  function refreshStationUI(config){
    stationConfig = config || stationConfig;
    const select = document.getElementById('stationProcessSelect');
    if (select){
      const current = stationConfig.process || '';
      const options = ['<option value="">（未設定）</option>'];
      (stationConfig.available || []).forEach(name => {
        options.push(`<option value="${name}">${name}</option>`);
      });
      select.innerHTML = options.join('');
      select.value = current;
    }

    const listEl = document.getElementById('stationAvailableList');
    if (listEl){
      listEl.innerHTML = '';
      (stationConfig.available || []).forEach(name => {
        const chip = document.createElement('span');
        chip.className = 'station-chip';
        chip.textContent = name;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = '×';
        btn.title = `${name} を候補から削除`;
        btn.addEventListener('click', ()=>removeStationProcess(name));
        chip.appendChild(btn);
        listEl.appendChild(chip);
      });
      if (!stationConfig.available || stationConfig.available.length === 0){
        const empty = document.createElement('span');
        empty.className = 'station-meta';
        empty.textContent = '工程候補が登録されていません。追加してください。';
        listEl.appendChild(empty);
      }
    }

    const meta = document.getElementById('stationConfigMeta');
    if (meta){
      const updated = stationConfig.updated_at ? `最終更新: ${stationConfig.updated_at}` : 'station.json はまだ保存されていません（環境変数または未設定）';
      const path = stationConfig.path ? `設定ファイル: ${stationConfig.path}` : '';
      meta.innerHTML = `${updated}${path ? '<br>' + path : ''}`;
    }

    const notice = document.getElementById('stationConfigNotice');
    if (notice){
      const messages = [];
      if (stationConfig.error){
        messages.push(`⚠️ 設定ファイルを読み込めません: ${stationConfig.error}`);
      }
      if (stationConfig.source === 'env'){
        messages.push('環境変数から工程が設定されています。station.json を保存すると上書きできます。');
      } else if (stationConfig.source === 'default'){
        messages.push('工程は未設定です。工程を選択して保存してください。');
      }
      if (stationConfig.writable === false || stationConfig.writable === 0){
        messages.push('station.json に書き込みできません。権限を確認してください。');
      }
      if (messages.length){
        notice.style.display = 'block';
        notice.innerHTML = messages.join('<br>');
      } else {
        notice.style.display = 'none';
        notice.innerHTML = '';
      }
    }

    const panel = document.getElementById('docViewerPanel');
    if (panel){
      panel.dataset.stationProcess = stationConfig.process || '';
    }
  }

  function handleStationConfigFeedback(config, successMessage){
    if (config){
      refreshStationUI(config);
      try { window.notifyDocViewerStationChange(config); } catch (_) {}
      if (config.writable === false || config.writable === 0){
        showStationMessage('warning', 'station.json に書き込めません。権限を確認してください。');
      } else if (successMessage){
        showStationMessage('success', successMessage);
      }
    }
  }

  async function processStationConfigResponse(res, { successMessage, errorMessage, errorLevel = 'danger' }){
    let data = null;
    try{
      data = await res.json();
    }catch(_){
      data = null;
    }

    if (res.ok && data){
      suppressNextStationNotice = true;
      setTimeout(() => { suppressNextStationNotice = false; }, 500);
      handleStationConfigFeedback(data, successMessage);
    } else {
      const message = (data && data.error) ? data.error : (errorMessage || '工程設定の更新に失敗しました');
      showStationMessage(errorLevel, message);
    }
    return data;
  }

  function showApiTokenMessage(type, msg){
    const el = document.getElementById('apiTokenMessage');
    if(!el) return;
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(()=>{ if(el.innerHTML.includes(msg)){ el.innerHTML=''; } }, 6000);
  }

  async function loadApiTokens(){
    const tableBody = document.querySelector('#apiTokenTable tbody');
    if(tableBody) tableBody.innerHTML = '';
    try{
      const res = await fetch('/api/tokens');
      const data = await res.json();
      if(!res.ok){
        showApiTokenMessage('danger', data.error || 'トークン一覧の取得に失敗しました');
        return;
      }
      if(tableBody){
        const tokens = data.tokens || [];
        tokens.forEach(entry => {
          const tr = tableBody.insertRow();
          tr.insertCell(0).textContent = entry.station_id || '-';
          tr.insertCell(1).textContent = entry.issued_at || '-';
          tr.insertCell(2).textContent = entry.revoked_at || '-';
          tr.insertCell(3).textContent = entry.note || '';
          tr.insertCell(4).textContent = entry.revoked_at ? '無効' : '有効';
          tr.insertCell(5).textContent = entry.token || '';
        });
        if(tokens.length === 0){
          const tr = tableBody.insertRow();
          const td = tr.insertCell(0);
          td.colSpan = 6;
          td.style.textAlign = 'center';
          td.style.color = '#64748b';
          td.textContent = '登録されているトークンはありません';
        }
      }
    }catch(err){
      showApiTokenMessage('danger', `トークン一覧の取得でエラー: ${err}`);
    }
  }

  let apiTokenIssuedTimer = null;

  async function issueApiToken(){
    const stationInput = document.getElementById('apiTokenStationInput');
    const noteInput = document.getElementById('apiTokenNoteInput');
    const keepExisting = document.getElementById('apiTokenKeepExisting').checked;
    const payload = {
      station_id: stationInput.value.trim(),
      note: noteInput.value.trim() || null,
      keep_existing: keepExisting,
    };
    if(!payload.station_id){
      showApiTokenMessage('warning', 'station_id を入力してください');
      return;
    }
    try{
      const res = await fetch('/api/tokens', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok){
        showApiTokenMessage('danger', data.error || 'トークン発行に失敗しました');
        return;
      }
      const pre = document.getElementById('apiTokenIssued');
      if(pre){
        pre.style.display = 'block';
        pre.textContent = `station_id: ${data.station_id}\nissued_at: ${data.issued_at}\nnote: ${data.note || ''}\n\n下記トークンを安全な場所に保管してください:\n${data.token}`;
        if(apiTokenIssuedTimer) clearTimeout(apiTokenIssuedTimer);
        apiTokenIssuedTimer = setTimeout(()=>{ pre.style.display='none'; pre.textContent=''; }, 60000);
      }
      showApiTokenMessage('success', 'トークンを発行しました。表示されたトークンを保管してください。');
      stationInput.value='';
      noteInput.value='';
      document.getElementById('apiTokenKeepExisting').checked = false;
      loadApiTokens();
    }catch(err){
      showApiTokenMessage('danger', `トークン発行でエラー: ${err}`);
    }
  }

  async function revokeApiToken(){
    const tokenInput = document.getElementById('apiTokenRevokeTokenInput');
    const stationInput = document.getElementById('apiTokenRevokeStationInput');
    const revokeAll = document.getElementById('apiTokenRevokeAll').checked;
    const payload = {
      token: (tokenInput.value || '').trim() || null,
      station_id: (stationInput.value || '').trim() || null,
      all: revokeAll,
    };
    if(!payload.token && !payload.station_id && !revokeAll){
      showApiTokenMessage('warning', 'トークン文字列、station_id、または「すべて」を指定してください');
      return;
    }
    try{
      const res = await fetch('/api/tokens/revoke', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok){
        showApiTokenMessage('danger', data.error || 'トークンの無効化に失敗しました');
        return;
      }
      showApiTokenMessage('success', `${data.updated || 0} 件のトークンを無効化しました`);
      tokenInput.value='';
      stationInput.value='';
      document.getElementById('apiTokenRevokeAll').checked = false;
      loadApiTokens();
    }catch(err){
      showApiTokenMessage('danger', `トークン無効化でエラー: ${err}`);
    }
  }

  async function fetchStationConfig(){
    try{
      const res = await fetch('/api/station_config');
      const data = await res.json();
      if(res.ok){
        handleStationConfigFeedback(data);
      } else {
        showStationMessage('warning', data.error || '工程設定の取得に失敗しました');
      }
    }catch(err){
      showStationMessage('warning', `工程設定の取得でエラー: ${err}`);
    }
  }

  async function saveStationProcess(){
    const select = document.getElementById('stationProcessSelect');
    if(!select) return;
    const process = select.value;
    const payload = {
      process: process,
      available: stationConfig.available || []
    };
    try{
      const res = await fetch('/api/station_config', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      await processStationConfigResponse(res, {
        successMessage: '工程設定を保存しました',
        errorMessage: '工程設定の保存に失敗しました',
      });
    }catch(err){
      showStationMessage('danger', `工程設定の保存でエラー: ${err}`);
    }
  }

  async function addStationProcess(){
    const input = document.getElementById('stationNewProcessInput');
    if(!input) return;
    const name = input.value.trim();
    if(!name){
      showStationMessage('warning', '追加する工程名を入力してください');
      return;
    }
    const available = stationConfig.available ? [...stationConfig.available] : [];
    if(!available.includes(name)){
      available.push(name);
    }
    try{
      const res = await fetch('/api/station_config', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({process: stationConfig.process || '', available})
      });
      const data = await processStationConfigResponse(res, {
        successMessage: `工程候補「${name}」を追加しました`,
        errorMessage: '工程候補の追加に失敗しました',
      });
      if(res.ok && data){
        input.value='';
      }
    }catch(err){
      showStationMessage('danger', `工程候補の追加でエラー: ${err}`);
    }
  }

  async function removeStationProcess(name){
    const available = (stationConfig.available || []).filter(item => item !== name);
    const process = stationConfig.process === name ? '' : stationConfig.process || '';
    try{
      const res = await fetch('/api/station_config', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({process, available})
      });
      await processStationConfigResponse(res, {
        successMessage: `工程候補「${name}」を削除しました`,
        errorMessage: '工程候補の削除に失敗しました',
      });
    }catch(err){
      showStationMessage('danger', `工程候補の削除でエラー: ${err}`);
    }
  }

  // 状態
  let scanActive = false;
  let currentUserUid = '';
  let currentToolUid = '';
  let activeTab = 'operations';

  // ドキュメントビューア（右パネル）制御
  (function setupDocViewer(){
    const panel = document.getElementById('docViewerPanel');
    if (!panel) return;

    const frame    = document.getElementById('docViewerFrame');
    const overlay  = document.getElementById('docViewerOverlay');
    const statusEl = document.getElementById('docViewerStatus');
    const statusLbl = statusEl ? statusEl.querySelector('.doc-viewer-status__label') : null;
    const stateChip = document.getElementById('docViewerStateChip');
    const partChip = document.getElementById('docViewerPartChip');
    const reloadBtn = document.getElementById('docViewerReloadBtn');
    const returnBtn = document.getElementById('docViewerReturnBtn');
    const docViewerUrl = (panel.dataset.docViewerUrl || '').trim();
    const initialOnline = panel.dataset.docViewerOnline === 'true';

    const postToViewer = (payload) => {
      if (frame && frame.contentWindow) {
        try { frame.contentWindow.postMessage(payload, '*'); } catch (_) {}
      }
    };

    const requestViewerFocus = () => postToViewer({ type: 'focus-request' });

    const setStatus = (state, label) => {
      if (!statusEl) return;
      statusEl.classList.remove('doc-viewer-status--online', 'doc-viewer-status--offline');
      statusEl.classList.add(state === 'online' ? 'doc-viewer-status--online' : 'doc-viewer-status--offline');
      if (statusLbl) statusLbl.textContent = label;
      statusEl.dataset.state = state;
    };

    const showOverlay = (message) => {
      if (!overlay) return;
      overlay.innerHTML = message;
      overlay.classList.remove('is-hidden');
    };

    const hideOverlay = () => {
      if (!overlay) return;
      overlay.classList.add('is-hidden');
    };

    const reloadFrame = () => {
      if (!frame) return;
      if (!docViewerUrl) {
        showOverlay('DocumentViewer の URL が設定されていません。<br>環境変数 <code>DOCUMENT_VIEWER_URL</code> を確認してください。');
        setStatus('offline', '未設定');
        return;
      }
      showOverlay('ドキュメントビューアを読み込み中です…');
      setStatus('offline', '接続確認中…');
      const cacheBust = docViewerUrl.includes('?') ? '&' : '?';
      frame.src = `${docViewerUrl}${cacheBust}v=${Date.now()}`;
    };

    const notifyStationChange = (payload) => {
      if (!payload) return;
      postToViewer({
        type: 'station-change',
        process: payload.process || '',
        available: payload.available || [],
        updated_at: payload.updated_at || null,
      });
      if (!frame || !frame.src) {
        reloadFrame();
      }
    };

    if (initialOnline && frame && docViewerUrl) {
      frame.src = docViewerUrl;
    } else if (!initialOnline) {
      setStatus('offline', '未接続');
    }

    if (reloadBtn) reloadBtn.addEventListener('click', () => reloadFrame());
    if (returnBtn) returnBtn.addEventListener('click', () => postToViewer({ type: 'viewer-return' }));

    if (frame) {
      frame.addEventListener('load', () => {
        if (!frame.src) return;
        setStatus('online', '接続済み');
        hideOverlay();
      });
      frame.addEventListener('error', () => {
        setStatus('offline', '読み込み失敗');
        showOverlay('DocumentViewer が応答しません。サービスを起動してから再試行してください。');
      });
    }

    // オフライン状態でロード不可だった場合に備えリロードボタンで再試行
    panel.dataset.docViewerUrl = docViewerUrl;
    panel.__requestViewerFocus = requestViewerFocus;
    window.requestDocViewerFocus = requestViewerFocus;
    window.notifyDocViewerStationChange = notifyStationChange;

    if (document.getElementById('operations')?.classList.contains('active')) {
      requestViewerFocus();
    }

    const stateLabel = {
      idle: '状態: 待機中',
      viewer: '状態: 表示中',
      searching: '状態: 検索中…',
      error: '状態: エラー'
    };

    const updateStateChips = (payload) => {
      if (stateChip && payload.state) {
        stateChip.textContent = stateLabel[payload.state] || '状態: -';
        stateChip.dataset.state = payload.state;
      }
      if (partChip) {
        if (payload.part) {
          partChip.textContent = `部品番号: ${payload.part}`;
          partChip.dataset.empty = 'false';
        } else {
          partChip.textContent = '部品番号: -';
          partChip.dataset.empty = 'true';
        }
      }
    };

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || typeof data !== 'object') return;
      if (data.type === 'viewer-state') {
        updateStateChips(data);
      } else if (data.type === 'dv-barcode') {
        handleViewerBarcode(data);
      }
    });
  })();

  // タブ切り替え（借用/返却以外に移動したら UI を停止状態に戻す）
  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    const tabEl = document.getElementById(tabName);
    if (tabEl) tabEl.classList.add('active');
    if (event && event.target) event.target.classList.add('active');
    activeTab = tabName;

    // 借用/返却タブ以外に移動したら見た目も停止状態へ（誤解防止）
    if (tabName !== 'operations') {
      scanActive = false;
      if (typeof updateScanStatus === 'function') updateScanStatus(false);
    }

    if (tabName === 'registration' || tabName === 'master') loadToolNames();
    if (tabName === 'operations') {
      loadLoansData();
      if (window.requestDocViewerFocus) {
        try { window.requestDocViewerFocus(); } catch (_) {}
      }
    }
  }

  const usbOverlay = document.getElementById('usbSyncOverlay');
  const usbOverlayMessage = document.getElementById('usbSyncOverlayMessage');

  function showUsbOverlay(message){
    if (!usbOverlay) return;
    if (message && usbOverlayMessage) usbOverlayMessage.textContent = message;
    usbOverlay.classList.add('is-visible');
    document.body.classList.add('modal-locked');
  }

  function hideUsbOverlay(){
    if (!usbOverlay) return;
    usbOverlay.classList.remove('is-visible');
    document.body.classList.remove('modal-locked');
  }

  function formatUsbSyncSteps(data){
    if (!data || !Array.isArray(data.steps)){
      return (data && data.stdout) ? data.stdout : '(結果データがありません)';
    }
    const blocks = data.steps.map(step => {
      const title = step.title || step.name || '処理';
      const code = Number(step.returncode || 0);
      let statusLabel = code === 0 ? '成功' : '失敗';
      if (code === 127) statusLabel = '未実施';
      const lines = [`【${title}】 ${statusLabel} (code=${code})`];
      if (step.stdout) lines.push(`stdout:\n${step.stdout.trim()}`);
      if (step.stderr) lines.push(`stderr:\n${step.stderr.trim()}`);
      return lines.join('\n\n');
    });
    return blocks.join('\n\n');
  }

  const historySection = document.getElementById('historySection');

  async function runUsbSync(){
    const outputEl = document.getElementById('usbSyncOutput');
    showUsbOverlay('工具マスタとドキュメントを同期しています...');
    outputEl.textContent = '同期中...';
    try{
      const res = await fetch('/api/usb_sync',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({device:'/dev/sda1'})});
      const data = await res.json();
      const summary = formatUsbSyncSteps(data);
      outputEl.textContent = summary;
      if (data.status === 'success'){
        showMessage('transactionResult','USB同期が完了しました','success');
      } else {
        showMessage('transactionResult','USB同期でエラーが発生しました','danger');
      }
    }catch(err){
      outputEl.textContent = `error: ${err}`;
      showMessage('transactionResult','USB同期でエラーが発生しました','danger');
    } finally {
      hideUsbOverlay();
    }
  }

  function toggleHistory(){
    if(!historySection) return;
    historySection.style.display = historySection.style.display === 'none' ? 'flex' : 'none';
  }

  window.toggleHistory = toggleHistory;

  // スキャン開始/停止：appScan ラッパ経由（loan 文脈）
  function startScan() {
    if (window.requestDocViewerFocus) {
      try { window.requestDocViewerFocus(); } catch (_) {}
    }
    appScan.start('loan')
      .then(() => { scanActive = true;  updateScanStatus(true);  showMessage('scanMessage','スキャンを開始しました','info'); })
      .catch(()  => { showMessage('scanMessage','スキャン開始に失敗しました','danger'); });
  }
  function stopScan() {
    appScan.stop()
      .then(() => { scanActive = false; updateScanStatus(false); showMessage('scanMessage','スキャンを停止しました','warning'); })
      .catch(()=>{});
  }

  // 表示更新
  function updateScanStatus(active) {
    const s = document.getElementById('scanStatus');
    const startBtn = document.getElementById('startScanBtn');
    const stopBtn  = document.getElementById('stopScanBtn');
    if (active) {
      s.className='status-indicator status-active'; s.innerHTML='スキャン中';
      startBtn.disabled = true; stopBtn.disabled = false;
    } else {
      s.className='status-indicator status-inactive'; s.innerHTML='● 停止中';
      startBtn.disabled = false; stopBtn.disabled = true;
    }
  }
  function updateDisplays() {
    const u = document.getElementById('userDisplay');
    const t = document.getElementById('toolDisplay');
    u.textContent = currentUserUid || ''; t.textContent = currentToolUid || '';
    if (currentUserUid) { u.classList.add('completed'); } else { u.classList.remove('completed','active'); }
    if (currentToolUid) { t.classList.add('completed'); } else { t.classList.remove('completed'); currentUserUid ? t.classList.add('active') : t.classList.remove('active'); }
  }
  function showMessage(id, msg, type) {
    const el = document.getElementById(id);
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 5000);
  }

  const productionHighlightState = { part: null, order: null };

  function highlightProductionRows(part, order){
    const planBody = document.querySelector('#productionPlanTable tbody');
    const standardBody = document.querySelector('#standardTimesTable tbody');
    const messageEl = document.getElementById('productionHighlightMessage');
    productionHighlightState.part = part || null;
    productionHighlightState.order = order || null;

    const resetRows = (body) => {
      if (!body) return [];
      const rows = Array.from(body.querySelectorAll('tr'));
      rows.forEach(row => row.classList.remove('is-highlight', 'is-candidate'));
      return rows;
    };

    const planRows = resetRows(planBody);
    const standardRows = resetRows(standardBody);

    const evaluate = (rows) => {
      let matchCount = 0;
      let exactCount = 0;
      rows.forEach(row => {
        const rowPart = row.dataset.part || '';
        const rowOrder = row.dataset.order || '';
        if (part && rowPart === part){
          matchCount += 1;
          if (order && rowOrder === order){
            row.classList.add('is-highlight');
            exactCount += 1;
          } else if (!order){
            row.classList.add('is-highlight');
          } else {
            row.classList.add('is-candidate');
          }
        }
      });
      return { matchCount, exactCount };
    };

    const planStats = evaluate(planRows);
    const standardStats = evaluate(standardRows);

    if (!messageEl){
      return;
    }

    if (!part){
      messageEl.className = 'production-dashboard__note';
      messageEl.style.display = 'none';
      messageEl.textContent = '';
      return;
    }

    const totalMatches = planStats.matchCount + standardStats.matchCount;
    const totalExact = planStats.exactCount + standardStats.exactCount;

    if (totalMatches === 0){
      messageEl.className = 'dashboard-alert';
      messageEl.textContent = `部品番号「${part}」に一致するデータが見つかりません。`;
      messageEl.style.display = 'block';
      return;
    }

    if (order && totalExact === 0){
      messageEl.className = 'dashboard-alert';
      messageEl.textContent = `部品番号「${part}」、製造オーダー「${order}」に完全一致はありません。候補: 生産計画 ${planStats.matchCount} 件 / 標準工数 ${standardStats.matchCount} 件`;
      messageEl.style.display = 'block';
      return;
    }

    if (order){
      messageEl.className = 'production-dashboard__note';
      messageEl.textContent = `部品番号「${part}」、製造オーダー「${order}」をハイライトしました（生産計画 ${planStats.exactCount} 件 / 標準工数 ${standardStats.exactCount} 件）`;
      messageEl.style.display = 'block';
      return;
    }

    messageEl.className = 'production-dashboard__note';
    messageEl.textContent = `部品番号「${part}」の候補を表示しました（生産計画 ${planStats.matchCount} 件 / 標準工数 ${standardStats.matchCount} 件）`;
    messageEl.style.display = 'block';
  }

  function handleViewerBarcode(payload){
    if (!payload || typeof payload !== 'object') return;
    const part = payload.part || payload.part_number || payload.partNumber || '';
    const order = payload.order || payload.order_number || payload.orderNumber || '';
    highlightProductionRows(part, order);
  }

  function attachProductionRowHandlers(){
    const attach = (selector) => {
      const body = document.querySelector(`${selector} tbody`);
      if(!body) return;
      body.addEventListener('click', (event)=>{
        const row = event.target.closest('tr');
        if(!row) return;
        const part = row.dataset.part || '';
        const order = row.dataset.order || '';
        highlightProductionRows(part, order);
      });
    };
    attach('#productionPlanTable');
    attach('#standardTimesTable');
  }

  // 一覧
  function loadLoansData() {
    fetch('/api/loans').then(r=>r.json()).then(data=>{
      const openBody=document.querySelector('#openLoansTable tbody'); openBody.innerHTML='';
      data.open_loans.forEach(v=>{
        const tr=openBody.insertRow();
        tr.dataset.loanId = v.id;
        tr.dataset.toolUid = v.tool_uid;
        tr.dataset.toolLabel = v.tool;
        const tdTool = tr.insertCell(0); tdTool.textContent=v.tool;
        tr.insertCell(1).textContent=v.borrower;
        const d=new Date(v.loaned_at);
        tr.insertCell(2).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        const actions=tr.insertCell(3);
        actions.className='table-actions';

        const btnReturn=document.createElement('button');
        btnReturn.className='btn-table btn-manual-return';
        btnReturn.textContent='手動返却';
        btnReturn.addEventListener('click',()=>manualReturnLoan(v.id, v.tool, v.borrower));

        const btnDelete=document.createElement('button');
        btnDelete.className='btn-table btn-delete';
        btnDelete.textContent='削除';
        btnDelete.addEventListener('click',()=>deleteLoanEntry(v.id, v.tool_uid, v.tool));

        actions.appendChild(btnReturn);
        actions.appendChild(btnDelete);
      });
      const histBody=document.querySelector('#historyTable tbody'); histBody.innerHTML='';
      data.history.forEach(h=>{
        const tr=histBody.insertRow(); tr.insertCell(0).textContent=h.action; tr.insertCell(1).textContent=h.tool; tr.insertCell(2).textContent=h.borrower;
        const d=new Date(h.returned_at || h.loaned_at); tr.insertCell(3).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      });
    });
  }

  async function manualReturnLoan(loanId, toolLabel, borrowerLabel){
    if(!confirm(`「${toolLabel}」を手動で返却済みにします。${borrowerLabel}からの貸出を閉じてもよろしいですか？`)) return;
    try{
      const res = await fetch(`/api/loans/${loanId}/manual_return`, {method:'POST'});
      const data = await res.json();
      if(res.ok && data.status==='success'){
        showMessage('transactionResult', data.message, 'info');
        loadLoansData();
      }else{
        showMessage('scanMessage', data.error || '返却処理に失敗しました', 'danger');
      }
    }catch(e){
      showMessage('scanMessage', `エラー: ${e}`, 'danger');
    }
  }

  async function deleteLoanEntry(loanId, toolUid, toolLabel){
    if(!confirm(`UID ${toolUid}\n「${toolLabel}」の貸出記録を削除します。履歴には残りません。よろしいですか？`)) return;
    try{
      const res = await fetch(`/api/loans/${loanId}`, {method:'DELETE'});
      const data = await res.json();
      if(res.ok && data.status==='success'){
        showMessage('transactionResult', data.message, 'warning');
        loadLoansData();
      }else{
        showMessage('scanMessage', data.error || '削除に失敗しました', 'danger');
      }
    }catch(e){
      showMessage('scanMessage', `エラー: ${e}`, 'danger');
    }
  }

  // リセット
  function resetState() {
    fetch('/api/reset',{method:'POST'}).then(r=>r.json()).then(()=>{
      currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage','🔄 リセット完了','info');
      document.getElementById('transactionResult').innerHTML='';
      if (window.requestDocViewerFocus) {
        try { window.requestDocViewerFocus(); } catch (_) {}
      }
    });
  }

  // 登録タブ：単発スキャンAPI
  function scanForUser() {
    showMessage('userRegResult','スキャン中...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('userUidInput').value=d.uid; showMessage('userRegResult',`✅ UID: ${d.uid}`,'success'); }
      else{ showMessage('userRegResult','❌ 読み取りタイムアウト（タグを一度離して再タッチ）','danger'); }
    });
  }
  function scanForTool() {
    showMessage('toolRegResult','スキャン中...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('toolUidInput').value=d.uid; showMessage('toolRegResult',`✅ UID: ${d.uid}`,'success'); }
      else{ showMessage('toolRegResult','❌ 読み取りタイムアウト（タグを一度離して再タッチ）','danger'); }
    });
  }

  // 登録/マスタ
  function registerUser(){
    const uid=document.getElementById('userUidInput').value;
    const name=document.getElementById('userNameInput').value.trim();
    if(!uid||!name){ showMessage('userRegResult','❌ UID と 氏名 は必須です','danger'); return; }
    fetch('/api/register_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('userRegResult',d.message,'success'),document.getElementById('userNameInput').value='') : showMessage('userRegResult',d.error,'danger');});
  }
  function registerTool(){
    const uid=document.getElementById('toolUidInput').value;
    const name=document.getElementById('toolNameSelect').value;
    if(!uid||!name){ showMessage('toolRegResult','❌ UID と アイテム名 は必須です','danger'); return; }
    fetch('/api/register_tool',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('toolRegResult',d.message,'success'),document.getElementById('toolUidInput').value='',document.getElementById('toolNameSelect').value='') : showMessage('toolRegResult',d.error,'danger');});
  }
  function loadToolNames(){
    fetch('/api/tool_names').then(r=>r.json()).then(d=>{
      if(!d.names) return;
      const toolSel=document.getElementById('toolNameSelect'); toolSel.innerHTML='<option value="">（選択してください）</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; toolSel.appendChild(o); });
      const delSel=document.getElementById('deleteToolNameSelect'); delSel.innerHTML='<option value="">（選択してください）</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; delSel.appendChild(o); });
    });
  }
  function addToolName(){
    const name=document.getElementById('newToolNameInput').value.trim();
    if(!name){ showMessage('masterResult','❌ アイテム名を入力してください','danger'); return; }
    fetch('/api/add_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),document.getElementById('newToolNameInput').value='',loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }
  function deleteToolName(){
    const name=document.getElementById('deleteToolNameSelect').value;
    if(!name){ showMessage('masterResult','❌ 削除するアイテム名を選択してください','danger'); return; }
    if(!confirm(`「${name}」を削除してもよろしいですか？`)) return;
    fetch('/api/delete_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }

  // WebSocket受信：借用/返却タブのときだけ UI 反映（文脈ガード）
  socket.on('scan_update', function(data){
    const ctx = (window.appScan && window.appScan.get && window.appScan.get())
              || (document.getElementById('operations').classList.contains('active') ? 'loan' : 'register');
    if (ctx !== 'loan') return;

    currentUserUid = data.user_uid || currentUserUid;
    currentToolUid = data.tool_uid || currentToolUid;

    const u=document.getElementById('userDisplay');
    const t=document.getElementById('toolDisplay');
    if (data.user_name) u.textContent = data.user_name;
    if (data.tool_name) t.textContent = data.tool_name;

    updateDisplays();
    if (data.message) showMessage('scanMessage', data.message, 'info');
  });
  socket.on('transaction_complete', function(data){
    document.getElementById('userDisplay').textContent = data.user_name;
    document.getElementById('toolDisplay').textContent = data.tool_name;
    showMessage('transactionResult', data.message, data.action==='borrow'?'success':'info');
    loadLoansData();
  });
  socket.on('state_reset',  function(d){ currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage',d.message,'info'); });
  socket.on('error',        function(d){ showMessage('scanMessage', d.message,'danger'); });

  // タグ情報確認（登録タブ）
  function checkTagInfo(){
    showMessage('tagCheckResult','タグをスキャンしています...','info');
    fetch('/api/check_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){
        let type=d.type, msg=d.message, uid=d.uid, name=d.name, html='', cls='info';
        if(type==='user'){ cls='success'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>🆔 UID:</strong> ${uid}<br><strong>📝 登録タイプ:</strong> ユーザー<br><strong>👤 氏名:</strong> ${name}</div>`; }
        else if(type==='tool'){ cls='info'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>🆔 UID:</strong> ${uid}<br><strong>📝 登録タイプ:</strong> アイテム<br><strong>📦 アイテム名:</strong> ${name}</div>`; }
        else { cls='warning'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>🆔 UID:</strong> ${uid}<br><strong>📝 登録状況:</strong> 未登録<br><em>このタグはまだユーザーまたはアイテムとして登録されていません</em></div>`; }
        document.getElementById('tagCheckResult').innerHTML = `<div class="alert alert-${cls}">${msg}${html}</div>`;
      } else {
        showMessage('tagCheckResult','❌ 読み取りタイムアウト（タグを一度離して再タッチ）','danger');
      }
    });
  }

  // 初期化
  document.addEventListener('DOMContentLoaded', function(){
    loadLoansData();
    loadToolNames();
    refreshStationUI(stationConfigInitial);
    fetchStationConfig();
    attachProductionRowHandlers();
    loadApiTokens();
  });
</script>

<!-- ===== 安全シャットダウン（動的・右下固定） ===== -->
<script>
(function(){
  if (document.getElementById('btnShutdownFixed')) return;
  const wrap=document.createElement('div');
  wrap.id='shutdownFixedWrap';
  wrap.style.cssText='position:fixed;right:16px;bottom:16px;z-index:2147483647;display:flex;flex-direction:column;align-items:flex-end;gap:6px;';
  const btn=document.createElement('button');
  btn.id='btnShutdownFixed';
  btn.textContent='安全にシャットダウン';
  btn.style.cssText='background:#d9534f;color:#fff;border:0;padding:10px 14px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer;font-size:14px;';
  const note=document.createElement('small');
  note.textContent='この端末（Raspberry Pi）上で開いている場合のみ実行できます';
  note.style.cssText='color:#333;background:rgba(255,255,255,.85);padding:2px 6px;border-radius:4px;text-align:right;';
  btn.addEventListener('click', async ()=>{
    if(!confirm('Raspberry Pi を安全にシャットダウンします。よろしいですか？\n処理開始後は数十秒で電源LEDが消灯します。')) return;
    try{
      const res=await fetch('/api/shutdown',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({confirm:true})});
      const j=await res.json().catch(()=>({}));
      if(res.ok && j.ok) alert('シャットダウンを開始しました。LED消灯を確認してから電源を抜いてください。');
      else alert('失敗: '+(j.error||res.status));
    }catch(e){ alert('エラー: '+e); }
  });
  wrap.appendChild(btn); wrap.appendChild(note); document.body.appendChild(wrap);
})();
</script>

<!-- ===== スキャン制御（タブ独立運用） ===== -->
<script>
  // 文脈付きスキャン制御（loan / register）
  window.appScan = (function(){
    let active=false, ctx=null;

    async function start(newCtx){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } ctx=newCtx; active=true; await fetch('/api/start_scan',{method:'POST'}); }
      catch(_){}
    }

    async function stop(){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } }
      catch(_){}
      // UI も停止状態に戻す（誤解防止）
      active=false; ctx=null;
      try{ window.scanActive=false; if (typeof updateScanStatus==='function') updateScanStatus(false); }catch(_){}
    }

    function get(){ return ctx; }

    // ページ離脱時も停止（できるだけ通知）
    window.addEventListener('beforeunload', ()=>{
      try{
        if(navigator.sendBeacon){
          const b=new Blob([], {type:'application/json'}); navigator.sendBeacon('/api/stop_scan', b);
        } else { fetch('/api/stop_scan',{method:'POST', keepalive:true}); }
      } catch(_){}
    });

    return { start, stop, get };
  })();

  // タブ切替時は必ず停止（.tab-button を検知対象に含める）
  document.addEventListener('click', (ev)=>{
    const tabLike = ev.target.closest('a[data-bs-toggle="tab"],[role="tab"],.tablinks,.tab-button,[data-tab-target],[data-tab]');
    if (tabLike) { window.appScan.stop(); }
  });
</script>
<!-- ===== /スキャン制御 ===== -->

</body>
</html>

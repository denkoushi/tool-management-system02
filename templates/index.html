<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="/static/js/socket.io.js"></script>
  

  <style>
  /* ===== Design tokens (light / modern / compact) ===== */
  :root{
    --bg: #f6f7f9;
    --surface: #ffffff;
    --surface-2: #f3f4f6;
    --border: #e5e7eb;
    --text: #111827;
    --muted: #6b7280;
    --brand: #2d6cdf;
    --brand-2: #0ea5e9;
    --success: #16a34a;
    --danger: #dc2626;
    --warning: #f59e0b;

    /* ã‚¿ã‚¤ãƒãƒ»ã‚µã‚¤ã‚ºï¼ˆãƒ•ãƒ«HD/21"æƒ³å®šã®é«˜å¯†åº¦ï¼‰ */
    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-md: 14px;
    --fs-lg: 16px;
    --fs-xl: 18px;
    --radius: 8px;

    /* ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå¯†åº¦ */
    --space-1: 4px;
    --space-2: 6px;
    --space-3: 8px;
    --space-4: 10px;
    --space-5: 12px;
  }

  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{width:100%;height:100%;overflow:hidden;}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: var(--bg); color: var(--text);
    display:flex; justify-content:flex-start; align-items:stretch;
  }
  body.modal-locked{overflow:hidden;}
  .app-layout{display:flex;width:100vw;height:100vh;}
  .container{flex:0 0 50vw;height:100vh;background:var(--surface);display:flex;flex-direction:column;box-shadow:2px 0 12px rgba(15,23,42,.08);}
  .future-panel{
    flex:1;
    background:var(--bg);
    display:flex;
    flex-direction:column;
    border-left:1px solid var(--border);
    position:relative;
  }

  .doc-viewer-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:var(--space-3);
    padding: var(--space-4);
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.92);
    backdrop-filter: blur(6px);
  }
  .doc-viewer-header h2{font-size:var(--fs-lg); font-weight:700; color:var(--text);}
  .doc-viewer-header-actions{display:flex; align-items:center; gap:var(--space-3);}

  .doc-viewer-status{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    font-size:var(--fs-sm);
    font-weight:700;
    background:var(--surface-2);
    color:var(--muted);
    transition:.2s;
  }
  .doc-viewer-status__dot{width:8px;height:8px;border-radius:50%;background:currentColor;display:block;}
  .doc-viewer-status--online{background:#dcfce7;border-color:#bbf7d0;color:#166534;}
  .doc-viewer-status--offline{background:#fef2f2;border-color:#fecaca;color:#991b1b;}

  .btn-reload{
    padding:6px 12px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    color:var(--text);
    font-size:var(--fs-sm);
    font-weight:700;
    cursor:pointer;
    transition:.15s;
  }
  .btn-reload:hover{background:var(--surface-2);}

  .doc-viewer-wrapper{
    flex:1;
    position:relative;
    background:var(--surface-2);
    overflow:hidden;
  }
  #docViewerFrame{
    width:100%;
    height:100%;
    border:0;
    background:#fff;
  }
  .doc-viewer-overlay{
    position:absolute;
    inset:12px;
    border-radius:var(--radius);
    background:rgba(15,23,42,.72);
    color:#f8fafc;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:24px;
    font-size:var(--fs-md);
    line-height:1.5;
    box-shadow:0 12px 32px rgba(15,23,42,.35);
  }
  .doc-viewer-overlay.is-hidden{display:none;}

  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.62);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .modal-overlay.is-visible{display:flex;}
  .modal-body{
    background:#0f172a;
    color:#e2e8f0;
    padding:32px 40px;
    border-radius:12px;
    box-shadow:0 24px 48px rgba(15,23,42,.45);
    width:min(420px, 90vw);
    text-align:center;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .modal-body h3{font-size:18px; margin:0; font-weight:700;}
  .modal-body p{margin:0; font-size:14px; color:#cbd5f5;}
  .modal-spinner{
    width:42px;
    height:42px;
    border-radius:50%;
    border:4px solid rgba(226,232,240,0.25);
    border-top-color:#38bdf8;
    margin:0 auto;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}

  /* Tabs */
  .tabs{
    display:flex; position:sticky; top:0; z-index:10;
    background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
    box-shadow: 0 2px 6px rgba(17,24,39,.08);
  }
  .tab-button{
    flex:1; padding: var(--space-4) var(--space-3);
    background:none; border:none; cursor:pointer;
    font-size: var(--fs-lg); font-weight:700;
    color: rgba(255,255,255,.9);
    border-bottom: 3px solid transparent; transition: .2s;
    white-space: nowrap;
  }
  .tab-button.active{background:rgba(255,255,255,.16); color:#fff; border-bottom-color:#fff;}

  .tab-content{display:none; padding: var(--space-4) var(--space-4); flex:1; overflow-y:auto;}
  .tab-content.active{display:flex; flex-direction:column;}

  /* Operations (Borrow/Return) */
  #operations{padding: var(--space-4);}
  #operations h2{font-size: var(--fs-lg); font-weight:700; color: var(--text);}

  .operation-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom:1px solid var(--border);
  }

  /* Buttons: compact */
  .button-row{display:flex; gap: var(--space-3); margin-bottom: var(--space-3);}
  .btn{
    padding: 10px 12px; border:none; border-radius: 6px; cursor:pointer;
    font-size: 18px; font-weight:700; transition:.15s;
    display:flex; align-items:center; justify-content:center; gap:6px;
    min-height: 42px;
  }
  .btn-primary{background:var(--brand); color:#fff;}
  .btn-primary:active{transform:scale(.98);}
  .btn-secondary{background:#6b7280; color:#fff;}
  .btn-danger{background:var(--danger); color:#fff;}
  .btn:disabled{opacity:.5; cursor:not-allowed;}

  .btn-table{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    font-size: var(--fs-sm);
    font-weight:700;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
    min-height:30px;
    transition:.15s;
  }
  .btn-table:hover{background:var(--surface-2);} 
  .btn-manual-return{border-color:var(--brand); color:var(--brand);} 
  .btn-manual-return:hover{background:#eef6ff;}
  .btn-delete{border-color:var(--danger); color:var(--danger);} 
  .btn-delete:hover{background:#fef2f2;}

  /* Status pill */
  .status-indicator{
    display:inline-flex; align-items:center; gap:6px;
    padding: 2px 10px; border-radius: 999px;
    font-size: var(--fs-sm); font-weight:700; transition:.2s;
    background: var(--surface-2); color: var(--muted);
    border:1px solid var(--border);
  }
  .status-active{
    background: #dcfce7; color:#166534; border-color:#bbf7d0;
    animation: pulse 2s infinite;
  }
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.85}}

  /* Scan progress: more compact */
  .scan-progress{
    display:flex; gap: var(--space-3);
    margin: var(--space-4) 0 var(--space-3);
    background: var(--surface-2); border-radius: var(--radius);
    padding: var(--space-3);
    border:1px solid var(--border);
  }
  .scan-step{flex:1;}
  .scan-step label{display:block; font-size: var(--fs-sm); color: var(--muted); margin-bottom:4px; font-weight:700;}
  .scan-display{
    background:#fff; border:1px solid var(--border); border-radius:6px;
    padding: 6px 8px;
    font-size: 20px; min-height: 36px;
    display:flex; align-items:center; overflow:hidden; text-overflow:ellipsis; word-break:break-all;
  }
  .scan-display.active{border-color: var(--brand); background:#eef6ff;}
  .scan-display.completed{border-color:#22c55e; background:#ecfdf5;}

  /* Alerts */
  .alert{padding:8px 12px; border-radius:6px; margin:8px 0; font-size: var(--fs-md);}
  .alert-success{background:#ecfdf5; border:1px solid #bbf7d0; color:#166534;}
  .alert-danger{background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d;}
  .alert-info{background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a;}
  .alert-warning{background:#fffbeb; border:1px solid #fde68a; color:#7c2d12;}

  .section-divider{border:none; border-top:2px solid var(--border); margin: 12px 0 10px;}
  .section-title{font-size: var(--fs-md); font-weight:700; color:#374151; margin-bottom:8px; display:flex; align-items:center; gap:6px;}

  /* Tables: compact/high-density with sticky header */
  .data-table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--border); border-radius:8px; overflow:hidden; font-size: 13.5px;}
  .data-table thead th{
    position: sticky; top: 0; z-index: 1;
    background:#f8fafc; color:#334155;
    padding: 6px 8px; text-align:left; font-weight:800; border-bottom:1px solid var(--border);
  }
  .data-table tbody td{
    padding: 4px 8px;
    border-bottom:1px solid #f1f5f9;
    line-height: 1.15;
  }
  .data-table tbody tr:hover{background:#f9fafb;}
  .table-actions{display:flex; gap:6px; flex-wrap:wrap;}

  /* Lists layout: more space for tables withoutå¤‰æ›´å¤šæ®µ */
  .bottom-tables{flex:1; display:flex; flex-direction:column; gap: 8px; overflow:hidden;}
  .table-section{flex:1; display:flex; flex-direction:column; min-height:0;}
  .scrollable-section{flex:1; overflow:auto; -webkit-overflow-scrolling:touch;}

  /* Forms compact */
  #registration, #master{padding: 14px; overflow-y:auto;}
  #registration h2, #master h2{font-size: var(--fs-xl); margin-bottom: 10px; color:#111827;}
  #registration h3, #master h3{font-size: var(--fs-lg); margin: 12px 0 8px; color:#1f2937;}

  .input-row{display:flex; gap:10px; margin-bottom:12px; align-items:end;}
  .input-group{flex:1;}
  .input-group label{display:block; margin-bottom:5px; font-weight:700; color:#374151; font-size: var(--fs-sm);}
  .form-control{
    width:100%; padding: 8px 10px; border:1px solid var(--border); border-radius:6px; font-size: var(--fs-md);
    transition: border-color .15s, box-shadow .15s;
  }
  .form-control:focus{outline:none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(45,108,223,.12);}

  @media (orientation:portrait){
    .operation-header{flex-direction:column; align-items:flex-start; gap:6px;}
    .status-indicator{align-self:flex-end;}
    .button-row{flex-wrap:wrap;}
  }
</style>


  
</head>
<body>
<div class="app-layout">
<div class="container">
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('operations')">ğŸ“² å€Ÿç”¨/è¿”å´</button>
    <button class="tab-button" onclick="showTab('registration')">ğŸ”– ã‚¿ã‚°ç™»éŒ²</button>
    <button class="tab-button" onclick="showTab('master')">ğŸ“š ãƒã‚¹ã‚¿</button>
    <button class="tab-button" onclick="showTab('maintenance')">ğŸ›  ãƒ¡ãƒ³ãƒ†</button>
  </div>

  <!-- å€Ÿç”¨/è¿”å´ -->
  <div id="operations" class="tab-content active">
    <div class="operation-header">
      <h2>â‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ â‘¡ã‚¢ã‚¤ãƒ†ãƒ  ã®é †ã«ã‚¹ã‚­ãƒ£ãƒ³</h2>
      <span id="scanStatus" class="status-indicator status-inactive">â— åœæ­¢ä¸­</span>
    </div>

    <div class="button-row">
      <button class="btn btn-primary" id="startScanBtn" onclick="startScan()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
      <button class="btn btn-secondary" id="stopScanBtn" onclick="stopScan()" disabled>åœæ­¢</button>
      <button class="btn btn-danger" onclick="resetState()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="scan-progress">
      <div class="scan-step">
        <label>â‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
        <div id="userDisplay" class="scan-display"></div>
      </div>
      <div class="scan-step">
        <label>â‘¡ã‚¢ã‚¤ãƒ†ãƒ </label>
        <div id="toolDisplay" class="scan-display"></div>
      </div>
    </div>

    <div id="scanMessage"></div>
    <div id="transactionResult"></div>

    <hr class="section-divider">

    <div class="bottom-tables">
      <div class="table-section">
        <div class="section-title">ğŸ“‹ è²¸å‡ºä¸­</div>
        <div class="scrollable-section">
          <table class="data-table" id="openLoansTable">
            <thead><tr><th>ã‚¢ã‚¤ãƒ†ãƒ </th><th>å€Ÿç”¨è€…</th><th>å€Ÿç”¨æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="table-section" style="margin-top:min(10px,2vh);">
        <div class="section-title">ğŸ•’ å±¥æ­´</div>
        <div class="scrollable-section">
          <table class="data-table" id="historyTable">
            <thead><tr><th>åŒºåˆ†</th><th>ã‚¢ã‚¤ãƒ†ãƒ </th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>æ—¥æ™‚</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¿ã‚°ç™»éŒ² -->
  <div id="registration" class="tab-content">
    <h2>ğŸ”– ã‚¿ã‚°ç™»éŒ²</h2>

    <div style="margin-bottom:30px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #17a2b8;">
      <h3>ğŸ” ã‚¿ã‚°æƒ…å ±ç¢ºèª</h3>
      <p style="margin-bottom:15px; color:#6c757d; font-size:14px;">NFCã‚¿ã‚°ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™</p>
      <div class="input-group" style="margin-bottom:15px;">
        <button class="btn btn-primary" onclick="checkTagInfo()" style="background:#17a2b8; border-color:#17a2b8;">ğŸ” ã‚¿ã‚°æƒ…å ±ã‚’ç¢ºèª</button>
      </div>
      <div id="tagCheckResult"></div>
    </div>

    <div style="display:flex; gap:30px; flex-wrap:wrap;">
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
      <div style="flex:1; min-width:300px;">
        <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h3>
        <div class="input-group" style="margin-bottom:15px;">
          <button class="btn btn-primary" onclick="scanForUser()">ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦UIDå–å¾—</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>UIDï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
          <input type="text" id="userUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>æ°åï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰</label>
          <input type="text" id="userNameInput" class="form-control" placeholder="å±±ç”°å¤ªéƒ">
        </div>
        <button class="btn btn-primary" onclick="registerUser()">ğŸ’¾ ç™»éŒ² / æ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</button>
        <div id="userRegResult"></div>
      </div>

      <!-- ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ² -->
      <div style="flex:1; min-width:300px;">
        <h3>ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²</h3>
        <div class="input-group" style="margin-bottom:15px;">
          <button class="btn btn-primary" onclick="scanForTool()">ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦UIDå–å¾—</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>UIDï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
          <input type="text" id="toolUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆãƒã‚¹ã‚¿ã‹ã‚‰é¸æŠï¼‰</label>
          <select id="toolNameSelect" class="form-control">
            <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="registerTool()">ğŸ’¾ ç™»éŒ² / æ›´æ–°ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ï¼‰</button>
        <div id="toolRegResult"></div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ã‚¤ãƒ†ãƒ åãƒã‚¹ã‚¿ -->
  <div id="master" class="tab-content">
    <h2>ğŸ“š ã‚¢ã‚¤ãƒ†ãƒ åãƒã‚¹ã‚¿</h2>

    <div class="input-row">
      <div class="input-group">
        <label>ã‚¢ã‚¤ãƒ†ãƒ åã‚’è¿½åŠ </label>
        <input type="text" id="newToolNameInput" class="form-control" placeholder="æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ å">
      </div>
      <button class="btn btn-primary" onclick="addToolName()">â• è¿½åŠ </button>
    </div>

    <div id="masterResult"></div>

    <h3>ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ åä¸€è¦§</h3>
    <div class="input-row">
      <div class="input-group">
        <label>å‰Šé™¤ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ åã‚’é¸æŠ</label>
        <select id="deleteToolNameSelect" class="form-control">
          <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
        </select>
      </div>
      <button class="btn btn-danger" onclick="deleteToolName()">ğŸ—‘ï¸ å‰Šé™¤</button>
  </div>
</div>
  
  <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ -->
  <div id="maintenance" class="tab-content">
    <h2>ğŸ›  ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h2>
    <div style="margin-bottom:20px; padding:16px; background:#f8f9fa; border-radius:8px; border:1px solid #e5e7eb;">
      <h3>USB åŒæœŸï¼ˆæ‰‹å‹•ï¼‰</h3>
      <p style="color:#6b7280; font-size:14px;">ãƒ©ãƒ™ãƒ« <code>TOOLMASTER</code> ã® USB ãƒ¡ãƒ¢ãƒªã‚’æŒ¿å…¥ã—ã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå·¥å…·åãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚¿ã‚°ç´ã¥ã‘ï¼‰ã‚’åŒæœŸã—ã¾ã™ã€‚</p>
      <div class="button-row">
        <button class="btn btn-primary" onclick="runUsbSync()">USB åŒæœŸã‚’å®Ÿè¡Œ</button>
      </div>
      <pre id="usbSyncOutput" style="background:#1f2937; color:#e5e7eb; padding:12px; border-radius:6px; min-height:120px; overflow:auto; font-size:13px;">(ã¾ã å®Ÿè¡Œã—ã¦ã„ã¾ã›ã‚“)</pre>
    </div>
  </div>
</div>
<div class="future-panel" id="docViewerPanel"
     data-doc-viewer-url="{{ doc_viewer_url|default('', true) }}"
     data-doc-viewer-online="{{ 'true' if doc_viewer_online else 'false' }}">
  <div class="doc-viewer-header">
    <h2>ğŸ“„ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢</h2>
    <div class="doc-viewer-header-actions">
      <div id="docViewerStatus"
           class="doc-viewer-status {{ 'doc-viewer-status--online' if doc_viewer_online else 'doc-viewer-status--offline' }}">
        <span class="doc-viewer-status__dot"></span>
        <span class="doc-viewer-status__label">{{ 'æ¥ç¶šæ¸ˆã¿' if doc_viewer_online else 'æœªæ¥ç¶š' }}</span>
      </div>
      <button type="button" id="docViewerReloadBtn" class="btn-reload">å†èª­ã¿è¾¼ã¿</button>
    </div>
  </div>
  <div class="doc-viewer-wrapper">
    <iframe id="docViewerFrame" title="Document Viewer"
            src="{{ doc_viewer_url if doc_viewer_online else '' }}"
            loading="lazy"></iframe>
    <div id="docViewerOverlay" class="doc-viewer-overlay">
      {% if doc_viewer_online %}
        ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦
      {% else %}
        DocumentViewer ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>
        èµ·å‹•å¾Œã«ã€Œå†èª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
      {% endif %}
    </div>
  </div>
</div>
</div>

<div id="usbSyncOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal-body">
    <div class="modal-spinner" aria-hidden="true"></div>
    <h3>USB åŒæœŸä¸­...</h3>
    <p id="usbSyncOverlayMessage">å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ USB ãƒ¡ãƒ¢ãƒªã‚’æŠœã‹ãªã„ã§ãã ã•ã„ã€‚</p>
  </div>
</div>

<!-- ===== ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¿ãƒ–ç‹¬ç«‹é‹ç”¨ & UIåŒæœŸï¼‰ ===== -->
<script>
  // WebSocket
  const socket = io();

  // çŠ¶æ…‹
  let scanActive = false;
  let currentUserUid = '';
  let currentToolUid = '';
  let activeTab = 'operations';

  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆå³ãƒ‘ãƒãƒ«ï¼‰åˆ¶å¾¡
  (function setupDocViewer(){
    const panel = document.getElementById('docViewerPanel');
    if (!panel) return;

    const frame    = document.getElementById('docViewerFrame');
    const overlay  = document.getElementById('docViewerOverlay');
    const statusEl = document.getElementById('docViewerStatus');
    const statusLbl= statusEl ? statusEl.querySelector('.doc-viewer-status__label') : null;
    const reloadBtn= document.getElementById('docViewerReloadBtn');
    const docViewerUrl = (panel.dataset.docViewerUrl || '').trim();
    const initialOnline = panel.dataset.docViewerOnline === 'true';

    const setStatus = (state, label) => {
      if (!statusEl) return;
      statusEl.classList.remove('doc-viewer-status--online', 'doc-viewer-status--offline');
      statusEl.classList.add(state === 'online' ? 'doc-viewer-status--online' : 'doc-viewer-status--offline');
      if (statusLbl) statusLbl.textContent = label;
    };

    const showOverlay = (message) => {
      if (!overlay) return;
      overlay.innerHTML = message;
      overlay.classList.remove('is-hidden');
    };

    const hideOverlay = () => {
      if (!overlay) return;
      overlay.classList.add('is-hidden');
    };

    const reloadFrame = () => {
      if (!frame) return;
      if (!docViewerUrl) {
        showOverlay('DocumentViewer ã® URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ç’°å¢ƒå¤‰æ•° <code>DOCUMENT_VIEWER_URL</code> ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        setStatus('offline', 'æœªè¨­å®š');
        return;
      }
      showOverlay('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦');
      setStatus('offline', 'æ¥ç¶šç¢ºèªä¸­â€¦');
      const cacheBust = docViewerUrl.includes('?') ? '&' : '?';
      frame.src = `${docViewerUrl}${cacheBust}v=${Date.now()}`;
    };

    if (initialOnline && frame && docViewerUrl) {
      frame.src = docViewerUrl;
    } else if (!initialOnline) {
      setStatus('offline', 'æœªæ¥ç¶š');
    }

    if (reloadBtn) {
      reloadBtn.addEventListener('click', () => {
        reloadFrame();
      });
    }

    if (frame) {
      frame.addEventListener('load', () => {
        if (!frame.src) return;
        setStatus('online', 'æ¥ç¶šæ¸ˆã¿');
        hideOverlay();
      });
      frame.addEventListener('error', () => {
        setStatus('offline', 'èª­ã¿è¾¼ã¿å¤±æ•—');
        showOverlay('DocumentViewer ãŒå¿œç­”ã—ã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
      });
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ãƒ­ãƒ¼ãƒ‰ä¸å¯ã ã£ãŸå ´åˆã«å‚™ãˆãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã§å†è©¦è¡Œ
    panel.dataset.docViewerUrl = docViewerUrl;
  })();

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆå€Ÿç”¨/è¿”å´ä»¥å¤–ã«ç§»å‹•ã—ãŸã‚‰ UI ã‚’åœæ­¢çŠ¶æ…‹ã«æˆ»ã™ï¼‰
  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    const tabEl = document.getElementById(tabName);
    if (tabEl) tabEl.classList.add('active');
    if (event && event.target) event.target.classList.add('active');
    activeTab = tabName;

    // å€Ÿç”¨/è¿”å´ã‚¿ãƒ–ä»¥å¤–ã«ç§»å‹•ã—ãŸã‚‰è¦‹ãŸç›®ã‚‚åœæ­¢çŠ¶æ…‹ã¸ï¼ˆèª¤è§£é˜²æ­¢ï¼‰
    if (tabName !== 'operations') {
      scanActive = false;
      if (typeof updateScanStatus === 'function') updateScanStatus(false);
    }

    if (tabName === 'registration' || tabName === 'master') loadToolNames();
    if (tabName === 'operations')   loadLoansData();
  }

  const usbOverlay = document.getElementById('usbSyncOverlay');
  const usbOverlayMessage = document.getElementById('usbSyncOverlayMessage');

  function showUsbOverlay(message){
    if (!usbOverlay) return;
    if (message && usbOverlayMessage) usbOverlayMessage.textContent = message;
    usbOverlay.classList.add('is-visible');
    document.body.classList.add('modal-locked');
  }

  function hideUsbOverlay(){
    if (!usbOverlay) return;
    usbOverlay.classList.remove('is-visible');
    document.body.classList.remove('modal-locked');
  }

  function formatUsbSyncSteps(data){
    if (!data || !Array.isArray(data.steps)){
      return (data && data.stdout) ? data.stdout : '(çµæœãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“)';
    }
    const blocks = data.steps.map(step => {
      const title = step.title || step.name || 'å‡¦ç†';
      const code = Number(step.returncode || 0);
      let statusLabel = code === 0 ? 'æˆåŠŸ' : 'å¤±æ•—';
      if (code === 127) statusLabel = 'æœªå®Ÿæ–½';
      const lines = [`ã€${title}ã€‘ ${statusLabel} (code=${code})`];
      if (step.stdout) lines.push(`stdout:\n${step.stdout.trim()}`);
      if (step.stderr) lines.push(`stderr:\n${step.stderr.trim()}`);
      return lines.join('\n\n');
    });
    return blocks.join('\n\n');
  }

  async function runUsbSync(){
    const outputEl = document.getElementById('usbSyncOutput');
    showUsbOverlay('å·¥å…·ãƒã‚¹ã‚¿ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åŒæœŸã—ã¦ã„ã¾ã™...');
    outputEl.textContent = 'åŒæœŸä¸­...';
    try{
      const res = await fetch('/api/usb_sync',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({device:'/dev/sda1'})});
      const data = await res.json();
      const summary = formatUsbSyncSteps(data);
      outputEl.textContent = summary;
      if (data.status === 'success'){
        showMessage('transactionResult','USBåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ','success');
      } else {
        showMessage('transactionResult','USBåŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ','danger');
      }
    }catch(err){
      outputEl.textContent = `error: ${err}`;
      showMessage('transactionResult','USBåŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ','danger');
    } finally {
      hideUsbOverlay();
    }
  }

  // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹/åœæ­¢ï¼šappScan ãƒ©ãƒƒãƒ‘çµŒç”±ï¼ˆloan æ–‡è„ˆï¼‰
  function startScan() {
    appScan.start('loan')
      .then(() => { scanActive = true;  updateScanStatus(true);  showMessage('scanMessage','ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ','info'); })
      .catch(()  => { showMessage('scanMessage','ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ','danger'); });
  }
  function stopScan() {
    appScan.stop()
      .then(() => { scanActive = false; updateScanStatus(false); showMessage('scanMessage','ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ','warning'); })
      .catch(()=>{});
  }

  // è¡¨ç¤ºæ›´æ–°
  function updateScanStatus(active) {
    const s = document.getElementById('scanStatus');
    const startBtn = document.getElementById('startScanBtn');
    const stopBtn  = document.getElementById('stopScanBtn');
    if (active) {
      s.className='status-indicator status-active'; s.innerHTML='ã‚¹ã‚­ãƒ£ãƒ³ä¸­';
      startBtn.disabled = true; stopBtn.disabled = false;
    } else {
      s.className='status-indicator status-inactive'; s.innerHTML='â— åœæ­¢ä¸­';
      startBtn.disabled = false; stopBtn.disabled = true;
    }
  }
  function updateDisplays() {
    const u = document.getElementById('userDisplay');
    const t = document.getElementById('toolDisplay');
    u.textContent = currentUserUid || ''; t.textContent = currentToolUid || '';
    if (currentUserUid) { u.classList.add('completed'); } else { u.classList.remove('completed','active'); }
    if (currentToolUid) { t.classList.add('completed'); } else { t.classList.remove('completed'); currentUserUid ? t.classList.add('active') : t.classList.remove('active'); }
  }
  function showMessage(id, msg, type) {
    const el = document.getElementById(id);
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 5000);
  }

  // ä¸€è¦§
  function loadLoansData() {
    fetch('/api/loans').then(r=>r.json()).then(data=>{
      const openBody=document.querySelector('#openLoansTable tbody'); openBody.innerHTML='';
      data.open_loans.forEach(v=>{
        const tr=openBody.insertRow();
        tr.dataset.loanId = v.id;
        tr.dataset.toolUid = v.tool_uid;
        tr.dataset.toolLabel = v.tool;
        const tdTool = tr.insertCell(0); tdTool.textContent=v.tool;
        tr.insertCell(1).textContent=v.borrower;
        const d=new Date(v.loaned_at);
        tr.insertCell(2).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        const actions=tr.insertCell(3);
        actions.className='table-actions';

        const btnReturn=document.createElement('button');
        btnReturn.className='btn-table btn-manual-return';
        btnReturn.textContent='æ‰‹å‹•è¿”å´';
        btnReturn.addEventListener('click',()=>manualReturnLoan(v.id, v.tool, v.borrower));

        const btnDelete=document.createElement('button');
        btnDelete.className='btn-table btn-delete';
        btnDelete.textContent='å‰Šé™¤';
        btnDelete.addEventListener('click',()=>deleteLoanEntry(v.id, v.tool_uid, v.tool));

        actions.appendChild(btnReturn);
        actions.appendChild(btnDelete);
      });
      const histBody=document.querySelector('#historyTable tbody'); histBody.innerHTML='';
      data.history.forEach(h=>{
        const tr=histBody.insertRow(); tr.insertCell(0).textContent=h.action; tr.insertCell(1).textContent=h.tool; tr.insertCell(2).textContent=h.borrower;
        const d=new Date(h.returned_at || h.loaned_at); tr.insertCell(3).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      });
    });
  }

  async function manualReturnLoan(loanId, toolLabel, borrowerLabel){
    if(!confirm(`ã€Œ${toolLabel}ã€ã‚’æ‰‹å‹•ã§è¿”å´æ¸ˆã¿ã«ã—ã¾ã™ã€‚${borrowerLabel}ã‹ã‚‰ã®è²¸å‡ºã‚’é–‰ã˜ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    try{
      const res = await fetch(`/api/loans/${loanId}/manual_return`, {method:'POST'});
      const data = await res.json();
      if(res.ok && data.status==='success'){
        showMessage('transactionResult', data.message, 'info');
        loadLoansData();
      }else{
        showMessage('scanMessage', data.error || 'è¿”å´å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    }catch(e){
      showMessage('scanMessage', `ã‚¨ãƒ©ãƒ¼: ${e}`, 'danger');
    }
  }

  async function deleteLoanEntry(loanId, toolUid, toolLabel){
    if(!confirm(`UID ${toolUid}\nã€Œ${toolLabel}ã€ã®è²¸å‡ºè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å±¥æ­´ã«ã¯æ®‹ã‚Šã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    try{
      const res = await fetch(`/api/loans/${loanId}`, {method:'DELETE'});
      const data = await res.json();
      if(res.ok && data.status==='success'){
        showMessage('transactionResult', data.message, 'warning');
        loadLoansData();
      }else{
        showMessage('scanMessage', data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    }catch(e){
      showMessage('scanMessage', `ã‚¨ãƒ©ãƒ¼: ${e}`, 'danger');
    }
  }

  // ãƒªã‚»ãƒƒãƒˆ
  function resetState() {
    fetch('/api/reset',{method:'POST'}).then(r=>r.json()).then(()=>{
      currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage','ğŸ”„ ãƒªã‚»ãƒƒãƒˆå®Œäº†','info');
      document.getElementById('transactionResult').innerHTML='';
    });
  }

  // ç™»éŒ²ã‚¿ãƒ–ï¼šå˜ç™ºã‚¹ã‚­ãƒ£ãƒ³API
  function scanForUser() {
    showMessage('userRegResult','ã‚¹ã‚­ãƒ£ãƒ³ä¸­...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('userUidInput').value=d.uid; showMessage('userRegResult',`âœ… UID: ${d.uid}`,'success'); }
      else{ showMessage('userRegResult','âŒ èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¿ã‚°ã‚’ä¸€åº¦é›¢ã—ã¦å†ã‚¿ãƒƒãƒï¼‰','danger'); }
    });
  }
  function scanForTool() {
    showMessage('toolRegResult','ã‚¹ã‚­ãƒ£ãƒ³ä¸­...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('toolUidInput').value=d.uid; showMessage('toolRegResult',`âœ… UID: ${d.uid}`,'success'); }
      else{ showMessage('toolRegResult','âŒ èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¿ã‚°ã‚’ä¸€åº¦é›¢ã—ã¦å†ã‚¿ãƒƒãƒï¼‰','danger'); }
    });
  }

  // ç™»éŒ²/ãƒã‚¹ã‚¿
  function registerUser(){
    const uid=document.getElementById('userUidInput').value;
    const name=document.getElementById('userNameInput').value.trim();
    if(!uid||!name){ showMessage('userRegResult','âŒ UID ã¨ æ°å ã¯å¿…é ˆã§ã™','danger'); return; }
    fetch('/api/register_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('userRegResult',d.message,'success'),document.getElementById('userNameInput').value='') : showMessage('userRegResult',d.error,'danger');});
  }
  function registerTool(){
    const uid=document.getElementById('toolUidInput').value;
    const name=document.getElementById('toolNameSelect').value;
    if(!uid||!name){ showMessage('toolRegResult','âŒ UID ã¨ ã‚¢ã‚¤ãƒ†ãƒ å ã¯å¿…é ˆã§ã™','danger'); return; }
    fetch('/api/register_tool',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('toolRegResult',d.message,'success'),document.getElementById('toolUidInput').value='',document.getElementById('toolNameSelect').value='') : showMessage('toolRegResult',d.error,'danger');});
  }
  function loadToolNames(){
    fetch('/api/tool_names').then(r=>r.json()).then(d=>{
      if(!d.names) return;
      const toolSel=document.getElementById('toolNameSelect'); toolSel.innerHTML='<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; toolSel.appendChild(o); });
      const delSel=document.getElementById('deleteToolNameSelect'); delSel.innerHTML='<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; delSel.appendChild(o); });
    });
  }
  function addToolName(){
    const name=document.getElementById('newToolNameInput').value.trim();
    if(!name){ showMessage('masterResult','âŒ ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','danger'); return; }
    fetch('/api/add_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),document.getElementById('newToolNameInput').value='',loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }
  function deleteToolName(){
    const name=document.getElementById('deleteToolNameSelect').value;
    if(!name){ showMessage('masterResult','âŒ å‰Šé™¤ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ åã‚’é¸æŠã—ã¦ãã ã•ã„','danger'); return; }
    if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    fetch('/api/delete_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }

  // WebSocketå—ä¿¡ï¼šå€Ÿç”¨/è¿”å´ã‚¿ãƒ–ã®ã¨ãã ã‘ UI åæ˜ ï¼ˆæ–‡è„ˆã‚¬ãƒ¼ãƒ‰ï¼‰
  socket.on('scan_update', function(data){
    const ctx = (window.appScan && window.appScan.get && window.appScan.get())
              || (document.getElementById('operations').classList.contains('active') ? 'loan' : 'register');
    if (ctx !== 'loan') return;

    currentUserUid = data.user_uid || currentUserUid;
    currentToolUid = data.tool_uid || currentToolUid;

    const u=document.getElementById('userDisplay');
    const t=document.getElementById('toolDisplay');
    if (data.user_name) u.textContent = data.user_name;
    if (data.tool_name) t.textContent = data.tool_name;

    updateDisplays();
    if (data.message) showMessage('scanMessage', data.message, 'info');
  });
  socket.on('transaction_complete', function(data){
    document.getElementById('userDisplay').textContent = data.user_name;
    document.getElementById('toolDisplay').textContent = data.tool_name;
    showMessage('transactionResult', data.message, data.action==='borrow'?'success':'info');
    loadLoansData();
  });
  socket.on('state_reset',  function(d){ currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage',d.message,'info'); });
  socket.on('error',        function(d){ showMessage('scanMessage', d.message,'danger'); });

  // ã‚¿ã‚°æƒ…å ±ç¢ºèªï¼ˆç™»éŒ²ã‚¿ãƒ–ï¼‰
  function checkTagInfo(){
    showMessage('tagCheckResult','ã‚¿ã‚°ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...','info');
    fetch('/api/check_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){
        let type=d.type, msg=d.message, uid=d.uid, name=d.name, html='', cls='info';
        if(type==='user'){ cls='success'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>ğŸ†” UID:</strong> ${uid}<br><strong>ğŸ“ ç™»éŒ²ã‚¿ã‚¤ãƒ—:</strong> ãƒ¦ãƒ¼ã‚¶ãƒ¼<br><strong>ğŸ‘¤ æ°å:</strong> ${name}</div>`; }
        else if(type==='tool'){ cls='info'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>ğŸ†” UID:</strong> ${uid}<br><strong>ğŸ“ ç™»éŒ²ã‚¿ã‚¤ãƒ—:</strong> ã‚¢ã‚¤ãƒ†ãƒ <br><strong>ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ å:</strong> ${name}</div>`; }
        else { cls='warning'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>ğŸ†” UID:</strong> ${uid}<br><strong>ğŸ“ ç™»éŒ²çŠ¶æ³:</strong> æœªç™»éŒ²<br><em>ã“ã®ã‚¿ã‚°ã¯ã¾ã ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</em></div>`; }
        document.getElementById('tagCheckResult').innerHTML = `<div class="alert alert-${cls}">${msg}${html}</div>`;
      } else {
        showMessage('tagCheckResult','âŒ èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¿ã‚°ã‚’ä¸€åº¦é›¢ã—ã¦å†ã‚¿ãƒƒãƒï¼‰','danger');
      }
    });
  }

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function(){ loadLoansData(); loadToolNames(); });
</script>

<!-- ===== å®‰å…¨ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ï¼ˆå‹•çš„ãƒ»å³ä¸‹å›ºå®šï¼‰ ===== -->
<script>
(function(){
  if (document.getElementById('btnShutdownFixed')) return;
  const wrap=document.createElement('div');
  wrap.id='shutdownFixedWrap';
  wrap.style.cssText='position:fixed;right:16px;bottom:16px;z-index:2147483647;display:flex;flex-direction:column;align-items:flex-end;gap:6px;';
  const btn=document.createElement('button');
  btn.id='btnShutdownFixed';
  btn.textContent='å®‰å…¨ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³';
  btn.style.cssText='background:#d9534f;color:#fff;border:0;padding:10px 14px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer;font-size:14px;';
  const note=document.createElement('small');
  note.textContent='ã“ã®ç«¯æœ«ï¼ˆRaspberry Piï¼‰ä¸Šã§é–‹ã„ã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œã§ãã¾ã™';
  note.style.cssText='color:#333;background:rgba(255,255,255,.85);padding:2px 6px;border-radius:4px;text-align:right;';
  btn.addEventListener('click', async ()=>{
    if(!confirm('Raspberry Pi ã‚’å®‰å…¨ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nå‡¦ç†é–‹å§‹å¾Œã¯æ•°åç§’ã§é›»æºLEDãŒæ¶ˆç¯ã—ã¾ã™ã€‚')) return;
    try{
      const res=await fetch('/api/shutdown',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({confirm:true})});
      const j=await res.json().catch(()=>({}));
      if(res.ok && j.ok) alert('ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚LEDæ¶ˆç¯ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é›»æºã‚’æŠœã„ã¦ãã ã•ã„ã€‚');
      else alert('å¤±æ•—: '+(j.error||res.status));
    }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: '+e); }
  });
  wrap.appendChild(btn); wrap.appendChild(note); document.body.appendChild(wrap);
})();
</script>

<!-- ===== ã‚¹ã‚­ãƒ£ãƒ³åˆ¶å¾¡ï¼ˆã‚¿ãƒ–ç‹¬ç«‹é‹ç”¨ï¼‰ ===== -->
<script>
  // æ–‡è„ˆä»˜ãã‚¹ã‚­ãƒ£ãƒ³åˆ¶å¾¡ï¼ˆloan / registerï¼‰
  window.appScan = (function(){
    let active=false, ctx=null;

    async function start(newCtx){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } ctx=newCtx; active=true; await fetch('/api/start_scan',{method:'POST'}); }
      catch(_){}
    }

    async function stop(){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } }
      catch(_){}
      // UI ã‚‚åœæ­¢çŠ¶æ…‹ã«æˆ»ã™ï¼ˆèª¤è§£é˜²æ­¢ï¼‰
      active=false; ctx=null;
      try{ window.scanActive=false; if (typeof updateScanStatus==='function') updateScanStatus(false); }catch(_){}
    }

    function get(){ return ctx; }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã‚‚åœæ­¢ï¼ˆã§ãã‚‹ã ã‘é€šçŸ¥ï¼‰
    window.addEventListener('beforeunload', ()=>{
      try{
        if(navigator.sendBeacon){
          const b=new Blob([], {type:'application/json'}); navigator.sendBeacon('/api/stop_scan', b);
        } else { fetch('/api/stop_scan',{method:'POST', keepalive:true}); }
      } catch(_){}
    });

    return { start, stop, get };
  })();

  // ã‚¿ãƒ–åˆ‡æ›¿æ™‚ã¯å¿…ãšåœæ­¢ï¼ˆ.tab-button ã‚’æ¤œçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹ï¼‰
  document.addEventListener('click', (ev)=>{
    const tabLike = ev.target.closest('a[data-bs-toggle="tab"],[role="tab"],.tablinks,.tab-button,[data-tab-target],[data-tab]');
    if (tabLike) { window.appScan.stop(); }
  });
</script>
<!-- ===== /ã‚¹ã‚­ãƒ£ãƒ³åˆ¶å¾¡ ===== -->

</body>
</html>

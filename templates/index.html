<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>å·¥å…·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="/static/js/socket.io.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { width:100%; height:100%; overflow:hidden; }
    body {
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#f0f2f5; color:#333; -webkit-overflow-scrolling:touch;
    }
    .container { width:100vw; height:100vh; background:#fff; display:flex; flex-direction:column; }

    /* ã‚¿ãƒ– */
    .tabs {
      display:flex; position:sticky; top:0; z-index:100;
      background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .tab-button {
      flex:1; padding:min(10px,2vh) min(5px,1vw); background:none; border:none; cursor:pointer;
      font-size:clamp(16px,3vh,22px); font-weight:600; color:rgba(255,255,255,.85);
      border-bottom:3px solid transparent; transition:.3s; white-space:nowrap;
    }
    .tab-button.active { background:rgba(255,255,255,.2); color:#fff; border-bottom-color:#fff; }

    .tab-content { display:none; padding:10px; flex:1; overflow-y:auto; }
    .tab-content.active { display:flex; flex-direction:column; }

    /* å€Ÿç”¨/è¿”å´ */
    #operations { padding:min(10px,2vh) min(10px,2vw); }
    #operations h2 { font-size:clamp(14px,2.5vh,18px); margin:0; font-weight:600; color:#333; }

    .button-row { display:flex; gap:min(8px,1.5vw); margin-bottom:min(8px,1.5vh); }
    .btn {
      padding:min(12px,2vh) min(10px,2vw); border:none; border-radius:6px; cursor:pointer;
      font-size:clamp(36px,8vh,52px); font-weight:600; transition:.2s; flex:1; min-height:max(44px,8vh);
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .btn-primary { background:#4facfe; color:#fff; }
    .btn-primary:active { background:#3d8ed4; transform:scale(.98); }
    .btn-secondary { background:#6c757d; color:#fff; }
    .btn-danger { background:#dc3545; color:#fff; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .operation-header { display:flex; align-items:center; justify-content:space-between;
      margin-bottom:min(10px,2vh); padding-bottom:min(8px,1.5vh); border-bottom:1px solid #e9ecef; }

    .status-indicator {
      display:inline-flex; align-items:center; gap:6px;
      padding:min(3px,.5vh) min(8px,1vw); border-radius:12px; font-size:clamp(11px,1.8vh,14px); font-weight:600; transition:.3s;
    }
    .status-active { background:#d4edda; color:#155724; animation:pulse 2s infinite; }
    .status-inactive { background:#f8f9fa; color:#6c757d; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }

    .scan-progress { display:flex; gap:min(10px,2vw); margin:min(10px,2vh) 0 min(8px,1.5vh);
      background:#f8f9fa; border-radius:8px; padding:min(8px,1.5vh); }
    .scan-step { flex:1; }
    .scan-step label { display:block; font-size:clamp(11px,1.8vh,14px); color:#6c757d; margin-bottom:5px; font-weight:600; }
    .scan-display {
      background:#fff; border:2px solid #e9ecef; border-radius:5px; padding:min(6px,1vh);
      font-size:clamp(24px,4.5vh,33px); min-height:max(32px,5vh); display:flex; align-items:center;
      word-break:break-all; overflow:hidden; text-overflow:ellipsis;
    }
    .scan-display.active { border-color:#4facfe; background:#e7f5ff; }
    .scan-display.completed { border-color:#28a745; background:#d4edda; }

    .alert { padding:min(8px,1.5vh) min(12px,2vw); border-radius:5px; margin:min(8px,1.5vh) 0; font-size:clamp(12px,2vh,15px); }
    .alert-success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
    .alert-danger  { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
    .alert-info    { background:#cce7ff; border:1px solid #b8daff; color:#004085; }
    .alert-warning { background:#fff3cd; border:1px solid #ffeaa7; color:#856404; }

    .section-divider { border:none; border-top:2px solid #e9ecef; margin:min(12px,2vh) 0 min(10px,1.8vh); }
    .section-title { font-size:clamp(13px,2vh,16px); font-weight:600; color:#495057; margin-bottom:min(8px,1.5vh); display:flex; align-items:center; gap:6px; }
    .data-table { width:100%; border-collapse:collapse; background:#fff; border:1px solid #dee2e6; border-radius:5px; overflow:hidden; font-size:clamp(24px,4.5vh,33px); }
    .data-table th { background:#f8f9fa; color:#495057; padding:min(8px,1.5vh) min(5px,1vw); text-align:left; font-weight:600; border-bottom:2px solid #dee2e6; }
    .data-table td { padding:min(6px,1vh) min(5px,1vw); border-bottom:1px solid #f1f3f4; }
    .data-table tr:last-child td { border-bottom:none; }

    #registration, #master { padding:15px; overflow-y:auto; }
    #registration h2, #master h2 { font-size:18px; margin-bottom:15px; color:#333; }
    #registration h3, #master h3 { font-size:16px; margin:15px 0 10px; color:#495057; }

    .input-row { display:flex; gap:10px; margin-bottom:15px; align-items:end; }
    .input-group { flex:1; }
    .input-group label { display:block; margin-bottom:5px; font-weight:600; color:#495057; font-size:14px; }
    .form-control { width:100%; padding:10px; border:2px solid #e9ecef; border-radius:5px; font-size:14px; transition:border-color .3s; }
    .form-control:focus { outline:none; border-color:#4facfe; box-shadow:0 0 0 .2rem rgba(79,172,254,.25); }

    .scrollable-section { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; min-height:100px; }
    .bottom-tables { flex:1; display:flex; flex-direction:column; overflow:hidden; }
    .table-section { flex:1; display:flex; flex-direction:column; min-height:0; }

    @media (orientation:portrait) {
      .operation-header { flex-direction:column; align-items:flex-start; gap:6px; }
      .status-indicator { margin-left:0; align-self:flex-end; }
      .button-row { flex-wrap:wrap; }
    }
    @media (hover:none) {
      .btn:hover { transform:none; }
      .btn:active { transform:scale(.98); }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('operations')">ğŸ“² å€Ÿç”¨/è¿”å´</button>
    <button class="tab-button" onclick="showTab('registration')">ğŸ”– ã‚¿ã‚°ç™»éŒ²</button>
    <button class="tab-button" onclick="showTab('master')">ğŸ“š ãƒã‚¹ã‚¿</button>
  </div>

  <!-- å€Ÿç”¨/è¿”å´ -->
  <div id="operations" class="tab-content active">
    <div class="operation-header">
      <h2>â‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ â‘¡å·¥å…· ã®é †ã«ã‚¹ã‚­ãƒ£ãƒ³</h2>
      <span id="scanStatus" class="status-indicator status-inactive">â— åœæ­¢ä¸­</span>
    </div>

    <div class="button-row">
      <button class="btn btn-primary" id="startScanBtn" onclick="startScan()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
      <button class="btn btn-secondary" id="stopScanBtn" onclick="stopScan()" disabled>åœæ­¢</button>
      <button class="btn btn-danger" onclick="resetState()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="scan-progress">
      <div class="scan-step">
        <label>â‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
        <div id="userDisplay" class="scan-display"></div>
      </div>
      <div class="scan-step">
        <label>â‘¡å·¥å…·</label>
        <div id="toolDisplay" class="scan-display"></div>
      </div>
    </div>

    <div id="scanMessage"></div>
    <div id="transactionResult"></div>

    <hr class="section-divider">

    <div class="bottom-tables">
      <div class="table-section">
        <div class="section-title">ğŸ“‹ è²¸å‡ºä¸­</div>
        <div class="scrollable-section">
          <table class="data-table" id="openLoansTable">
            <thead><tr><th>å·¥å…·</th><th>å€Ÿç”¨è€…</th><th>å€Ÿç”¨æ—¥æ™‚</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="table-section" style="margin-top:min(10px,2vh);">
        <div class="section-title">ğŸ•’ å±¥æ­´</div>
        <div class="scrollable-section">
          <table class="data-table" id="historyTable">
            <thead><tr><th>åŒºåˆ†</th><th>å·¥å…·</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>æ—¥æ™‚</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¿ã‚°ç™»éŒ² -->
  <div id="registration" class="tab-content">
    <h2>ğŸ”– ã‚¿ã‚°ç™»éŒ²</h2>

    <div style="margin-bottom:30px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #17a2b8;">
      <h3>ğŸ” ã‚¿ã‚°æƒ…å ±ç¢ºèª</h3>
      <p style="margin-bottom:15px; color:#6c757d; font-size:14px;">NFCã‚¿ã‚°ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™</p>
      <div class="input-group" style="margin-bottom:15px;">
        <button class="btn btn-primary" onclick="checkTagInfo()" style="background:#17a2b8; border-color:#17a2b8;">ğŸ” ã‚¿ã‚°æƒ…å ±ã‚’ç¢ºèª</button>
      </div>
      <div id="tagCheckResult"></div>
    </div>

    <div style="display:flex; gap:30px; flex-wrap:wrap;">
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
      <div style="flex:1; min-width:300px;">
        <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h3>
        <div class="input-group" style="margin-bottom:15px;">
          <button class="btn btn-primary" onclick="scanForUser()">ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦UIDå–å¾—</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>UIDï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
          <input type="text" id="userUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>æ°åï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰</label>
          <input type="text" id="userNameInput" class="form-control" placeholder="å±±ç”°å¤ªéƒ">
        </div>
        <button class="btn btn-primary" onclick="registerUser()">ğŸ’¾ ç™»éŒ² / æ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</button>
        <div id="userRegResult"></div>
      </div>

      <!-- å·¥å…·ç™»éŒ² -->
      <div style="flex:1; min-width:300px;">
        <h3>ğŸ›  å·¥å…·ç™»éŒ²</h3>
        <div class="input-group" style="margin-bottom:15px;">
          <button class="btn btn-primary" onclick="scanForTool()">ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦UIDå–å¾—</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>UIDï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
          <input type="text" id="toolUidInput" class="form-control" readonly>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
          <label>å·¥å…·åï¼ˆãƒã‚¹ã‚¿ã‹ã‚‰é¸æŠï¼‰</label>
          <select id="toolNameSelect" class="form-control">
            <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="registerTool()">ğŸ’¾ ç™»éŒ² / æ›´æ–°ï¼ˆå·¥å…·ï¼‰</button>
        <div id="toolRegResult"></div>
      </div>
    </div>
  </div>

  <!-- å·¥å…·åãƒã‚¹ã‚¿ -->
  <div id="master" class="tab-content">
    <h2>ğŸ“š å·¥å…·åãƒã‚¹ã‚¿</h2>

    <div class="input-row">
      <div class="input-group">
        <label>å·¥å…·åã‚’è¿½åŠ </label>
        <input type="text" id="newToolNameInput" class="form-control" placeholder="æ–°ã—ã„å·¥å…·å">
      </div>
      <button class="btn btn-primary" onclick="addToolName()">â• è¿½åŠ </button>
    </div>

    <div id="masterResult"></div>

    <h3>ç¾åœ¨ã®å·¥å…·åä¸€è¦§</h3>
    <div class="input-row">
      <div class="input-group">
        <label>å‰Šé™¤ã™ã‚‹å·¥å…·åã‚’é¸æŠ</label>
        <select id="deleteToolNameSelect" class="form-control">
          <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
        </select>
      </div>
      <button class="btn btn-danger" onclick="deleteToolName()">ğŸ—‘ï¸ å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- ===== ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¿ãƒ–ç‹¬ç«‹é‹ç”¨ & UIåŒæœŸï¼‰ ===== -->
<script>
  // WebSocket
  const socket = io();

  // çŠ¶æ…‹
  let scanActive = false;
  let currentUserUid = '';
  let currentToolUid = '';

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆå€Ÿç”¨/è¿”å´ä»¥å¤–ã«ç§»å‹•ã—ãŸã‚‰ UI ã‚’åœæ­¢çŠ¶æ…‹ã«æˆ»ã™ï¼‰
  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');

    // å€Ÿç”¨/è¿”å´ã‚¿ãƒ–ä»¥å¤–ã«ç§»å‹•ã—ãŸã‚‰è¦‹ãŸç›®ã‚‚åœæ­¢çŠ¶æ…‹ã¸ï¼ˆèª¤è§£é˜²æ­¢ï¼‰
    if (tabName !== 'operations') {
      scanActive = false;
      if (typeof updateScanStatus === 'function') updateScanStatus(false);
    }

    if (tabName === 'registration' || tabName === 'master') loadToolNames();
    if (tabName === 'operations')   loadLoansData();
  }

  // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹/åœæ­¢ï¼šappScan ãƒ©ãƒƒãƒ‘çµŒç”±ï¼ˆloan æ–‡è„ˆï¼‰
  function startScan() {
    appScan.start('loan')
      .then(() => { scanActive = true;  updateScanStatus(true);  showMessage('scanMessage','ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ','info'); })
      .catch(()  => { showMessage('scanMessage','ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ','danger'); });
  }
  function stopScan() {
    appScan.stop()
      .then(() => { scanActive = false; updateScanStatus(false); showMessage('scanMessage','ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ','warning'); })
      .catch(()=>{});
  }

  // è¡¨ç¤ºæ›´æ–°
  function updateScanStatus(active) {
    const s = document.getElementById('scanStatus');
    const startBtn = document.getElementById('startScanBtn');
    const stopBtn  = document.getElementById('stopScanBtn');
    if (active) {
      s.className='status-indicator status-active'; s.innerHTML='ã‚¹ã‚­ãƒ£ãƒ³ä¸­';
      startBtn.disabled = true; stopBtn.disabled = false;
    } else {
      s.className='status-indicator status-inactive'; s.innerHTML='â— åœæ­¢ä¸­';
      startBtn.disabled = false; stopBtn.disabled = true;
    }
  }
  function updateDisplays() {
    const u = document.getElementById('userDisplay');
    const t = document.getElementById('toolDisplay');
    u.textContent = currentUserUid || ''; t.textContent = currentToolUid || '';
    if (currentUserUid) { u.classList.add('completed'); } else { u.classList.remove('completed','active'); }
    if (currentToolUid) { t.classList.add('completed'); } else { t.classList.remove('completed'); currentUserUid ? t.classList.add('active') : t.classList.remove('active'); }
  }
  function showMessage(id, msg, type) {
    const el = document.getElementById(id);
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 5000);
  }

  // ä¸€è¦§
  function loadLoansData() {
    fetch('/api/loans').then(r=>r.json()).then(data=>{
      const openBody=document.querySelector('#openLoansTable tbody'); openBody.innerHTML='';
      data.open_loans.forEach(v=>{
        const tr=openBody.insertRow(); tr.insertCell(0).textContent=v.tool; tr.insertCell(1).textContent=v.borrower;
        const d=new Date(v.loaned_at); tr.insertCell(2).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      });
      const histBody=document.querySelector('#historyTable tbody'); histBody.innerHTML='';
      data.history.forEach(h=>{
        const tr=histBody.insertRow(); tr.insertCell(0).textContent=h.action; tr.insertCell(1).textContent=h.tool; tr.insertCell(2).textContent=h.borrower;
        const d=new Date(h.returned_at || h.loaned_at); tr.insertCell(3).textContent=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      });
    });
  }

  // ãƒªã‚»ãƒƒãƒˆ
  function resetState() {
    fetch('/api/reset',{method:'POST'}).then(r=>r.json()).then(()=>{
      currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage','ğŸ”„ ãƒªã‚»ãƒƒãƒˆå®Œäº†','info');
      document.getElementById('transactionResult').innerHTML='';
    });
  }

  // ç™»éŒ²ã‚¿ãƒ–ï¼šå˜ç™ºã‚¹ã‚­ãƒ£ãƒ³API
  function scanForUser() {
    showMessage('userRegResult','ã‚¹ã‚­ãƒ£ãƒ³ä¸­...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('userUidInput').value=d.uid; showMessage('userRegResult',`âœ… UID: ${d.uid}`,'success'); }
      else{ showMessage('userRegResult','âŒ èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¿ã‚°ã‚’ä¸€åº¦é›¢ã—ã¦å†ã‚¿ãƒƒãƒï¼‰','danger'); }
    });
  }
  function scanForTool() {
    showMessage('toolRegResult','ã‚¹ã‚­ãƒ£ãƒ³ä¸­...','info');
    fetch('/api/scan_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){ document.getElementById('toolUidInput').value=d.uid; showMessage('toolRegResult',`âœ… UID: ${d.uid}`,'success'); }
      else{ showMessage('toolRegResult','âŒ èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¿ã‚°ã‚’ä¸€åº¦é›¢ã—ã¦å†ã‚¿ãƒƒãƒï¼‰','danger'); }
    });
  }

  // ç™»éŒ²/ãƒã‚¹ã‚¿
  function registerUser(){
    const uid=document.getElementById('userUidInput').value;
    const name=document.getElementById('userNameInput').value.trim();
    if(!uid||!name){ showMessage('userRegResult','âŒ UID ã¨ æ°å ã¯å¿…é ˆã§ã™','danger'); return; }
    fetch('/api/register_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('userRegResult',d.message,'success'),document.getElementById('userNameInput').value='') : showMessage('userRegResult',d.error,'danger');});
  }
  function registerTool(){
    const uid=document.getElementById('toolUidInput').value;
    const name=document.getElementById('toolNameSelect').value;
    if(!uid||!name){ showMessage('toolRegResult','âŒ UID ã¨ å·¥å…·å ã¯å¿…é ˆã§ã™','danger'); return; }
    fetch('/api/register_tool',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid,name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('toolRegResult',d.message,'success'),document.getElementById('toolUidInput').value='',document.getElementById('toolNameSelect').value='') : showMessage('toolRegResult',d.error,'danger');});
  }
  function loadToolNames(){
    fetch('/api/tool_names').then(r=>r.json()).then(d=>{
      if(!d.names) return;
      const toolSel=document.getElementById('toolNameSelect'); toolSel.innerHTML='<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; toolSel.appendChild(o); });
      const delSel=document.getElementById('deleteToolNameSelect'); delSel.innerHTML='<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
      d.names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; delSel.appendChild(o); });
    });
  }
  function addToolName(){
    const name=document.getElementById('newToolNameInput').value.trim();
    if(!name){ showMessage('masterResult','âŒ å·¥å…·åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','danger'); return; }
    fetch('/api/add_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),document.getElementById('newToolNameInput').value='',loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }
  function deleteToolName(){
    const name=document.getElementById('deleteToolNameSelect').value;
    if(!name){ showMessage('masterResult','âŒ å‰Šé™¤ã™ã‚‹å·¥å…·åã‚’é¸æŠã—ã¦ãã ã•ã„','danger'); return; }
    if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    fetch('/api/delete_tool_name',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
      .then(r=>r.json()).then(d=>{ d.status==='success'? (showMessage('masterResult',d.message,'success'),loadToolNames()) : showMessage('masterResult',d.error,'danger');});
  }

  // WebSocketå—ä¿¡ï¼šå€Ÿç”¨/è¿”å´ã‚¿ãƒ–ã®ã¨ãã ã‘ UI åæ˜ ï¼ˆæ–‡è„ˆã‚¬ãƒ¼ãƒ‰ï¼‰
  socket.on('scan_update', function(data){
    const ctx = (window.appScan && window.appScan.get && window.appScan.get())
              || (document.getElementById('operations').classList.contains('active') ? 'loan' : 'register');
    if (ctx !== 'loan') return;

    currentUserUid = data.user_uid || currentUserUid;
    currentToolUid = data.tool_uid || currentToolUid;

    const u=document.getElementById('userDisplay');
    const t=document.getElementById('toolDisplay');
    if (data.user_name) u.textContent = data.user_name;
    if (data.tool_name) t.textContent = data.tool_name;

    updateDisplays();
    if (data.message) showMessage('scanMessage', data.message, 'info');
  });
  socket.on('transaction_complete', function(data){
    document.getElementById('userDisplay').textContent = data.user_name;
    document.getElementById('toolDisplay').textContent = data.tool_name;
    showMessage('transactionResult', data.message, data.action==='borrow'?'success':'info');
    loadLoansData();
  });
  socket.on('state_reset',  function(d){ currentUserUid=''; currentToolUid=''; updateDisplays(); showMessage('scanMessage',d.message,'info'); });
  socket.on('error',        function(d){ showMessage('scanMessage', d.message,'danger'); });

  // ã‚¿ã‚°æƒ…å ±ç¢ºèªï¼ˆç™»éŒ²ã‚¿ãƒ–ï¼‰
  function checkTagInfo(){
    showMessage('tagCheckResult','ã‚¿ã‚°ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...','info');
    fetch('/api/check_tag',{method:'POST'}).then(r=>r.json()).then(d=>{
      if(d.status==='success'){
        let type=d.type, msg=d.message, uid=d.uid, name=d.name, html='', cls='info';
        if(type==='user'){ cls='success'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>ğŸ†” UID:</strong> ${uid}<br><strong>ğŸ“ ç™»éŒ²ã‚¿ã‚¤ãƒ—:</strong> ãƒ¦ãƒ¼ã‚¶ãƒ¼<br><strong>ğŸ‘¤ æ°å:</strong> ${name}</div>`; }
        else if(type==='tool'){ cls='info'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>ğŸ†” UID:</strong> ${uid}<br><strong>ğŸ“ ç™»éŒ²ã‚¿ã‚¤ãƒ—:</strong> å·¥å…·<br><strong>ğŸ› ï¸ å·¥å…·å:</strong> ${name}</div>`; }
        else { cls='warning'; html=`<div style="padding:10px;background:#fff;border-radius:5px;margin-top:10px;">
          <strong>ğŸ†” UID:</strong> ${uid}<br><strong>ğŸ“ ç™»éŒ²çŠ¶æ³:</strong> æœªç™»éŒ²<br><em>ã“ã®ã‚¿ã‚°ã¯ã¾ã ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯å·¥å…·ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</em></div>`; }
        document.getElementById('tagCheckResult').innerHTML = `<div class="alert alert-${cls}">${msg}${html}</div>`;
      } else {
        showMessage('tagCheckResult','âŒ èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¿ã‚°ã‚’ä¸€åº¦é›¢ã—ã¦å†ã‚¿ãƒƒãƒï¼‰','danger');
      }
    });
  }

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function(){ loadLoansData(); loadToolNames(); });
</script>

<!-- ===== å®‰å…¨ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ï¼ˆå‹•çš„ãƒ»å³ä¸‹å›ºå®šï¼‰ ===== -->
<script>
(function(){
  if (document.getElementById('btnShutdownFixed')) return;
  const wrap=document.createElement('div');
  wrap.id='shutdownFixedWrap';
  wrap.style.cssText='position:fixed;right:16px;bottom:16px;z-index:2147483647;display:flex;flex-direction:column;align-items:flex-end;gap:6px;';
  const btn=document.createElement('button');
  btn.id='btnShutdownFixed';
  btn.textContent='å®‰å…¨ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³';
  btn.style.cssText='background:#d9534f;color:#fff;border:0;padding:10px 14px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer;font-size:14px;';
  const note=document.createElement('small');
  note.textContent='ã“ã®ç«¯æœ«ï¼ˆRaspberry Piï¼‰ä¸Šã§é–‹ã„ã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œã§ãã¾ã™';
  note.style.cssText='color:#333;background:rgba(255,255,255,.85);padding:2px 6px;border-radius:4px;text-align:right;';
  btn.addEventListener('click', async ()=>{
    if(!confirm('Raspberry Pi ã‚’å®‰å…¨ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nå‡¦ç†é–‹å§‹å¾Œã¯æ•°åç§’ã§é›»æºLEDãŒæ¶ˆç¯ã—ã¾ã™ã€‚')) return;
    try{
      const res=await fetch('/api/shutdown',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({confirm:true})});
      const j=await res.json().catch(()=>({}));
      if(res.ok && j.ok) alert('ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚LEDæ¶ˆç¯ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é›»æºã‚’æŠœã„ã¦ãã ã•ã„ã€‚');
      else alert('å¤±æ•—: '+(j.error||res.status));
    }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: '+e); }
  });
  wrap.appendChild(btn); wrap.appendChild(note); document.body.appendChild(wrap);
})();
</script>

<!-- ===== ã‚¹ã‚­ãƒ£ãƒ³åˆ¶å¾¡ï¼ˆã‚¿ãƒ–ç‹¬ç«‹é‹ç”¨ï¼‰ ===== -->
<script>
  // æ–‡è„ˆä»˜ãã‚¹ã‚­ãƒ£ãƒ³åˆ¶å¾¡ï¼ˆloan / registerï¼‰
  window.appScan = (function(){
    let active=false, ctx=null;

    async function start(newCtx){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } ctx=newCtx; active=true; await fetch('/api/start_scan',{method:'POST'}); }
      catch(_){}
    }

    async function stop(){
      try{ if(active){ await fetch('/api/stop_scan',{method:'POST'}); } }
      catch(_){}
      // UI ã‚‚åœæ­¢çŠ¶æ…‹ã«æˆ»ã™ï¼ˆèª¤è§£é˜²æ­¢ï¼‰
      active=false; ctx=null;
      try{ window.scanActive=false; if (typeof updateScanStatus==='function') updateScanStatus(false); }catch(_){}
    }

    function get(){ return ctx; }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã‚‚åœæ­¢ï¼ˆã§ãã‚‹ã ã‘é€šçŸ¥ï¼‰
    window.addEventListener('beforeunload', ()=>{
      try{
        if(navigator.sendBeacon){
          const b=new Blob([], {type:'application/json'}); navigator.sendBeacon('/api/stop_scan', b);
        } else { fetch('/api/stop_scan',{method:'POST', keepalive:true}); }
      } catch(_){}
    });

    return { start, stop, get };
  })();

  // ã‚¿ãƒ–åˆ‡æ›¿æ™‚ã¯å¿…ãšåœæ­¢ï¼ˆ.tab-button ã‚’æ¤œçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹ï¼‰
  document.addEventListener('click', (ev)=>{
    const tabLike = ev.target.closest('a[data-bs-toggle="tab"],[role="tab"],.tablinks,.tab-button,[data-tab-target],[data-tab]');
    if (tabLike) { window.appScan.stop(); }
  });
</script>
<!-- ===== /ã‚¹ã‚­ãƒ£ãƒ³åˆ¶å¾¡ ===== -->

</body>
</html>
